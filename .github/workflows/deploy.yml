name: Deploy to Production

on:
  push:
    branches:
      - main
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore dependencies
      run: dotnet restore src/Nobetci.Web/Nobetci.Web.csproj
    
    - name: Build
      run: dotnet build src/Nobetci.Web/Nobetci.Web.csproj --configuration Release --no-restore
    
    - name: Publish
      run: dotnet publish src/Nobetci.Web/Nobetci.Web.csproj --configuration Release --output ./publish --no-build
    
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Stop the service
          systemctl stop geldimmi || true
          
          # Create app directory if not exists
          mkdir -p /var/www/geldimmi
          
          # Clean old files
          rm -rf /var/www/geldimmi/*
    
    - name: Copy files to Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "./publish/*"
        target: "/var/www/geldimmi"
        strip_components: 1
    
    - name: Configure and Start Service
      uses: appleboy/ssh-action@v1.0.3
      env:
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
        RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Create appsettings.Production.json with secrets
          cat > /var/www/geldimmi/appsettings.Production.json << EOF
          {
            "Logging": {
              "LogLevel": {
                "Default": "Warning",
                "Microsoft.AspNetCore": "Warning",
                "Microsoft.EntityFrameworkCore": "Warning"
              }
            },
            "AllowedHosts": "geldimmi.com;www.geldimmi.com",
            "ConnectionStrings": {
              "DefaultConnection": "Host=142.93.32.204;Port=5432;Database=nobetci;Username=nobetci;Password=NobetciApp2026!Secure"
            },
            "AppSettings": {
              "GuestEmployeeLimit": 5,
              "RegisteredEmployeeLimit": 10,
              "PremiumEmployeeLimit": 100,
              "DefaultLanguage": "tr",
              "SupportedLanguages": ["tr", "en"]
            },
            "AdminSettings": {
              "Username": "Geldimmix",
              "Password": "Liberemall423445"
            },
            "Google": {
              "ClientId": "${{ secrets.GOOGLE_CLIENT_ID }}",
              "ClientSecret": "${{ secrets.GOOGLE_CLIENT_SECRET }}"
            },
            "ReCaptcha": {
              "SiteKey": "${{ secrets.RECAPTCHA_SITE_KEY }}",
              "SecretKey": "${{ secrets.RECAPTCHA_SECRET_KEY }}"
            }
          }
          EOF
          
          # Create systemd service if not exists
          cat > /etc/systemd/system/geldimmi.service << 'EOF'
          [Unit]
          Description=Geldimmi Web Application
          After=network.target
          
          [Service]
          WorkingDirectory=/var/www/geldimmi
          ExecStart=/usr/bin/dotnet /var/www/geldimmi/Nobetci.Web.dll
          Restart=always
          RestartSec=10
          KillSignal=SIGINT
          SyslogIdentifier=geldimmi
          User=www-data
          Environment=ASPNETCORE_ENVIRONMENT=Production
          Environment=ASPNETCORE_URLS=http://localhost:5000
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Set permissions
          chown -R www-data:www-data /var/www/geldimmi
          chmod -R 755 /var/www/geldimmi
          
          # Reload systemd and start service
          systemctl daemon-reload
          systemctl enable geldimmi
          systemctl start geldimmi
          
          # Check status
          systemctl status geldimmi --no-pager || true

