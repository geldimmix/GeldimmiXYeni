@model AttendanceViewModel
@{
    var isTurkish = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "tr";
    ViewData["Title"] = isTurkish ? "Mesai Takip" : "Attendance";
    Layout = "_AppLayout";
    
    var dayNames = isTurkish 
        ? new[] { "Paz", "Pzt", "Sal", "√áar", "Per", "Cum", "Cmt" }
        : new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
}

<style>
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --surface: #ffffff;
        --surface-2: #f8fafc;
        --border: #e2e8f0;
        --text: #1e293b;
        --text-muted: #64748b;
    }

    .att-page {
        min-height: calc(100vh - 60px);
        background: linear-gradient(135deg, #f0f4ff 0%, #faf5ff 50%, #fff1f2 100%);
        padding: 24px;
    }

    /* Header */
    .att-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .att-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .att-title-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .att-title h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin: 0;
    }

    .att-title p {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 2px 0 0 0;
    }

    .att-nav {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .month-picker {
        display: flex;
        align-items: center;
        gap: 4px;
        background: var(--surface);
        padding: 6px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .month-picker a {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        color: var(--text-muted);
        text-decoration: none;
        transition: all 0.2s;
    }

    .month-picker a:hover {
        background: var(--surface-2);
        color: var(--primary);
    }

    .month-picker .month-text {
        min-width: 140px;
        text-align: center;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        background: var(--surface);
        color: var(--text);
        border-radius: 10px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transition: all 0.2s;
    }

    .btn-back:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    /* Table Card */
    .att-card {
        background: var(--surface);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        overflow: hidden;
    }

    .att-scroll {
        overflow-x: auto;
    }

    .att-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.8rem;
    }

    .att-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .att-table th {
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 14px 10px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border);
    }

    .att-table th.emp-col {
        position: sticky;
        left: 0;
        z-index: 20;
        min-width: 160px;
        text-align: left;
        background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    }

    .att-table th.day-col {
        min-width: 72px;
        text-align: center;
    }

    .day-col-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .day-num {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text);
    }

    .day-name {
        font-size: 0.6rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .day-col.weekend .day-num { color: var(--danger); }
    .day-col.weekend { background: #fef2f2 !important; }
    .day-col.holiday { background: #fffbeb !important; }
    .day-col.holiday .day-num { color: var(--warning); }

    .att-table td {
        padding: 0;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .att-table td.emp-cell {
        position: sticky;
        left: 0;
        background: var(--surface);
        z-index: 5;
        padding: 12px 16px;
        border-right: 1px solid var(--border);
    }

    .att-table tr:hover td.emp-cell {
        background: #fafaff;
    }

    .emp-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .emp-avatar {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--primary);
        font-size: 0.85rem;
    }

    .emp-details .emp-name {
        font-weight: 600;
        color: var(--text);
        font-size: 0.85rem;
    }

    .emp-details .emp-role {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    /* Cells */
    .att-cell {
        min-width: 72px;
        height: 64px;
        cursor: pointer;
        transition: all 0.15s;
        position: relative;
    }

    .att-cell:hover {
        background: #f0f4ff !important;
    }

    .att-cell.weekend { background: #fef2f2; }
    .att-cell.holiday { background: #fffbeb; }
    .att-cell.filled { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
    .att-cell.filled:hover { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important; }

    .cell-inner {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 6px;
        gap: 3px;
    }

    .time-tag {
        font-size: 0.65rem;
        padding: 3px 6px;
        border-radius: 6px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 3px;
    }

    .time-tag.in {
        background: #dcfce7;
        color: #166534;
    }

    .time-tag.out {
        background: #fce7f3;
        color: #9d174d;
    }

    .hours-tag {
        font-size: 0.6rem;
        font-weight: 700;
        color: var(--primary);
        background: #e0e7ff;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .shift-hint {
        font-size: 0.55rem;
        color: var(--text-muted);
        opacity: 0.7;
    }

    .add-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: #f1f5f9;
        color: #94a3b8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 300;
        transition: all 0.2s;
    }

    .att-cell:hover .add-icon {
        background: var(--primary);
        color: white;
        transform: scale(1.1);
    }

    /* Summary Column */
    .summary-cell {
        text-align: center;
        padding: 12px !important;
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .summary-hours {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary);
    }

    .summary-days {
        font-size: 0.65rem;
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-box {
        text-align: center;
        padding: 80px 24px;
        background: var(--surface);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    .empty-box-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        filter: grayscale(0.5);
    }

    .empty-box h3 {
        color: var(--text);
        margin-bottom: 8px;
        font-size: 1.2rem;
    }

    .empty-box p {
        color: var(--text-muted);
        margin-bottom: 24px;
    }

    /* Modern Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .modal-box {
        background: var(--surface);
        border-radius: 24px;
        width: 100%;
        max-width: 420px;
        transform: scale(0.95) translateY(10px);
        transition: transform 0.25s ease;
        overflow: hidden;
    }

    .modal-overlay.active .modal-box {
        transform: scale(1) translateY(0);
    }

    .modal-top {
        background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        padding: 24px;
        color: white;
        position: relative;
    }

    .modal-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: background 0.2s;
    }

    .modal-close-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .modal-employee {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .modal-date {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .modal-form {
        padding: 24px;
    }

    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-group:last-child {
        margin-bottom: 0;
    }

    .input-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .input-label svg {
        width: 14px;
        height: 14px;
    }

    .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 0.95rem;
        color: var(--text);
        background: var(--surface);
        transition: all 0.2s;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .checkbox-field {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: var(--surface-2);
        border-radius: 12px;
        cursor: pointer;
    }

    .checkbox-field input {
        width: 20px;
        height: 20px;
        accent-color: var(--primary);
    }

    .checkbox-field span {
        font-size: 0.85rem;
        color: var(--text);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        background: var(--surface-2);
        border-top: 1px solid var(--border);
    }

    .btn-modal {
        flex: 1;
        padding: 14px 20px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-cancel {
        background: var(--surface);
        color: var(--text);
        border: 2px solid var(--border);
    }

    .btn-cancel:hover {
        background: var(--surface-2);
    }

    .btn-save {
        background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }

    .btn-delete {
        background: #fef2f2;
        color: var(--danger);
        flex: 0 0 auto;
        padding: 14px;
    }

    .btn-delete:hover {
        background: #fee2e2;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .att-page { padding: 16px; }
        .att-header { flex-direction: column; align-items: stretch; }
        .att-nav { justify-content: space-between; }
        .modal-box { max-width: 100%; border-radius: 20px 20px 0 0; }
        .modal-overlay { align-items: flex-end; padding: 0; }
    }
</style>

<div class="att-page">
    <!-- Header -->
    <div class="att-header">
        <div class="att-title">
            <div class="att-title-icon">üïê</div>
            <div>
                <h1>@(isTurkish ? "Mesai Takip" : "Attendance")</h1>
                <p>@(isTurkish ? "Giri≈ü ve √ßƒ±kƒ±≈ü saatlerini takip edin" : "Track check-in and check-out times")</p>
            </div>
        </div>
        
        <div class="att-nav">
            <div class="month-picker">
                <a href="@Url.Action("Attendance", new { year = Model.SelectedMonth == 1 ? Model.SelectedYear - 1 : Model.SelectedYear, month = Model.SelectedMonth == 1 ? 12 : Model.SelectedMonth - 1 })">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                </a>
                <span class="month-text">@Model.MonthName</span>
                <a href="@Url.Action("Attendance", new { year = Model.SelectedMonth == 12 ? Model.SelectedYear + 1 : Model.SelectedYear, month = Model.SelectedMonth == 12 ? 1 : Model.SelectedMonth + 1 })">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </a>
            </div>
            
            <a href="@Url.Action("Index", new { year = Model.SelectedYear, month = Model.SelectedMonth })" class="btn-back">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                @(isTurkish ? "Takvim" : "Calendar")
            </a>
        </div>
    </div>

    @if (Model.Employees.Any())
    {
        <div class="att-card">
            <div class="att-scroll">
                <table class="att-table">
                    <thead>
                        <tr>
                            <th class="emp-col">@(isTurkish ? "Personel" : "Employee")</th>
                            @for (int day = 1; day <= Model.DaysInMonth; day++)
                            {
                                var date = new DateOnly(Model.SelectedYear, Model.SelectedMonth, day);
                                var isWeekend = Model.IsWeekend(date);
                                var isHoliday = Model.IsHoliday(date);
                                var colClass = "day-col" + (isHoliday ? " holiday" : (isWeekend ? " weekend" : ""));
                                <th class="@colClass">
                                    <div class="day-col-inner">
                                        <span class="day-num">@day</span>
                                        <span class="day-name">@dayNames[(int)date.DayOfWeek]</span>
                                    </div>
                                </th>
                            }
                            <th style="min-width:80px; text-align:center;">@(isTurkish ? "Toplam" : "Total")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var employee in Model.Employees)
                        {
                            var totalWorked = Model.Attendances
                                .Where(a => a.EmployeeId == employee.Id && a.WorkedHours.HasValue)
                                .Sum(a => a.WorkedHours ?? 0);
                            var daysWorked = Model.Attendances
                                .Count(a => a.EmployeeId == employee.Id && a.CheckInTime.HasValue);
                            var initials = string.Join("", employee.FullName.Split(' ').Take(2).Select(n => n.FirstOrDefault()));
                            
                            <tr>
                                <td class="emp-cell">
                                    <div class="emp-info">
                                        <div class="emp-avatar">@initials</div>
                                        <div class="emp-details">
                                            <div class="emp-name">@employee.FullName</div>
                                            @if (!string.IsNullOrEmpty(employee.Title))
                                            {
                                                <div class="emp-role">@employee.Title</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                @for (int day = 1; day <= Model.DaysInMonth; day++)
                                {
                                    var date = new DateOnly(Model.SelectedYear, Model.SelectedMonth, day);
                                    var attendance = Model.GetAttendance(employee.Id, date);
                                    var shift = Model.GetShift(employee.Id, date);
                                    var isWeekend = Model.IsWeekend(date);
                                    var isHoliday = Model.IsHoliday(date);
                                    var hasData = attendance?.CheckInTime != null || attendance?.CheckOutTime != null;
                                    
                                    var cellClass = "att-cell";
                                    if (isHoliday) cellClass += " holiday";
                                    else if (isWeekend) cellClass += " weekend";
                                    if (hasData) cellClass += " filled";
                                    
                                    <td class="@cellClass" 
                                        onclick="openModal(@employee.Id, '@employee.FullName.Replace("'", "\\'")', '@date.ToString("yyyy-MM-dd")', @(attendance?.Id ?? 0), '@(attendance?.CheckInTime?.ToString("HH:mm") ?? "")', '@(attendance?.CheckOutTime?.ToString("HH:mm") ?? "")', @(attendance?.CheckOutToNextDay.ToString().ToLower() ?? "false"), '@(attendance?.Notes?.Replace("'", "\\'") ?? "")')">
                                        <div class="cell-inner">
                                            @if (attendance?.CheckInTime != null)
                                            {
                                                <span class="time-tag in">‚Üì @attendance.CheckInTime.Value.ToString("HH:mm")</span>
                                            }
                                            @if (attendance?.CheckOutTime != null)
                                            {
                                                <span class="time-tag out">‚Üë @attendance.CheckOutTime.Value.ToString("HH:mm")</span>
                                            }
                                            @if (attendance?.WorkedHours > 0)
                                            {
                                                <span class="hours-tag">@attendance.WorkedHours.Value.ToString("0.#")s</span>
                                            }
                                            @if (shift != null && !shift.IsDayOff && attendance == null)
                                            {
                                                <span class="shift-hint">@shift.StartTime.ToString("HH:mm")-@shift.EndTime.ToString("HH:mm")</span>
                                            }
                                            @if (attendance == null && shift == null)
                                            {
                                                <span class="add-icon">+</span>
                                            }
                                        </div>
                                    </td>
                                }
                                <td class="summary-cell">
                                    <div class="summary-hours">@totalWorked.ToString("0.#")s</div>
                                    <div class="summary-days">@daysWorked @(isTurkish ? "g√ºn" : "days")</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="empty-box">
            <div class="empty-box-icon">üë§</div>
            <h3>@(isTurkish ? "Hen√ºz personel yok" : "No employees yet")</h3>
            <p>@(isTurkish ? "Mesai takibi i√ßin √∂nce personel ekleyin." : "Add employees first to track attendance.")</p>
            <a href="@Url.Action("Index")" class="btn-save" style="display:inline-flex; padding: 12px 24px;">
                @(isTurkish ? "Takvime Git" : "Go to Calendar")
            </a>
        </div>
    }
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-top">
            <button class="modal-close-btn" onclick="closeModal()">‚úï</button>
            <div class="modal-employee" id="modalEmployee"></div>
            <div class="modal-date" id="modalDate"></div>
        </div>
        
        <div class="modal-form">
            <input type="hidden" id="attId">
            <input type="hidden" id="empId">
            <input type="hidden" id="attDate">
            
            <div class="input-row">
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
                        @(isTurkish ? "Giri≈ü" : "Check In")
                    </label>
                    <input type="time" class="input-field" id="timeIn">
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label class="input-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
                        @(isTurkish ? "√áƒ±kƒ±≈ü" : "Check Out")
                    </label>
                    <input type="time" class="input-field" id="timeOut">
                </div>
            </div>
            
            <div class="input-group">
                <label class="checkbox-field">
                    <input type="checkbox" id="nextDay">
                    <span>@(isTurkish ? "√áƒ±kƒ±≈ü ertesi g√ºne sarkar (gece vardiyasƒ±)" : "Check out spans to next day")</span>
                </label>
            </div>
            
            <div class="input-group">
                <label class="input-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                    @(isTurkish ? "Not" : "Notes")
                </label>
                <textarea class="input-field" id="notes" rows="2" placeholder="@(isTurkish ? "ƒ∞steƒüe baƒülƒ± not..." : "Optional notes...")"></textarea>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn-modal btn-delete" id="deleteBtn" onclick="deleteRecord()" style="display:none;" title="@(isTurkish ? "Sil" : "Delete")">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
            <button class="btn-modal btn-cancel" onclick="closeModal()">@(isTurkish ? "ƒ∞ptal" : "Cancel")</button>
            <button class="btn-modal btn-save" onclick="saveRecord()">@(isTurkish ? "Kaydet" : "Save")</button>
        </div>
    </div>
</div>

<script>
    function openModal(empId, empName, date, attId, timeIn, timeOut, nextDay, notes) {
        document.getElementById('empId').value = empId;
        document.getElementById('attDate').value = date;
        document.getElementById('attId').value = attId || 0;
        document.getElementById('timeIn').value = timeIn || '';
        document.getElementById('timeOut').value = timeOut || '';
        document.getElementById('nextDay').checked = nextDay;
        document.getElementById('notes').value = notes || '';
        
        document.getElementById('modalEmployee').textContent = empName;
        document.getElementById('modalDate').textContent = new Date(date).toLocaleDateString('@(isTurkish ? "tr-TR" : "en-US")', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        document.getElementById('deleteBtn').style.display = attId > 0 ? 'flex' : 'none';
        
        document.getElementById('modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    async function saveRecord() {
        const data = {
            employeeId: parseInt(document.getElementById('empId').value),
            date: document.getElementById('attDate').value,
            checkInTime: document.getElementById('timeIn').value || null,
            checkOutTime: document.getElementById('timeOut').value || null,
            checkOutToNextDay: document.getElementById('nextDay').checked,
            notes: document.getElementById('notes').value || null,
            type: 0
        };

        try {
            const res = await fetch('/api/attendance/manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
                closeModal();
                location.reload();
            } else {
                alert(result.error || '@(isTurkish ? "Hata olu≈ütu" : "Error occurred")');
            }
        } catch (e) {
            alert('@(isTurkish ? "Baƒülantƒ± hatasƒ±" : "Connection error")');
        }
    }

    async function deleteRecord() {
        const id = document.getElementById('attId').value;
        if (!id || id === '0') return;
        if (!confirm('@(isTurkish ? "Bu kaydƒ± silmek istediƒüinizden emin misiniz?" : "Delete this record?")')) return;

        try {
            const res = await fetch('/api/attendance/' + id, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                closeModal();
                location.reload();
            }
        } catch (e) {
            alert('@(isTurkish ? "Hata" : "Error")');
        }
    }

    document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
