@model PayrollViewModel
@{
    var currentLang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    ViewData["Title"] = Localizer["Payroll"];
    Layout = "_AppLayout";
    
    var dayNames = new[] {
        Localizer["Paz"].Value,
        Localizer["Pzt"].Value,
        Localizer["Sal"].Value,
        Localizer["Car"].Value,
        Localizer["Per"].Value,
        Localizer["Cum"].Value,
        Localizer["Cmt"].Value
    };
}

<style>
    /* Override body overflow for this page */
    body {
        overflow-y: auto !important;
    }
    
    .payroll-page {
        min-height: calc(100vh - 60px);
        background: #f5f7fa;
        padding: 20px;
        padding-bottom: 100px;
    }

    .payroll-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .payroll-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1a1a2e;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .month-picker {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }

    .month-picker a {
        padding: 8px 12px;
        color: #666;
        text-decoration: none;
    }

    .month-picker a:hover { background: #f5f5f5; }

    .month-picker .month-text {
        padding: 8px 16px;
        font-weight: 600;
        color: #1a1a2e;
        min-width: 130px;
        text-align: center;
        border-left: 1px solid #ddd;
        border-right: 1px solid #ddd;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.15s;
        text-decoration: none;
    }

    .btn-outline {
        background: #fff;
        color: #333;
        border: 1px solid #ddd;
    }

    .btn-outline:hover { background: #f5f5f5; }

    .btn-primary {
        background: #3b82f6;
        color: #fff;
    }

    .btn-primary:hover { background: #2563eb; }

    .btn-success {
        background: #22c55e;
        color: #fff;
    }

    .btn-success:hover { background: #16a34a; }

    /* Settings Card */
    .settings-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 20px;
    }

    .settings-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .setting-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .setting-group label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
    }

    .setting-group select, .setting-group input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.85rem;
        min-width: 100px;
    }

    .setting-group select:focus, .setting-group input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Saved Payrolls */
    .saved-list {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .saved-list-header {
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 600;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .saved-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .saved-item:last-child { border-bottom: none; }
    .saved-item:hover { background: #f9fafb; }

    .saved-item-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .saved-item-name {
        font-weight: 600;
        color: #1a1a2e;
    }

    .saved-item-meta {
        font-size: 0.75rem;
        color: #999;
    }

    .saved-item-actions {
        display: flex;
        gap: 8px;
    }

    .btn-sm {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 5px;
    }

    .btn-danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .btn-danger:hover { background: #fecaca; }

    /* Results */
    .results-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }

    .results-header {
        padding: 14px 20px;
        background: #f9fafb;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .results-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a2e;
        margin: 0;
    }

    .results-actions {
        display: flex;
        gap: 8px;
    }

    /* Summary */
    .summary-row {
        display: flex;
        gap: 16px;
        padding: 16px 20px;
        background: #f9fafb;
        border-bottom: 1px solid #e0e0e0;
        flex-wrap: wrap;
    }

    .summary-item {
        text-align: center;
        min-width: 80px;
    }

    .summary-label {
        font-size: 0.65rem;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
    }

    .summary-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a2e;
    }

    .summary-value.green { color: #22c55e; }

    /* Table */
    .payroll-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }

    .payroll-table th {
        background: #fafafa;
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 1px solid #e0e0e0;
    }

    .payroll-table th.num { text-align: right; }

    .payroll-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .payroll-table td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    .payroll-table tr:hover { background: #f9fafb; }

    .emp-name {
        font-weight: 600;
        color: #1a1a2e;
    }

    .emp-title {
        font-size: 0.7rem;
        color: #999;
    }

    .expand-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #666;
    }

    .expand-btn:hover { background: #e0e0e0; }
    .expand-btn.open { background: #3b82f6; color: #fff; }

    /* Detail Row */
    .detail-row {
        display: none;
    }

    .detail-row.open {
        display: table-row;
    }

    .detail-cell {
        padding: 8px 12px !important;
        background: #f9fafb;
    }

    /* Monthly View (Horizontal Calendar) */
    .monthly-view {
        overflow-x: auto;
        padding: 4px 0;
    }

    .monthly-scroll {
        display: flex;
        gap: 3px;
        min-width: max-content;
    }

    .day-box {
        width: 38px;
        min-width: 38px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 4px 2px;
        text-align: center;
        font-size: 0.7rem;
        transition: all 0.15s;
    }

    .day-box:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 6px rgba(59,130,246,0.15);
    }

    .day-box .day-num {
        font-weight: 700;
        font-size: 0.8rem;
        color: #1a1a2e;
    }

    .day-box .day-name {
        font-size: 0.55rem;
        color: #9ca3af;
        text-transform: uppercase;
        margin-bottom: 2px;
    }

    .day-box .day-hrs {
        font-weight: 600;
        font-size: 0.75rem;
        color: #3b82f6;
        background: #eff6ff;
        border-radius: 3px;
        padding: 1px 3px;
        margin-top: 2px;
    }

    .day-box .day-hrs.empty {
        color: #d1d5db;
        background: transparent;
    }

    .day-box .day-night {
        font-size: 0.55rem;
        color: #6366f1;
        margin-top: 1px;
    }

    .day-box .off-text {
        color: #e91e63;
        background: #fce7f3;
    }

    /* Weekend */
    .day-box.wknd {
        background: #fef2f2;
        border-color: #fecaca;
    }

    .day-box.wknd .day-num { color: #dc2626; }

    /* Holiday */
    .day-box.hol {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    .day-box.hol .day-num { color: #d97706; }

    /* Day Off */
    .day-box.off {
        background: #fce7f3;
        border-color: #f9a8d4;
    }
    
    /* Leave day */
    .day-box.leave {
        background: #f3f4f6;
        border-color: #9ca3af;
        border-width: 2px;
    }
    
    .day-box .leave-text {
        font-weight: 600;
        font-size: 0.65rem;
    }

    /* Work day with data */
    .day-box.work {
        background: #f0fdf4;
        border-color: #86efac;
    }

    .day-box.work .day-hrs {
        background: #dcfce7;
        color: #16a34a;
    }

    /* Editable inputs */
    .edit-input {
        width: 55px;
        padding: 4px 6px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.8rem;
        text-align: right;
        background: #fafafa;
    }

    .edit-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: #fff;
    }

    .edit-input.edit-main {
        font-weight: 600;
        background: #f0f7ff;
    }

    .edit-input::-webkit-inner-spin-button {
        opacity: 0;
    }

    .edit-input:hover::-webkit-inner-spin-button {
        opacity: 1;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #888;
    }

    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state-title { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 6px; }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-backdrop.open { display: flex; }

    .modal-box {
        background: #fff;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h4 { margin: 0; font-size: 1rem; }

    .modal-close {
        width: 28px; height: 28px;
        border: none;
        background: #f5f5f5;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
    }

    .modal-close:hover { background: #eee; }

    .modal-body { padding: 20px; }

    .form-group {
        margin-bottom: 14px;
    }

    .form-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 4px;
    }

    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .modal-footer {
        padding: 14px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    @@media (max-width: 768px) {
        .payroll-page { padding: 12px; }
        .payroll-header { flex-direction: column; align-items: flex-start; }
        .settings-row { flex-direction: column; gap: 12px; }
        .summary-row { flex-direction: column; }
    }
</style>

<div class="payroll-page">
    <!-- Header -->
    <div class="payroll-header">
        <h1 class="payroll-title">üìä @Localizer["Payroll"]</h1>
        
        <div class="nav-row">
            <div class="month-picker">
                <a href="@Url.Action("Payroll", new { year = Model.SelectedMonth == 1 ? Model.SelectedYear - 1 : Model.SelectedYear, month = Model.SelectedMonth == 1 ? 12 : Model.SelectedMonth - 1 })">‚Äπ</a>
                <span class="month-text">@Model.MonthName</span>
                <a href="@Url.Action("Payroll", new { year = Model.SelectedMonth == 12 ? Model.SelectedYear + 1 : Model.SelectedYear, month = Model.SelectedMonth == 12 ? 1 : Model.SelectedMonth + 1 })">‚Ä∫</a>
            </div>
            <a href="@Url.Action("Index", new { year = Model.SelectedYear, month = Model.SelectedMonth })" class="btn btn-outline">
                ‚Üê @Localizer["Calendar"]
            </a>
        </div>
    </div>

    <!-- Settings -->
    <div class="settings-card">
        <form method="get" class="settings-row" id="settingsForm">
            <input type="hidden" name="year" value="@Model.SelectedYear" />
            <input type="hidden" name="month" value="@Model.SelectedMonth" />
            
            <div class="setting-group">
                <label>@Localizer["DataSource"]</label>
                <select name="source" id="sourceSelect">
                    @if (Model.DataSource == "shift")
                    {
                        <option value="shift" selected>@Localizer["ShiftSchedule"]</option>
                        <option value="attendance">@Localizer["TimeAttendance"]</option>
                    }
                    else
                    {
                        <option value="shift">@Localizer["ShiftSchedule"]</option>
                        <option value="attendance" selected>@Localizer["TimeAttendance"]</option>
                    }
                </select>
            </div>
            
            <div class="setting-group">
                <label>@Localizer["NightStart"]</label>
                <select name="nightStartHour">
                    @for (int h = 18; h <= 23; h++)
                    {
                        if (Model.NightStartTime.Hour == h)
                        {
                            <option value="@h" selected>@h.ToString("00"):00</option>
                        }
                        else
                        {
                            <option value="@h">@h.ToString("00"):00</option>
                        }
                    }
                </select>
            </div>
            
            <div class="setting-group">
                <label>@Localizer["NightEnd"]</label>
                <select name="nightEndHour">
                    @for (int h = 4; h <= 9; h++)
                    {
                        if (Model.NightEndTime.Hour == h)
                        {
                            <option value="@h" selected>@h.ToString("00"):00</option>
                        }
                        else
                        {
                            <option value="@h">@h.ToString("00"):00</option>
                        }
                    }
                </select>
            </div>

            <button type="submit" name="calculate" value="true" class="btn btn-primary">
                üìä @Localizer["Calculate"]
            </button>
        </form>
    </div>

    <!-- Saved Payrolls -->
    @if (Model.SavedPayrolls.Any())
    {
        <div class="saved-list">
            <div class="saved-list-header">
                <span>@Localizer["SavedPayrolls"]</span>
            </div>
            @foreach (var saved in Model.SavedPayrolls)
            {
                <div class="saved-item">
                    <div class="saved-item-info">
                        <span class="saved-item-name">@saved.Name</span>
                        <span class="saved-item-meta">
                            @(saved.DataSource == "attendance" ? Localizer["TimeAttendance"] : Localizer["Shift"])
                            ¬∑ @saved.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                        </span>
                    </div>
                    <div class="saved-item-actions">
                        <button class="btn btn-sm btn-outline" onclick="loadSavedPayroll(@saved.Id)">
                            @Localizer["Load"]
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportSavedPayroll(@saved.Id)">
                            üì•
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSavedPayroll(@saved.Id)">
                            üóë
                        </button>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Results -->
    @if (Model.IsCalculated && Model.EmployeePayrolls.Any())
    {
        var totalWorked = Model.EmployeePayrolls.Sum(p => p.TotalWorkedHours);
        var totalRequired = Model.EmployeePayrolls.Sum(p => p.RequiredHours);
        var totalOvertime = Model.EmployeePayrolls.Sum(p => p.OvertimeHours);
        var totalNight = Model.EmployeePayrolls.Sum(p => p.NightHours);
        var totalWeekend = Model.EmployeePayrolls.Sum(p => p.WeekendHours);
        var totalHoliday = Model.EmployeePayrolls.Sum(p => p.HolidayHours);

        <div class="results-card">
            <div class="results-header">
                <h3>
                    @if (Model.LoadedPayrollId.HasValue)
                    {
                        <span style="color:#3b82f6;">üìÅ @Model.LoadedPayrollName</span>
                    }
                    else
                    {
                        @Localizer["CalculationResults"]
                    }
                    <span id="editIndicator" style="display:none;color:#f59e0b;font-size:0.8rem;">(@Localizer["Edited"])</span>
                </h3>
                <div class="results-actions">
                    <button class="btn btn-sm btn-primary" onclick="recalculate()" title="@Localizer["Recalculate"]">
                        üîÑ @Localizer["Recalculate"]
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="openSaveModal()">
                        üíæ @Localizer["Save"]
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportExcel()">
                        üì• Excel
                    </button>
                </div>
            </div>

            <!-- Summary (auto-updates when edited) -->
            <div class="summary-row">
                <div class="summary-item">
                    <div class="summary-label">@Localizer["TotalWorked"]</div>
                    <div class="summary-value" id="sumWorked">@totalWorked.ToString("0.#")s</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">@Localizer["Overtime"]</div>
                    <div class="summary-value green" id="sumOvertime">@totalOvertime.ToString("0.#")s</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">@Localizer["Night"]</div>
                    <div class="summary-value" id="sumNight">@totalNight.ToString("0.#")s</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">@Localizer["Weekend"]</div>
                    <div class="summary-value" id="sumWeekend">@totalWeekend.ToString("0.#")s</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">@Localizer["Holiday"]</div>
                    <div class="summary-value green" id="sumHoliday">@totalHoliday.ToString("0.#")s</div>
                </div>
            </div>

            <!-- Table -->
            <table class="payroll-table" id="payrollTable">
                <thead>
                    <tr>
                        <th style="width:30px;"></th>
                        <th>@Localizer["Employees"]</th>
                        <th class="num">@Localizer["Days"]</th>
                        <th class="num">@Localizer["Hours"]</th>
                        <th class="num">@Localizer["Target"]</th>
                        <th class="num" style="color:#22c55e;">@Localizer["OT"]</th>
                        <th class="num">@Localizer["Night"]</th>
                        <th class="num">@Localizer["Wknd"]</th>
                        <th class="num">@Localizer["Hol"]</th>
                        <th class="num">@Localizer["Off"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var payroll in Model.EmployeePayrolls.OrderBy(p => p.Employee.FullName))
                    {
                        var rowId = $"row_{payroll.Employee.Id}";
                        var empId = payroll.Employee.Id;
                        <tr data-emp="@empId">
                            <td>
                                <button class="expand-btn" onclick="toggleDetail('@rowId', this)">+</button>
                            </td>
                            <td>
                                <div class="emp-name">@payroll.Employee.FullName</div>
                                @if (!string.IsNullOrEmpty(payroll.Employee.Title))
                                {
                                    <div class="emp-title">@payroll.Employee.Title</div>
                                }
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="days" value="@payroll.WorkedDays" min="0" max="31" onchange="markEdited()">
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input edit-main" data-emp="@empId" data-field="hours" value="@payroll.TotalWorkedHours.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" step="0.5" min="0" onchange="markEdited(); updateSummary(); updateOvertime(this)">
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="required" value="@payroll.RequiredHours.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" step="0.5" min="0" onchange="markEdited(); updateOvertime(this)">
                            </td>
                            <td class="num">
                                <span class="overtime-value" data-emp="@empId" style="color:#22c55e;font-weight:600;">@payroll.OvertimeHours.ToString("0.#")</span>
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="night" value="@payroll.NightHours.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" step="0.5" min="0" onchange="markEdited(); updateSummary()">
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="weekend" value="@payroll.WeekendHours.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" step="0.5" min="0" onchange="markEdited(); updateSummary()">
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="holiday" value="@payroll.HolidayHours.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" step="0.5" min="0" onchange="markEdited(); updateSummary()">
                            </td>
                            <td class="num">
                                <input type="number" class="edit-input" data-emp="@empId" data-field="off" value="@payroll.DayOffCount" min="0" max="31" onchange="markEdited()">
                            </td>
                        </tr>
                        <tr class="detail-row" id="@rowId">
                            <td colspan="10" class="detail-cell">
                                <div class="monthly-view">
                                    <div class="monthly-scroll">
                                        @{
                                            var detailsDict = payroll.ShiftDetails.ToDictionary(d => d.Date.Day, d => d);
                                        }
                                        @for (int day = 1; day <= Model.DaysInMonth; day++)
                                        {
                                            var date = new DateOnly(Model.SelectedYear, Model.SelectedMonth, day);
                                            var dow = (int)date.DayOfWeek;
                                            var isWeekendDay = dow == 0 || dow == 6;
                                            detailsDict.TryGetValue(day, out var detail);
                                            var hasData = detail != null;
                                            var isDayOff = detail?.IsDayOff == true;
                                            var isLeaveDay = detail?.IsLeave == true;
                                            var isHolidayDay = detail?.IsHoliday == true;
                                            var cellClass = isLeaveDay ? "leave" : (isDayOff ? "off" : (isHolidayDay ? "hol" : (isWeekendDay ? "wknd" : (hasData ? "work" : ""))));
                                            var leaveStyle = isLeaveDay && !string.IsNullOrEmpty(detail?.LeaveColor) ? $"border-color: {detail.LeaveColor}; background: {detail.LeaveColor}20;" : "";
                                            
                                            <div class="day-box @cellClass" style="@leaveStyle" title="@date.ToString("dd.MM.yyyy") @dayNames[dow] @(isLeaveDay ? detail?.LeaveCode : "")">
                                                <div class="day-num">@day</div>
                                                <div class="day-name">@dayNames[dow]</div>
                                                @if (isLeaveDay)
                                                {
                                                    <div class="day-hrs leave-text" style="color: @(detail?.LeaveColor ?? "#6b7280")">@(detail?.LeaveCode ?? "ƒ∞")</div>
                                                }
                                                else if (isDayOff)
                                                {
                                                    <div class="day-hrs off-text">ƒ∞</div>
                                                }
                                                else if (hasData && detail!.TotalHours > 0)
                                                {
                                                    <div class="day-hrs">@detail.TotalHours.ToString("0.#")</div>
                                                    @if (detail.NightHours > 0)
                                                    {
                                                        <div class="day-night">üåô@detail.NightHours.ToString("0.#")</div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="day-hrs empty">-</div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (Model.IsCalculated)
    {
        <div class="results-card">
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-title">@Localizer["NoDataFound"]</div>
                <p>@(Model.DataSource == "attendance" 
                    ? Localizer["NoAttendanceRecordsForSelectedMonth"]
                    : Localizer["NoShiftsAssignedForSelectedMonth"])</p>
            </div>
        </div>
    }
    else if (!Model.IsCalculated)
    {
        <div class="results-card">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">@Localizer["CalculatePayroll"]</div>
                <p>@Localizer["SelectDataSourceAndClickCalculate"]</p>
            </div>
        </div>
    }
</div>

<!-- Save Modal -->
<div class="modal-backdrop" id="saveModal">
    <div class="modal-box">
        <div class="modal-header">
            <h4>@Localizer["SavePayroll"]</h4>
            <button class="modal-close" onclick="closeSaveModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>@Localizer["Name"]</label>
                <input type="text" id="payrollName" placeholder="@Localizer["PayrollNamePlaceholder"].Value">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeSaveModal()">@Localizer["Cancel"]</button>
            <button class="btn btn-primary" onclick="savePayroll()">@Localizer["Save"]</button>
        </div>
    </div>
</div>

<script>
    const hoursAbbrev = '@Localizer["HoursAbbrev"].Value';
    let isEdited = false;
    
    // Employee base data (for daily entries)
    const employeeData = {
        @foreach (var payroll in Model.EmployeePayrolls)
        {
            @:@payroll.Employee.Id: {
                @:name: '@payroll.Employee.FullName.Replace("'", "\\'")',
                @:title: '@(payroll.Employee.Title?.Replace("'", "\\'") ?? "")',
                @:dailyEntries: [
                    @foreach (var d in payroll.ShiftDetails)
                    {
                        @:{ date: '@d.Date.ToString("yyyy-MM-dd")', startTime: '@(d.StartTime?.ToString("HH:mm") ?? "")', endTime: '@(d.EndTime?.ToString("HH:mm") ?? "")', hours: @d.TotalHours.ToString(System.Globalization.CultureInfo.InvariantCulture), nightHours: @d.NightHours.ToString(System.Globalization.CultureInfo.InvariantCulture), isWeekend: @d.IsWeekend.ToString().ToLower(), isHoliday: @d.IsHoliday.ToString().ToLower(), isDayOff: @d.IsDayOff.ToString().ToLower(), isLeave: @d.IsLeave.ToString().ToLower(), leaveCode: '@(d.LeaveCode ?? "")', leaveColor: '@(d.LeaveColor ?? "")', note: '@(d.HolidayName?.Replace("'", "\\'") ?? d.Note?.Replace("'", "\\'") ?? "")' },
                    }
                @:]
            @:},
        }
    };

    function toggleDetail(rowId, btn) {
        const row = document.getElementById(rowId);
        row.classList.toggle('open');
        btn.classList.toggle('open');
        btn.textContent = row.classList.contains('open') ? '‚àí' : '+';
    }

    function markEdited() {
        isEdited = true;
        document.getElementById('editIndicator').style.display = 'inline';
    }

    function updateSummary() {
        let totalHours = 0, totalNight = 0, totalWeekend = 0, totalHoliday = 0;
        
        document.querySelectorAll('input[data-field="hours"]').forEach(inp => {
            totalHours += parseFloat(inp.value) || 0;
        });
        document.querySelectorAll('input[data-field="night"]').forEach(inp => {
            totalNight += parseFloat(inp.value) || 0;
        });
        document.querySelectorAll('input[data-field="weekend"]').forEach(inp => {
            totalWeekend += parseFloat(inp.value) || 0;
        });
        document.querySelectorAll('input[data-field="holiday"]').forEach(inp => {
            totalHoliday += parseFloat(inp.value) || 0;
        });

        document.getElementById('sumWorked').textContent = totalHours.toFixed(1) + hoursAbbrev;
        document.getElementById('sumNight').textContent = totalNight.toFixed(1) + hoursAbbrev;
        document.getElementById('sumWeekend').textContent = totalWeekend.toFixed(1) + hoursAbbrev;
        document.getElementById('sumHoliday').textContent = totalHoliday.toFixed(1) + hoursAbbrev;
    }

    function recalculate() {
        if (isEdited && !confirm('@Localizer["YourEditsWillBeLost"]')) {
            return;
        }
        // Re-submit the form with calculate=true
        const form = document.getElementById('settingsForm');
        form.submit();
    }

    function openSaveModal() {
        document.getElementById('saveModal').classList.add('open');
        document.getElementById('payrollName').value = '@Model.MonthName';
        document.getElementById('payrollName').focus();
    }

    function closeSaveModal() {
        document.getElementById('saveModal').classList.remove('open');
    }

    function collectPayrollData() {
        const payrollData = [];
        const rows = document.querySelectorAll('tr[data-emp]');
        
        rows.forEach(row => {
            const empId = row.getAttribute('data-emp');
            const empInfo = employeeData[empId] || {};
            const hours = parseFloat(row.querySelector('input[data-field="hours"]')?.value) || 0;
            const required = parseFloat(row.querySelector('input[data-field="required"]')?.value) || 0;
            const overtime = Math.max(0, hours - required);
            
            payrollData.push({
                employeeId: parseInt(empId),
                employeeName: empInfo.name || '',
                employeeTitle: empInfo.title || '',
                workedDays: parseInt(row.querySelector('input[data-field="days"]')?.value) || 0,
                totalWorkedHours: hours,
                requiredHours: required,
                overtimeHours: overtime,
                nightHours: parseFloat(row.querySelector('input[data-field="night"]')?.value) || 0,
                weekendHours: parseFloat(row.querySelector('input[data-field="weekend"]')?.value) || 0,
                holidayHours: parseFloat(row.querySelector('input[data-field="holiday"]')?.value) || 0,
                dayOffCount: parseInt(row.querySelector('input[data-field="off"]')?.value) || 0,
                dailyEntries: empInfo.dailyEntries || []
            });
        });
        
        return payrollData;
    }

    function updateOvertime(input) {
        const row = input.closest('tr');
        const empId = row.getAttribute('data-emp');
        const hours = parseFloat(row.querySelector('input[data-field="hours"]')?.value) || 0;
        const required = parseFloat(row.querySelector('input[data-field="required"]')?.value) || 0;
        const overtime = Math.max(0, hours - required);
        
        const otSpan = row.querySelector('.overtime-value');
        if (otSpan) {
            otSpan.textContent = overtime.toFixed(1);
        }
        
        // Update total overtime in summary
        let totalOT = 0;
        document.querySelectorAll('.overtime-value').forEach(span => {
            totalOT += parseFloat(span.textContent) || 0;
        });
        const sumOT = document.getElementById('sumOvertime');
        if (sumOT) sumOT.textContent = totalOT.toFixed(1) + hoursAbbrev;
    }

    async function savePayroll() {
        const name = document.getElementById('payrollName').value.trim();
        if (!name) {
            alert('@Localizer["NameRequired"]');
            return;
        }

        const payrollData = collectPayrollData();

        try {
            const res = await fetch('/api/payroll/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    year: @Model.SelectedYear,
                    month: @Model.SelectedMonth,
                    dataSource: '@Model.DataSource',
                    nightStartHour: @Model.NightStartTime.Hour,
                    nightEndHour: @Model.NightEndTime.Hour,
                    payrollDataJson: JSON.stringify(payrollData)
                })
            });
            const result = await res.json();
            if (result.success) {
                isEdited = false;
                closeSaveModal();
                alert('@Localizer["PayrollSaved"]');
                location.reload();
            } else {
                alert(result.error || '@Localizer["Error"]');
            }
        } catch (e) {
            alert('@Localizer["ConnectionError"]');
        }
    }

    async function loadSavedPayroll(id) {
        // Directly load saved payroll with loadId parameter
        window.location.href = `?year=@Model.SelectedYear&month=@Model.SelectedMonth&loadId=${id}`;
    }

    async function deleteSavedPayroll(id) {
        if (!confirm('@Localizer["AreYouSureDeletePayroll"]')) return;
        
        try {
            const res = await fetch(`/api/payroll/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || '@Localizer["Error"]');
            }
        } catch (e) {
            alert('@Localizer["ConnectionError"]');
        }
    }

    function exportSavedPayroll(id) {
        window.location.href = `/api/export/payroll-saved/${id}`;
    }

    function exportExcel() {
        const year = @Model.SelectedYear;
        const month = @Model.SelectedMonth;
        const source = '@Model.DataSource';
        const nightStartHour = @Model.NightStartTime.Hour;
        const nightEndHour = @Model.NightEndTime.Hour;
        
        window.location.href = `/api/export/payroll?year=${year}&month=${month}&source=${source}&nightStartHour=${nightStartHour}&nightEndHour=${nightEndHour}`;
    }
</script>
