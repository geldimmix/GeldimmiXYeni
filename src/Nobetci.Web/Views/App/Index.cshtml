@model AppViewModel
@{
    var isTurkish = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "tr";
    ViewData["Title"] = isTurkish ? "N√∂bet Planlama" : "Shift Planning";
    Layout = "_AppLayout";
}

<div class="app-wrapper">
    <!-- Left Sidebar - Compact -->
    <aside class="app-sidebar">
        <!-- Quick Actions -->
        <div class="sidebar-actions">
            <button class="action-btn employees-btn" data-bs-toggle="modal" data-bs-target="#employeesModal">
                <span class="action-icon">üë•</span>
                <span class="action-label">@(isTurkish ? "Personeller" : "Employees")</span>
                <span class="action-badge">@Model.EmployeeCount</span>
            </button>
            
            <button class="action-btn holidays-btn" data-bs-toggle="modal" data-bs-target="#addHolidayModal">
                <span class="action-icon">üóìÔ∏è</span>
                <span class="action-label">@(isTurkish ? "Tatiller" : "Holidays")</span>
                <span class="action-badge">@Model.Holidays.Count</span>
            </button>
            
            @if (Model.CanAccessPayroll)
            {
                <a href="@Url.Action("Payroll", new { year = Model.SelectedYear, month = Model.SelectedMonth })" class="action-btn payroll-btn">
                    <span class="action-icon">üìä</span>
                    <span class="action-label">@(isTurkish ? "Puantaj" : "Payroll")</span>
                    <span class="action-badge">‚úì</span>
                </a>
            }
            else
            {
                <button class="action-btn payroll-btn disabled" title="@(isTurkish ? "Kayƒ±tlƒ± kullanƒ±cƒ±lara √∂zel" : "For registered users only")" disabled>
                    <span class="action-icon">üìä</span>
                    <span class="action-label">@(isTurkish ? "Puantaj" : "Payroll")</span>
                    <span class="action-badge">üîí</span>
                </button>
            }
            
            @if (Model.CanAccessAttendance)
            {
                <a href="@Url.Action("Attendance", new { year = Model.SelectedYear, month = Model.SelectedMonth })" class="action-btn attendance-btn">
                    <span class="action-icon">üïê</span>
                    <span class="action-label">@(isTurkish ? "Mesai Takip" : "Attendance")</span>
                    <span class="action-badge">‚úì</span>
                </a>
            }
            else
            {
                <button class="action-btn attendance-btn disabled" title="@(isTurkish ? "Kayƒ±tlƒ± kullanƒ±cƒ±lara √∂zel" : "For registered users only")" disabled>
                    <span class="action-icon">üïê</span>
                    <span class="action-label">@(isTurkish ? "Mesai Takip" : "Attendance")</span>
                    <span class="action-badge">üîí</span>
                </button>
            }
        </div>
        
        <!-- Templates Button -->
        <button class="action-btn templates-btn" data-bs-toggle="modal" data-bs-target="#templatesModal">
            <span class="action-icon">‚è∞</span>
            <span class="action-label">@(isTurkish ? "Vardiya ≈ûablonlarƒ±" : "Shift Templates")</span>
            <span class="action-badge">‚úì</span>
        </button>
        
        <!-- Leaves Button -->
        <button class="action-btn leaves-btn" data-bs-toggle="modal" data-bs-target="#leavesModal">
            <span class="action-icon">üìã</span>
            <span class="action-label">@(isTurkish ? "ƒ∞zinler" : "Leaves")</span>
            <span class="action-badge">‚úì</span>
        </button>
        
        <!-- Units Button (Premium Feature) -->
        @if (Model.CanManageUnits)
        {
            <button class="action-btn units-btn" data-bs-toggle="modal" data-bs-target="#unitsModal">
                <span class="action-icon">üè•</span>
                <span class="action-label">@(isTurkish ? "Birimler" : "Units")</span>
                <span class="action-badge premium-badge">@Model.Units.Count</span>
            </button>
        }
        else if (Model.IsRegistered)
        {
            <button class="action-btn units-btn disabled" title="@(isTurkish ? "Premium √ºyelik gerekli" : "Premium membership required")" disabled>
                <span class="action-icon">üè•</span>
                <span class="action-label">@(isTurkish ? "Birimler" : "Units")</span>
                <span class="action-badge">üîí</span>
            </button>
        }
        
        <!-- Multi-select Toggle -->
        <div class="multi-toggle">
            <label>
                <input type="checkbox" id="multiSelectMode">
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
                <span class="toggle-text">@(isTurkish ? "√áoklu Se√ßim" : "Multi-Select")</span>
            </label>
        </div>
        
        <!-- Selected Template Indicator -->
        <div class="selected-indicator" id="selectedIndicator" style="display:none;">
            <div class="indicator-color"></div>
            <div class="indicator-text">
                <span class="indicator-label">@(isTurkish ? "Se√ßili" : "Selected")</span>
                <span class="indicator-time" id="selectedTime"></span>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="app-main">
        <!-- Toolbar -->
        <div class="app-toolbar">
            <div class="toolbar-nav">
                <a href="@Url.Action("Index", new { year = Model.SelectedMonth == 1 ? Model.SelectedYear - 1 : Model.SelectedYear, month = Model.SelectedMonth == 1 ? 12 : Model.SelectedMonth - 1, unitId = Model.SelectedUnitId })" 
                   class="nav-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                </a>
                <h4 class="month-title">@Model.MonthName</h4>
                <a href="@Url.Action("Index", new { year = Model.SelectedMonth == 12 ? Model.SelectedYear + 1 : Model.SelectedYear, month = Model.SelectedMonth == 12 ? 1 : Model.SelectedMonth + 1, unitId = Model.SelectedUnitId })" 
                   class="nav-arrow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </a>
                
                @if (Model.IsPremium && Model.Units.Any())
                {
                    <div class="unit-selector">
                        <select id="unitSelector" class="unit-select" onchange="changeUnit(this.value)">
                            @foreach (var unit in Model.Units)
                            {
                                if (unit.Id == Model.SelectedUnitId)
                                {
                                    <option value="@unit.Id" selected
                                            data-color="@unit.Color"
                                            data-employee-count="@unit.Employees.Count"
                                            data-employee-limit="@unit.EmployeeLimit">
                                        @unit.Name (@unit.Employees.Count @(isTurkish ? "personel" : "employees"))
                                    </option>
                                }
                                else
                                {
                                    <option value="@unit.Id"
                                            data-color="@unit.Color"
                                            data-employee-count="@unit.Employees.Count"
                                            data-employee-limit="@unit.EmployeeLimit">
                                        @unit.Name (@unit.Employees.Count @(isTurkish ? "personel" : "employees"))
                                    </option>
                                }
                            }
                        </select>
                    </div>
                }
            </div>
            
            <div class="toolbar-actions">
                <button class="toolbar-btn ghost" id="clearSelectionBtn" style="display:none;">
                    @(isTurkish ? "Temizle" : "Clear")
                </button>
                <button class="toolbar-btn primary" id="applyToSelectedBtn" style="display:none;">
                    ‚úì @(isTurkish ? "Uygula" : "Apply")
                </button>
                
                @if (Model.CanUseSmartScheduling)
                {
                    <button class="toolbar-btn accent" id="generateScheduleBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                        @(isTurkish ? "Akƒ±llƒ± Olu≈ütur" : "Smart Generate")
                    </button>
                }
                else
                {
                    <button class="toolbar-btn accent locked" id="generateScheduleBtn" data-premium="true">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        @(isTurkish ? "Akƒ±llƒ± Olu≈ütur" : "Smart Generate")
                    </button>
                }
                
                @if (Model.CanExportExcel)
                {
                    <button class="toolbar-btn" id="exportExcelBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M12 18v-6M9 15l3 3 3-3"/></svg>
                        Excel
                    </button>
                }
                else
                {
                    <button class="toolbar-btn locked" id="exportExcelBtn" data-premium="true">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        Excel
                    </button>
                }
                
                @if (Model.IsRegistered)
                {
                    <button class="toolbar-btn" id="savedSchedulesBtn" data-bs-toggle="modal" data-bs-target="#savedSchedulesModal">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
                        @(isTurkish ? "Kayƒ±tlƒ± Listeler" : "Saved Schedules")
                    </button>
                }
                else
                {
                    <button class="toolbar-btn locked" id="savedSchedulesBtn" data-premium="true">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        @(isTurkish ? "Kayƒ±tlƒ± Listeler" : "Saved")
                    </button>
                }
            </div>
        </div>
        
        <!-- Schedule Grid -->
        <div class="schedule-container">
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th class="col-employee sticky-col">@(isTurkish ? "Personel" : "Employee")</th>
                        @for (int day = 1; day <= Model.DaysInMonth; day++)
                        {
                            var date = new DateOnly(Model.SelectedYear, Model.SelectedMonth, day);
                            var isWeekend = Model.IsWeekend(date);
                            var isHoliday = Model.IsHoliday(date);
                            var dayNames = isTurkish 
                                ? new[] { "Paz", "Pzt", "Sal", "√áar", "Per", "Cum", "Cmt" }
                                : new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
                            var dayName = dayNames[(int)date.DayOfWeek];
                            
                            <th class="col-day @(isWeekend ? "weekend" : "") @(isHoliday ? "holiday" : "")">
                                <span class="day-name">@dayName</span>
                                <span class="day-num">@day</span>
                            </th>
                        }
                        <th class="col-total sticky-col-right">@(isTurkish ? "Toplam" : "Total")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var employee in Model.Employees)
                    {
                        var employeeShifts = Model.GetShiftsForEmployee(employee.Id);
                        
                        // Calculate worked hours considering OvernightHoursMode
                        // Mode 0 = Split at midnight, Mode 1 = All hours this month
                        var totalWorkedHours = 0m;
                        var lastDayOfMonth = new DateOnly(Model.SelectedYear, Model.SelectedMonth, Model.DaysInMonth);
                        
                        foreach (var shift in employeeShifts.Where(s => !s.IsDayOff))
                        {
                            if (shift.SpansNextDay && shift.Date == lastDayOfMonth)
                            {
                                // This is an overnight shift on the last day of month
                                if (shift.OvernightHoursMode == 0)
                                {
                                    // Split at midnight - only count hours until midnight (StartTime to 00:00)
                                    var hoursUntilMidnight = (24 - shift.StartTime.Hour) - (shift.StartTime.Minute / 60.0m);
                                    // Subtract break proportionally if shift has break
                                    if (shift.BreakMinutes > 0 && shift.TotalHours > 0)
                                    {
                                        var totalShiftHours = shift.TotalHours + (shift.BreakMinutes / 60.0m);
                                        var breakRatio = shift.BreakMinutes / 60.0m / totalShiftHours;
                                        hoursUntilMidnight = hoursUntilMidnight * (1 - breakRatio);
                                    }
                                    totalWorkedHours += Math.Max(0, hoursUntilMidnight);
                                }
                                else
                                {
                                    // OvernightHoursMode = 1: All hours go to current month
                                    totalWorkedHours += shift.TotalHours;
                                }
                            }
                            else
                            {
                                // Normal shift or not on last day
                                totalWorkedHours += shift.TotalHours;
                            }
                        }
                        
                        // Add hours from previous month's overnight shifts that carry over (only if split at midnight)
                        var prevMonthShift = Model.GetPreviousMonthOvernightShift(employee.Id);
                        if (prevMonthShift != null && !prevMonthShift.IsDayOff && prevMonthShift.OvernightHoursMode == 0)
                        {
                            // Split at midnight - add hours from 00:00 to EndTime
                            var hoursAfterMidnight = prevMonthShift.EndTime.Hour + (prevMonthShift.EndTime.Minute / 60.0m);
                            // Subtract break proportionally if shift has break
                            if (prevMonthShift.BreakMinutes > 0 && prevMonthShift.TotalHours > 0)
                            {
                                var totalShiftHours = prevMonthShift.TotalHours + (prevMonthShift.BreakMinutes / 60.0m);
                                var breakRatio = prevMonthShift.BreakMinutes / 60.0m / totalShiftHours;
                                hoursAfterMidnight = hoursAfterMidnight * (1 - breakRatio);
                            }
                            totalWorkedHours += Math.Max(0, hoursAfterMidnight);
                        }
                        // OvernightHoursMode = 1: All hours stay in the shift's month, nothing to add here
                        
                        var dayOffCount = employeeShifts.Count(s => s.IsDayOff);
                        
                        // Calculate required hours (excluding holidays, weekends based on settings, day offs, and leaves)
                        var workDays = 0;
                        var saturdayHours = 0m;
                        var halfDayHours = 0m; // Track half-day holiday hours separately
                        var leaveCount = Model.Leaves.Count(l => l.EmployeeId == employee.Id);
                        
                        for (int d = 1; d <= Model.DaysInMonth; d++)
                        {
                            var checkDate = new DateOnly(Model.SelectedYear, Model.SelectedMonth, d);
                            var dayOfWeek = checkDate.DayOfWeek;
                            var isWeekendDay = dayOfWeek == DayOfWeek.Saturday || dayOfWeek == DayOfWeek.Sunday;
                            var holiday = Model.GetHoliday(checkDate);
                            var hasLeave = Model.GetLeaveForEmployeeOnDate(employee.Id, checkDate) != null;
                            
                            // Skip if employee has leave on this date
                            if (hasLeave) continue;
                            
                            // Handle holidays
                            if (holiday != null)
                            {
                                // Full holiday - skip entirely
                                if (!holiday.IsHalfDay)
                                    continue;
                                
                                // Half-day holiday - add the specified work hours
                                if (holiday.IsHalfDay && holiday.HalfDayWorkHours.HasValue)
                                {
                                    // Only add if employee works on this day (check weekend mode)
                                    if (!isWeekendDay || employee.WeekendWorkMode > 0)
                                    {
                                        halfDayHours += holiday.HalfDayWorkHours.Value;
                                    }
                                    continue;
                                }
                            }
                            
                            if (isWeekendDay)
                            {
                                // Check weekend work mode
                                if (employee.WeekendWorkMode == 1) // Works both days
                                {
                                    workDays++;
                                }
                                else if (employee.WeekendWorkMode == 2 && dayOfWeek == DayOfWeek.Saturday) // Only Saturday
                                {
                                    workDays++;
                                }
                                else if (employee.WeekendWorkMode == 3 && dayOfWeek == DayOfWeek.Saturday) // Saturday specific hours
                                {
                                    saturdayHours += employee.SaturdayWorkHours ?? 0;
                                }
                                // Mode 0 = Does not work weekends
                            }
                            else
                            {
                                workDays++; // Weekday
                            }
                        }
                        
                        // Subtract day off days from work days (each day off reduces required by daily hours)
                        workDays = Math.Max(0, workDays - dayOffCount);
                        var requiredHours = (workDays * employee.DailyWorkHours) + saturdayHours + halfDayHours;
                        var isOvertime = totalWorkedHours > requiredHours;
                        var isUndertime = totalWorkedHours < requiredHours;
                        
                        <tr data-employee-id="@employee.Id">
                            <td class="col-employee sticky-col">
                                <div class="employee-cell employee-clickable" data-employee-id="@employee.Id" data-employee-name="@employee.FullName">
                                    <span class="emp-color" style="background: @(employee.Color ?? "#3B82F6")"></span>
                                    <div class="emp-info">
                                        <span class="emp-name">@employee.FullName</span>
                                        @if (!string.IsNullOrEmpty(employee.Title))
                                        {
                                            <span class="emp-title">@employee.Title</span>
                                        }
                                    </div>
                                </div>
                            </td>
                            @for (int day = 1; day <= Model.DaysInMonth; day++)
                            {
                                var date = new DateOnly(Model.SelectedYear, Model.SelectedMonth, day);
                                var shift = Model.GetShiftForEmployeeOnDate(employee.Id, date);
                                var leave = Model.GetLeaveForEmployeeOnDate(employee.Id, date);
                                var isWeekend = Model.IsWeekend(date);
                                var isHoliday = Model.IsHoliday(date);
                                // For day 1, check previous month's overnight shifts; for other days, check previous day
                                var prevDayShift = day == 1 
                                    ? Model.GetPreviousMonthOvernightShift(employee.Id) 
                                    : Model.GetShiftForEmployeeOnDate(employee.Id, date.AddDays(-1));
                                var showContinuation = prevDayShift?.SpansNextDay == true && leave == null;
                                
                                <td class="shift-cell @(isWeekend ? "weekend" : "") @(isHoliday ? "holiday" : "")"
                                    data-date="@date.ToString("yyyy-MM-dd")"
                                    data-employee-id="@employee.Id">
                                    
                                    @if (showContinuation)
                                    {
                                        <div class="shift-continuation" style="background: @(prevDayShift?.ShiftTemplate?.Color ?? "#EF4444")20; border-color: @(prevDayShift?.ShiftTemplate?.Color ?? "#EF4444")">
                                            <span class="cont-icon">‚Üì</span>
                                            <span class="cont-time">@prevDayShift?.EndTime.ToString("HH:mm")</span>
                                        </div>
                                    }
                                    
                                    @if (leave != null)
                                    {
                                        <!-- Leave badge (priority over shift) -->
                                        <div class="leave-badge" 
                                             style="background: @leave.LeaveType.Color"
                                             data-leave-id="@leave.Id"
                                             title="@(isTurkish ? leave.LeaveType.NameTr : leave.LeaveType.NameEn)">
                                            @(isTurkish ? leave.LeaveType.Code : leave.LeaveType.CodeEn)
                                        </div>
                                    }
                                    else if (shift != null)
                                    {
                                        @if (shift.IsDayOff)
                                        {
                                            <div class="shift-badge day-off" data-shift-id="@shift.Id">
                                                <span class="day-off-icon">üö´</span>
                                                <span class="day-off-text">@(isTurkish ? "Bo≈ü" : "Off")</span>
                                            </div>
                                        }
                                        else
                                        {
                                            var color = shift.ShiftTemplate?.Color ?? "#3B82F6";
                                            <div class="shift-badge @(shift.SpansNextDay ? "overnight" : "")" 
                                                 style="background: @(color)20; border-color: @color; color: @color"
                                                 data-shift-id="@shift.Id">
                                                <span class="shift-start">@shift.StartTime.ToString("HH:mm")</span>
                                                <span class="shift-end">@shift.EndTime.ToString("HH:mm")</span>
                                                @if (shift.SpansNextDay)
                                                {
                                                    <span class="overnight-badge">+1</span>
                                                }
                                            </div>
                                        }
                                    }
                                </td>
                            }
                            @{
                                var diff = totalWorkedHours - requiredHours;
                                var diffText = diff > 0 ? $"+{diff:0.#}" : diff < 0 ? $"{diff:0.#}" : "0";
                            }
                            <td class="col-total sticky-col-right">
                                <div class="total-cell @(isOvertime ? "overtime" : "") @(isUndertime ? "undertime" : "")">
                                    <div class="total-main">
                                        <span class="worked-hours">@totalWorkedHours.ToString("0.#")</span>
                                        <span class="separator">/</span>
                                        <span class="required-hours">@requiredHours.ToString("0.#")</span>
                                    </div>
                                    <span class="diff-hours @(diff > 0 ? "positive" : diff < 0 ? "negative" : "")">@diffText</span>
                                </div>
                            </td>
                        </tr>
                    }
                    
                    @if (!Model.Employees.Any())
                    {
                        <tr>
                            <td colspan="@(Model.DaysInMonth + 2)" class="empty-table">
                                <div class="empty-state">
                                    <span class="icon">üìÖ</span>
                                    <p>@(isTurkish ? "Personel ekleyerek ba≈ülayƒ±n" : "Start by adding employees")</p>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Legend -->
        <div class="schedule-legend">
            <div class="legend-item">
                <span class="legend-color weekend"></span>
                <span>@(isTurkish ? "Hafta Sonu" : "Weekend")</span>
            </div>
            <div class="legend-item">
                <span class="legend-color holiday"></span>
                <span>@(isTurkish ? "Tatil" : "Holiday")</span>
            </div>
            <div class="legend-item">
                <span class="legend-badge overnight">+1</span>
                <span>@(isTurkish ? "Ertesi G√ºne Sarkan" : "Overnight")</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">‚Üì</span>
                <span>@(isTurkish ? "√ñnceki G√ºnden Devam" : "Continues from Previous")</span>
            </div>
        </div>
    </main>
</div>

@if (Model.CanManageUnits)
{
<!-- Units Modal (Premium Feature) -->
<div class="modal fade" id="unitsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üè•</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Birim Y√∂netimi" : "Unit Management")</h5>
                    <p class="modal-subtitle premium-text">
                        <span class="premium-icon">‚≠ê</span>
                        @(isTurkish ? "Premium √ñzellik" : "Premium Feature")
                    </p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <!-- Tabs -->
                <ul class="nav nav-tabs unit-tabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#unitsTab" type="button">
                            <span class="tab-icon">üè¢</span>
                            @(isTurkish ? "Birimler" : "Units")
                            <span class="tab-badge" id="unitCountBadge">@Model.Units.Count</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unitTypesTab" type="button">
                            <span class="tab-icon">üìÅ</span>
                            @(isTurkish ? "Birim Tipleri" : "Unit Types")
                            <span class="tab-badge" id="unitTypeCountBadge">@Model.UnitTypes.Count</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Units Tab -->
                    <div class="tab-pane fade show active" id="unitsTab">
                        <div class="units-section">
                            <!-- Add Unit Form -->
                            <div class="add-unit-form">
                                <div class="form-row">
                                    <input type="text" id="newUnitName" class="form-input" placeholder="@(isTurkish ? "Birim adƒ±..." : "Unit name...")">
                                    <select id="newUnitType" class="form-select">
                                        <option value="">@(isTurkish ? "Birim Tipi Se√ßin" : "Select Unit Type")</option>
                                        @foreach (var ut in Model.UnitTypes)
                                        {
                                            <option value="@ut.Id" data-coefficient="@ut.DefaultCoefficient" data-color="@ut.Color">@ut.Name</option>
                                        }
                                    </select>
                                    <input type="number" id="newUnitCoefficient" class="form-input coefficient-input" value="1.0" step="0.25" min="0.5" max="3" placeholder="@(isTurkish ? "Katsayƒ±" : "Coefficient")">
                                    <input type="number" id="newUnitEmployeeLimit" class="form-input limit-input" value="0" min="0" max="100" placeholder="@(isTurkish ? "Personel Limiti (0=Sƒ±nƒ±rsƒ±z)" : "Employee Limit (0=Unlimited)")">
                                    <button type="button" class="btn btn-primary" id="addUnitBtn">
                                        <span class="btn-icon">+</span>
                                        @(isTurkish ? "Birim Ekle" : "Add Unit")
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Units List -->
                            <div class="units-list" id="unitsList">
                                @if (ViewBag.UnitLoadError != null)
                                {
                                    <div class="error-state" style="padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; margin-bottom: 16px;">
                                        <strong>‚ö†Ô∏è Hata:</strong> @ViewBag.UnitLoadError
                                    </div>
                                }
                                @if (Model.Units.Count == 0)
                                {
                                    <div class="empty-state">
                                        <span class="empty-icon">üè•</span>
                                        <p>@(isTurkish ? "Hen√ºz birim eklenmemi≈ü" : "No units added yet")</p>
                                        <small>@(isTurkish ? "Yukarƒ±dan yeni birim ekleyerek ba≈ülayƒ±n" : "Start by adding a new unit above")</small>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var unit in Model.Units)
                                    {
                                        var empCount = 0; // Model.Employees.Count(e => e.UnitId == unit.Id); - temporarily disabled
                                        <div class="unit-card" data-unit-id="@unit.Id">
                                            <div class="unit-color-bar" style="background-color: @(unit.Color ?? "#3B82F6")"></div>
                                            <div class="unit-info">
                                                <div class="unit-header">
                                                    <h4 class="unit-name">@unit.Name</h4>
                                                    @if (unit.IsDefault)
                                                    {
                                                        <span class="default-badge">@(isTurkish ? "Varsayƒ±lan" : "Default")</span>
                                                    }
                                                </div>
                                                @if (unit.UnitType != null)
                                                {
                                                    <span class="unit-type-badge" style="background-color: @(unit.UnitType.Color ?? "#6B7280")">@unit.UnitType.Name</span>
                                                }
                                                <div class="unit-meta">
                                                    <span class="meta-item">
                                                        <span class="meta-icon">üë•</span>
                                                        @empCount @(isTurkish ? "personel" : "employees")
                                                    </span>
                                                    <span class="meta-item">
                                                        <span class="meta-icon">üìä</span>
                                                        @(isTurkish ? "Katsayƒ±" : "Coefficient"): <strong>@unit.Coefficient.ToString("0.00")</strong>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="unit-actions">
                                                <button class="unit-action-btn edit-btn" title="@(isTurkish ? "D√ºzenle" : "Edit")" onclick="editUnit(@unit.Id, '@Html.Raw(unit.Name.Replace("'", "\\'"))', @(unit.UnitTypeId?.ToString() ?? "null"), @unit.Coefficient, '@(unit.Color ?? "#3B82F6")', @unit.IsDefault.ToString().ToLower(), @unit.EmployeeLimit)">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                </button>
                                                <button class="unit-action-btn assign-btn" title="@(isTurkish ? "Personel Ata" : "Assign Employees")" onclick="openAssignEmployees(@unit.Id, '@Html.Raw(unit.Name.Replace("'", "\\'"))')">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                                </button>
                                                @if (empCount == 0)
                                                {
                                                    <button class="unit-action-btn delete-btn" title="@(isTurkish ? "Sil" : "Delete")" onclick="deleteUnit(@unit.Id)">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Unit Types Tab -->
                    <div class="tab-pane fade" id="unitTypesTab">
                        <div class="unit-types-section">
                            <!-- Add Unit Type Form -->
                            <div class="add-unit-form">
                                <div class="form-row">
                                    <input type="text" id="newUnitTypeName" class="form-input" placeholder="@(isTurkish ? "Tip adƒ±..." : "Type name...")">
                                    <input type="number" id="newUnitTypeCoefficient" class="form-input coefficient-input" value="1.0" step="0.25" min="0.5" max="3" placeholder="@(isTurkish ? "Varsayƒ±lan Katsayƒ±" : "Default Coefficient")">
                                    <input type="color" id="newUnitTypeColor" class="form-input color-input" value="#3B82F6">
                                    <button type="button" class="btn btn-primary" id="addUnitTypeBtn">
                                        <span class="btn-icon">+</span>
                                        @(isTurkish ? "Tip Ekle" : "Add Type")
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Unit Types List -->
                            <div class="unit-types-list" id="unitTypesList">
                                @if (Model.UnitTypes.Count == 0)
                                {
                                    <div class="empty-state">
                                        <span class="empty-icon">üìÅ</span>
                                        <p>@(isTurkish ? "Hen√ºz birim tipi eklenmemi≈ü" : "No unit types added yet")</p>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var ut in Model.UnitTypes)
                                    {
                                        var unitCount = Model.Units.Count(u => u.UnitTypeId == ut.Id);
                                        <div class="unit-type-card" data-unit-type-id="@ut.Id">
                                            <div class="unit-type-color" style="background-color: @(ut.Color ?? "#6B7280")"></div>
                                            <div class="unit-type-info">
                                                <h5 class="unit-type-name">
                                                    @ut.Name
                                                    @if (ut.IsSystem)
                                                    {
                                                        <span class="system-badge">@(isTurkish ? "Sistem" : "System")</span>
                                                    }
                                                </h5>
                                                <div class="unit-type-meta">
                                                    <span>@(isTurkish ? "Varsayƒ±lan Katsayƒ±" : "Default Coefficient"): <strong>@ut.DefaultCoefficient.ToString("0.00")</strong></span>
                                                    <span class="separator">‚Ä¢</span>
                                                    <span>@unitCount @(isTurkish ? "birim" : "units")</span>
                                                </div>
                                            </div>
                                            <div class="unit-type-actions">
                                                <button class="unit-action-btn edit-btn" title="@(isTurkish ? "D√ºzenle" : "Edit")" onclick="editUnitType(@ut.Id, '@Html.Raw(ut.Name.Replace("'", "\\'"))', @ut.DefaultCoefficient, '@(ut.Color ?? "#6B7280")')">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                </button>
                                                @if (!ut.IsSystem && unitCount == 0)
                                                {
                                                    <button class="unit-action-btn delete-btn" title="@(isTurkish ? "Sil" : "Delete")" onclick="deleteUnitType(@ut.Id)">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Unit Modal -->
<div class="modal fade" id="editUnitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <h5 class="modal-title">@(isTurkish ? "Birimi D√ºzenle" : "Edit Unit")</h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <input type="hidden" id="editUnitId">
                <div class="form-group">
                    <label>@(isTurkish ? "Birim Adƒ±" : "Unit Name")</label>
                    <input type="text" id="editUnitName" class="form-input">
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Birim Tipi" : "Unit Type")</label>
                    <select id="editUnitTypeId" class="form-select">
                        <option value="">@(isTurkish ? "Tip Se√ßilmedi" : "No Type Selected")</option>
                        @foreach (var ut in Model.UnitTypes)
                        {
                            <option value="@ut.Id" data-coefficient="@ut.DefaultCoefficient">@ut.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Katsayƒ±" : "Coefficient")</label>
                    <input type="number" id="editUnitCoefficient" class="form-input" step="0.25" min="0.5" max="3">
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Personel Limiti" : "Employee Limit") <small style="color: #6b7280;">(0 = @(isTurkish ? "Sƒ±nƒ±rsƒ±z" : "Unlimited"))</small></label>
                    <input type="number" id="editUnitEmployeeLimit" class="form-input" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Renk" : "Color")</label>
                    <input type="color" id="editUnitColor" class="form-input color-input">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editUnitIsDefault">
                        @(isTurkish ? "Varsayƒ±lan birim olarak i≈üaretle" : "Mark as default unit")
                    </label>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@(isTurkish ? "ƒ∞ptal" : "Cancel")</button>
                <button type="button" class="btn btn-primary" id="saveUnitBtn">@(isTurkish ? "Kaydet" : "Save")</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Unit Type Modal -->
<div class="modal fade" id="editUnitTypeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <h5 class="modal-title">@(isTurkish ? "Birim Tipini D√ºzenle" : "Edit Unit Type")</h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <input type="hidden" id="editUnitTypeId">
                <div class="form-group">
                    <label>@(isTurkish ? "Tip Adƒ±" : "Type Name")</label>
                    <input type="text" id="editUnitTypeName" class="form-input">
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Varsayƒ±lan Katsayƒ±" : "Default Coefficient")</label>
                    <input type="number" id="editUnitTypeCoefficient" class="form-input" step="0.25" min="0.5" max="3">
                </div>
                <div class="form-group">
                    <label>@(isTurkish ? "Renk" : "Color")</label>
                    <input type="color" id="editUnitTypeColor" class="form-input color-input">
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@(isTurkish ? "ƒ∞ptal" : "Cancel")</button>
                <button type="button" class="btn btn-primary" id="saveUnitTypeBtn">@(isTurkish ? "Kaydet" : "Save")</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Employees Modal -->
<div class="modal fade" id="assignEmployeesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <h5 class="modal-title">
                    <span id="assignUnitName"></span>
                    <small>@(isTurkish ? "- Personel Ata" : "- Assign Employees")</small>
                </h5>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <input type="hidden" id="assignUnitId">
                
                <!-- Assigned Employees -->
                <div class="assigned-section">
                    <h6>@(isTurkish ? "Bu Birimdeki Personeller" : "Employees in this Unit")</h6>
                    <div id="assignedEmployeesList" class="employee-chips"></div>
                </div>
                
                <!-- Available Employees -->
                <div class="available-section">
                    <h6>@(isTurkish ? "Atanabilir Personeller" : "Available Employees")</h6>
                    <div id="availableEmployeesList" class="employee-chips"></div>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@(isTurkish ? "Kapat" : "Close")</button>
            </div>
        </div>
    </div>
</div>
}

<!-- Employees Modal -->
<div class="modal fade" id="employeesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üë•</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Personel Y√∂netimi" : "Employee Management")</h5>
                    <p class="modal-subtitle">@Model.EmployeeCount / @Model.EmployeeLimit @(isTurkish ? "personel" : "employees")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <!-- Employee List -->
                <div class="employees-list-modal" id="employeeListModal">
                    @if (!Model.Employees.Any())
                    {
                        <div class="empty-employees">
                            <span>üë•</span>
                            <p>@(isTurkish ? "Hen√ºz personel eklenmedi" : "No employees added yet")</p>
                        </div>
                    }
                    @foreach (var employee in Model.Employees)
                    {
                        <div class="emp-row" data-employee-id="@employee.Id" data-daily-hours="@employee.DailyWorkHours" data-weekend-mode="@employee.WeekendWorkMode" data-saturday-hours="@(employee.SaturdayWorkHours ?? 0)">
                            <div class="emp-color" style="background: @(employee.Color ?? "#3B82F6")"></div>
                            <div class="emp-info">
                                <span class="emp-name">@employee.FullName</span>
                                @if (!string.IsNullOrEmpty(employee.Title))
                                {
                                    <span class="emp-title">@employee.Title</span>
                                }
                            </div>
                            <div class="emp-hours">@employee.DailyWorkHours @(isTurkish ? "s/g" : "h/d")</div>
                            <button class="emp-delete" data-id="@employee.Id" title="@(isTurkish ? "Sil" : "Delete")">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    }
                </div>
                
                @if (!Model.CanAddEmployee)
                {
                    <div class="limit-alert">
                        ‚ö†Ô∏è @(isTurkish ? "Personel limitine ula≈üƒ±ldƒ±. Daha fazla personel i√ßin kayƒ±t olun." : "Employee limit reached. Register for more.")
                    </div>
                }
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">@(isTurkish ? "Kapat" : "Close")</button>
                <button type="button" class="btn-modal-save" data-bs-toggle="modal" data-bs-target="#addEmployeeModal" @(Model.CanAddEmployee ? "" : "disabled")>
                    <span class="btn-icon">+</span> @(isTurkish ? "Personel Ekle" : "Add Employee")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üë§</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Yeni Personel Ekle" : "Add New Employee")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Personel bilgilerini girin" : "Enter employee information")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üìã</span>
                        @(isTurkish ? "Temel Bilgiler" : "Basic Information")
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="text" class="form-input" id="employeeFullName" placeholder=" " required>
                                <label>@(isTurkish ? "Ad Soyad" : "Full Name") *</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="text" class="form-input" id="employeeTitle" placeholder=" ">
                                <label>@(isTurkish ? "Unvan" : "Title")</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="text" class="form-input" id="employeeIdentityNo" placeholder=" ">
                                <label>@(isTurkish ? "Sicil No" : "ID Number")</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="employeeDailyHours" value="8" min="1" max="24" step="0.5" placeholder=" ">
                                <label>@(isTurkish ? "G√ºnl√ºk √áalƒ±≈üma (saat)" : "Daily Hours") *</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üèõÔ∏è</span>
                        @(isTurkish ? "Kadro Bilgileri" : "Position Information")
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <select class="form-input" id="employeePositionType" onchange="toggleAcademicTitle()">
                                    <option value="">@(isTurkish ? "Se√ßiniz..." : "Select...")</option>
                                    <option value="4A">4A (@(isTurkish ? "Memur" : "Civil Servant"))</option>
                                    <option value="4B">4B (@(isTurkish ? "S√∂zle≈ümeli" : "Contracted"))</option>
                                    <option value="4D">4D (696 KHK)</option>
                                    <option value="Academic">@(isTurkish ? "Akademik" : "Academic")</option>
                                </select>
                                <label>@(isTurkish ? "Kadro Tipi" : "Position Type")</label>
                            </div>
                        </div>
                        <div class="col-md-6" id="academicTitleGroup" style="display: none;">
                            <div class="form-floating-custom">
                                <select class="form-input" id="employeeAcademicTitle">
                                    <option value="">@(isTurkish ? "Se√ßiniz..." : "Select...")</option>
                                    <option value="Prof">@(isTurkish ? "Profes√∂r" : "Professor")</option>
                                    <option value="Do√ßent">@(isTurkish ? "Do√ßent" : "Associate Prof.")</option>
                                    <option value="Dr. √ñƒüretim √úyesi">@(isTurkish ? "Dr. √ñƒüretim √úyesi" : "Assistant Prof.")</option>
                                    <option value="Ara≈ütƒ±rma G√∂revlisi">@(isTurkish ? "Ara≈ütƒ±rma G√∂revlisi" : "Research Asst.")</option>
                                    <option value="Ara≈ütƒ±rma G√∂revlisi (Dr.)">@(isTurkish ? "Ara≈ütƒ±rma G√∂revlisi (Dr.)" : "Research Asst. (PhD)")</option>
                                </select>
                                <label>@(isTurkish ? "Akademik Unvan" : "Academic Title")</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="employeeShiftScore" value="100" min="0" max="1000" step="1" placeholder=" ">
                                <label>@(isTurkish ? "N√∂bet Puanƒ±" : "Shift Score")</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="checkbox-wrapper">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="employeeIsNonHealthServices">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "SH Dƒ±≈üƒ± (Saƒülƒ±k Hizmetleri Sƒ±nƒ±fƒ± Dƒ±≈üƒ±)" : "Non-Health Services Class")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-title">
                        <span class="section-icon">üìÖ</span>
                        @(isTurkish ? "Hafta Sonu Ayarlarƒ±" : "Weekend Settings")
                    </div>
                    <div class="weekend-options">
                        <label class="weekend-option">
                            <input type="radio" name="weekendMode" value="0" checked onchange="document.getElementById('employeeWeekendMode').value='0'; document.getElementById('saturdayHoursGroup').style.display='none';">
                            <span class="option-card">
                                <span class="option-icon">üö´</span>
                                <span class="option-text">@(isTurkish ? "Hafta sonu √ßalƒ±≈ümaz" : "No weekends")</span>
                            </span>
                        </label>
                        <label class="weekend-option">
                            <input type="radio" name="weekendMode" value="1" onchange="document.getElementById('employeeWeekendMode').value='1'; document.getElementById('saturdayHoursGroup').style.display='none';">
                            <span class="option-card">
                                <span class="option-icon">‚úÖ</span>
                                <span class="option-text">@(isTurkish ? "Cmt + Paz √ßalƒ±≈üƒ±r" : "Sat + Sun")</span>
                            </span>
                        </label>
                        <label class="weekend-option">
                            <input type="radio" name="weekendMode" value="2" onchange="document.getElementById('employeeWeekendMode').value='2'; document.getElementById('saturdayHoursGroup').style.display='none';">
                            <span class="option-card">
                                <span class="option-icon">üìÜ</span>
                                <span class="option-text">@(isTurkish ? "Sadece Cumartesi" : "Saturday only")</span>
                            </span>
                        </label>
                        <label class="weekend-option">
                            <input type="radio" name="weekendMode" value="3" onchange="document.getElementById('employeeWeekendMode').value='3'; document.getElementById('saturdayHoursGroup').style.display='block';">
                            <span class="option-card">
                                <span class="option-icon">‚è±Ô∏è</span>
                                <span class="option-text">@(isTurkish ? "√ñzel saat" : "Custom hours")</span>
                            </span>
                        </label>
                    </div>
                    <select class="d-none" id="employeeWeekendMode">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                    <div class="saturday-hours-input" id="saturdayHoursGroup" style="display: none;">
                        <div class="form-floating-custom">
                            <input type="number" class="form-input" id="employeeSaturdayHours" value="4" min="1" max="24" step="0.5" placeholder=" ">
                            <label>@(isTurkish ? "Cumartesi Saat" : "Saturday Hours")</label>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <span class="info-icon">üí°</span>
                    <div class="info-content">
                        <strong>@(isTurkish ? "Otomatik Hesaplama" : "Auto Calculation")</strong>
                        <p>@(isTurkish ? "Resmi tatiller ve izinler otomatik olarak √ßalƒ±≈üma s√ºresinden d√º≈ü√ºl√ºr." : "Holidays and leaves are automatically deducted from work hours.")</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">
                    @(isTurkish ? "ƒ∞ptal" : "Cancel")
                </button>
                <button type="button" class="btn-modal-save" id="saveEmployeeBtn">
                    <span class="btn-icon">‚úì</span>
                    @(isTurkish ? "Personel Ekle" : "Add Employee")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Templates Modal -->
@if (Model.IsRegistered)
{
<div class="modal fade" id="manageTemplatesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom templates-modal-header">
                <div class="modal-icon">‚è∞</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Vardiya ≈ûablonlarƒ±" : "Shift Templates")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Kendi √∂zel vardiya ≈üablonlarƒ±nƒ±zƒ± olu≈üturun ve y√∂netin" : "Create and manage your custom shift templates")</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body-custom">
                <!-- Template List -->
                <div class="template-manager-list" id="templateManagerList">
                    <div class="template-loading">@(isTurkish ? "Y√ºkleniyor..." : "Loading...")</div>
                </div>
                
                <!-- Add New Template Form -->
                <div class="template-add-form" id="templateAddForm">
                    <h6 class="form-section-title">@(isTurkish ? "Yeni ≈ûablon Ekle" : "Add New Template")</h6>
                    <div class="template-form-grid">
                        <div class="form-group">
                            <label>@(isTurkish ? "≈ûablon Adƒ±" : "Template Name")</label>
                            <input type="text" id="newTemplateName" class="form-control" placeholder="@(isTurkish ? "√∂rn: Sabah Vardiyasƒ±" : "e.g. Morning Shift")">
                        </div>
                        <div class="form-group">
                            <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                            <input type="time" id="newTemplateStart" class="form-control" value="08:00">
                        </div>
                        <div class="form-group">
                            <label>@(isTurkish ? "Biti≈ü" : "End")</label>
                            <input type="time" id="newTemplateEnd" class="form-control" value="17:00">
                        </div>
                        <div class="form-group">
                            <label>@(isTurkish ? "Mola (dk)" : "Break (min)")</label>
                            <input type="number" id="newTemplateBreak" class="form-control" value="60" min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label>@(isTurkish ? "Renk" : "Color")</label>
                            <input type="color" id="newTemplateColor" class="form-control form-control-color" value="#3B82F6">
                        </div>
                        <div class="form-group form-check-group">
                            <label class="form-check">
                                <input type="checkbox" id="newTemplateSpans" class="form-check-input">
                                <span>@(isTurkish ? "Ertesi g√ºne sarkar (+1)" : "Spans next day (+1)")</span>
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn-add-template" id="addNewTemplateBtn">
                        <span>‚ûï</span> @(isTurkish ? "≈ûablon Ekle" : "Add Template")
                    </button>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">
                    @(isTurkish ? "Kapat" : "Close")
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Templates Selection Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom templates-modal-header">
                <div class="modal-icon">‚è∞</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Vardiya ≈ûablonlarƒ±" : "Shift Templates")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Bir vardiya ≈üablonu se√ßin" : "Select a shift template")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <div class="template-list-modal" id="templateListModal">
                    <div id="templatesContainerModal">
                        <div class="template-loading">@(isTurkish ? "Y√ºkleniyor..." : "Loading...")</div>
                    </div>
                    
                    <!-- Separator and special buttons -->
                    <div class="tpl-divider"></div>
                    <button class="tpl-btn-row day-off" data-start="00:00" data-end="00:00" data-spans="false" data-break="0" data-color="#94a3b8" data-day-off="true">
                        <span class="tpl-color" style="background:#94a3b8"></span>
                        <span class="tpl-info">
                            <span class="tpl-time">üö´ @(isTurkish ? "Bo≈ü G√ºn" : "Day Off")</span>
                        </span>
                    </button>
                    <button class="tpl-btn-row custom" id="customTimeBtnModal" data-color="#64748B">
                        <span class="tpl-color" style="background:#64748B"></span>
                        <span class="tpl-info">
                            <span class="tpl-time">‚è±Ô∏è @(isTurkish ? "√ñzel Saat" : "Custom Time")</span>
                        </span>
                    </button>
                </div>
                @if (Model.IsRegistered)
                {
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#manageTemplatesModal" data-bs-dismiss="modal" style="width: 100%; justify-content: center;">
                            <span class="action-icon">‚öôÔ∏è</span>
                            <span class="action-label">@(isTurkish ? "≈ûablonlarƒ± Y√∂net" : "Manage Templates")</span>
                        </button>
                    </div>
                }
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">@(isTurkish ? "Kapat" : "Close")</button>
            </div>
        </div>
    </div>
</div>

<!-- Leaves Selection Modal -->
<div class="modal fade" id="leavesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üìã</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "ƒ∞zinler" : "Leaves")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Bir izin tipi se√ßin" : "Select a leave type")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <div class="leave-list-modal" id="leaveListModal" style="max-height: 500px; overflow-y: auto;">
                    @foreach (var category in Model.LeaveTypes.GroupBy(lt => lt.Category).OrderBy(g => g.First().SortOrder))
                    {
                        var categoryName = category.Key switch
                        {
                            "annual" => isTurkish ? "Yƒ±llƒ±k ƒ∞zinler" : "Annual Leaves",
                            "maternity" => isTurkish ? "Analƒ±k/Babalƒ±k" : "Maternity/Paternity",
                            "health" => isTurkish ? "Saƒülƒ±k ƒ∞zinleri" : "Health Leaves",
                            "excuse" => isTurkish ? "Mazeret ƒ∞zinleri" : "Excuse Leaves",
                            "education" => isTurkish ? "Eƒüitim/Sƒ±nav" : "Education",
                            "military" => isTurkish ? "Askerlik" : "Military",
                            "administrative" => isTurkish ? "ƒ∞dari ƒ∞zinler" : "Administrative",
                            "unpaid" => isTurkish ? "√úcretsiz ƒ∞zin" : "Unpaid Leave",
                            _ => isTurkish ? "Diƒüer" : "Other"
                        };
                        <div class="leave-category-modal">
                            <div class="leave-category-name-modal">@categoryName</div>
                            <div class="leave-buttons-grid">
                                @foreach (var leaveType in category.OrderBy(lt => lt.SortOrder))
                                {
                                    <button class="leave-btn-modal" data-leave-id="@leaveType.Id" data-leave-code="@(isTurkish ? leaveType.Code : leaveType.CodeEn)" data-leave-color="@leaveType.Color">
                                        <span class="leave-color-modal" style="background:@leaveType.Color"></span>
                                        <div class="leave-content-modal">
                                            <span class="leave-code-modal">@(isTurkish ? leaveType.Code : leaveType.CodeEn)</span>
                                            <span class="leave-name-modal">@(isTurkish ? leaveType.NameTr : leaveType.NameEn)</span>
                                        </div>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">@(isTurkish ? "Kapat" : "Close")</button>
            </div>
        </div>
    </div>
</div>
 
<!-- Add Holiday Modal -->
<div class="modal fade" id="addHolidayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom holiday-header">
                <div class="modal-icon">üóìÔ∏è</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Tatil Y√∂netimi" : "Holiday Management")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Tatilleri ekleyin, d√ºzenleyin veya silin" : "Add, edit or delete holidays")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <!-- Existing Holidays List -->
                <div class="holidays-list-section" id="holidaysListSection">
                    <h6 class="section-title">@(isTurkish ? "Mevcut Tatiller" : "Current Holidays")</h6>
                    <div class="holidays-list" id="holidaysList">
                        <div class="holiday-loading">@(isTurkish ? "Y√ºkleniyor..." : "Loading...")</div>
                    </div>
                </div>
                
                <div class="holiday-divider"></div>
                
                <!-- Add New Holiday Form -->
                <div class="form-section">
                    <h6 class="section-title">@(isTurkish ? "Yeni Tatil Ekle" : "Add New Holiday")</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="date" class="form-input" id="holidayDate" required placeholder=" ">
                                <label>@(isTurkish ? "Tarih" : "Date") *</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-custom">
                                <input type="text" class="form-input" id="holidayName" placeholder=" " required>
                                <label>@(isTurkish ? "Tatil Adƒ±" : "Holiday Name") *</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="holiday-type-options">
                                <label class="type-option">
                                    <input type="radio" name="holidayTypeRadio" value="0" checked onchange="document.getElementById('holidayType').value='0';">
                                    <span class="type-card official">
                                        <span class="type-icon">üèõÔ∏è</span>
                                        <span class="type-label">@(isTurkish ? "Resmi Tatil" : "Public Holiday")</span>
                                    </span>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="holidayTypeRadio" value="1" onchange="document.getElementById('holidayType').value='1';">
                                    <span class="type-card administrative">
                                        <span class="type-icon">üìã</span>
                                        <span class="type-label">@(isTurkish ? "ƒ∞dari Tatil" : "Administrative")</span>
                                    </span>
                                </label>
                            </div>
                            <select class="d-none" id="holidayType">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="half-day-section">
                                <label class="half-day-toggle">
                                    <input type="checkbox" id="isHalfDay" onchange="toggleHalfDayOptions()">
                                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                                    <span class="toggle-label">@(isTurkish ? "Yarƒ±m G√ºn Tatil" : "Half-Day Holiday")</span>
                                </label>
                                <div class="half-day-options" id="halfDayOptions" style="display:none;">
                                    <div class="form-floating-custom">
                                        <input type="number" class="form-input" id="halfDayWorkHours" value="4" min="1" max="8" step="0.5" placeholder=" ">
                                        <label>@(isTurkish ? "√áalƒ±≈üma Saati" : "Work Hours")</label>
                                    </div>
                                    <p class="half-day-hint">@(isTurkish ? "Yarƒ±m g√ºn tatilde personelin √ßalƒ±≈ümasƒ± gereken saat" : "Hours employee should work on half-day")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">
                    @(isTurkish ? "Kapat" : "Close")
                </button>
                <button type="button" class="btn-modal-save holiday" id="saveHolidayBtn">
                    <span class="btn-icon">‚úì</span>
                    @(isTurkish ? "Tatil Ekle" : "Add Holiday")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Smart Generate Modal - Fullscreen -->
@if (Model.CanUseSmartScheduling)
{
<div class="modal fade sg-modal-fullscreen" id="smartGenerateModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content sg-modal-content">
            <!-- Animated Background -->
            <div class="sg-bg-pattern"></div>
            
            <!-- Header -->
            <div class="sg-modal-header">
                <div class="sg-header-left">
                    <div class="sg-header-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                            <circle cx="12" cy="12" r="4"/>
                        </svg>
                    </div>
                    <div class="sg-header-text">
                        <h2>@(isTurkish ? "Akƒ±llƒ± √áizelge Olu≈üturucu" : "Smart Schedule Generator")</h2>
                        <p>@Model.MonthName @(isTurkish ? "i√ßin otomatik n√∂bet ve mesai planƒ±" : "automatic shift and work schedule")</p>
                    </div>
                </div>
                <button type="button" class="sg-close-btn" data-bs-dismiss="modal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Warning Banner -->
            <div class="sg-warning-banner">
                <div class="sg-warning-icon">‚ö†Ô∏è</div>
                <div class="sg-warning-text">
                    <strong>@(isTurkish ? "Dikkat!" : "Warning!")</strong>
                    @(isTurkish ? "Bu i≈ülem, se√ßili aydaki T√úM mevcut vardiyalarƒ± silecek ve yeni √ßizelge olu≈üturacaktƒ±r." : "This will DELETE ALL existing shifts for the selected month and create a new schedule.")
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="sg-modal-body">
                <!-- Step 1: Weekday Work Hours -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">1</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Hafta ƒ∞√ßi Mesai Saatleri" : "Weekday Work Hours")</h6>
                            <p>@(isTurkish ? "Varsayƒ±lan mesai saatlerini belirleyin" : "Set default work hours")</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekdayStart" value="08:00">
                                <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekdayEnd" value="17:00">
                                <label>@(isTurkish ? "Biti≈ü" : "End")</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgWeekdayBreak" value="60" min="0" max="120" step="5">
                                <label>@(isTurkish ? "Mola (dk)" : "Break (min)")</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgApplyWeekday" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "Uygula" : "Apply")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Weekend Settings -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">2</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Hafta Sonu √áalƒ±≈üma" : "Weekend Work")</h6>
                            <p>@(isTurkish ? "Hafta sonlarƒ± minimum personel ve saat belirleyin" : "Set minimum staff and hours for weekends")</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgWeekendMinStaff" value="1" min="0" max="50">
                                <label>@(isTurkish ? "Min. Personel" : "Min Staff")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekendStart" value="08:00">
                                <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekendEnd" value="17:00">
                                <label>@(isTurkish ? "Biti≈ü" : "End")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgWeekendBreak" value="60" min="0" max="120" step="5">
                                <label>@(isTurkish ? "Mola (dk)" : "Break (min)")</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgApplyWeekend" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "Hafta sonu √ßalƒ±≈üma uygula" : "Apply weekend work")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Weekday Duty (N√∂bet) -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">3</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Hafta ƒ∞√ßi N√∂bet" : "Weekday Duty")</h6>
                            <p>@(isTurkish ? "Her g√ºn ka√ß personel n√∂bet tutacak?" : "How many staff on duty each day?")</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgWeekdayDutyMin" value="1" min="0" max="50">
                                <label>@(isTurkish ? "Min. N√∂bet√ßi" : "Min On-Duty")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekdayDutyStart" value="17:00">
                                <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgWeekdayDutyEnd" value="08:00">
                                <label>@(isTurkish ? "Biti≈ü" : "End")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgWeekdayDutyBreak" value="0" min="0" max="120" step="5">
                                <label>@(isTurkish ? "Mola (dk)" : "Break (min)")</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgApplyWeekdayDuty" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "Hafta i√ßi n√∂bet uygula" : "Apply weekday duty")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="info-box mini mt-2">
                        <span class="info-icon">üí°</span>
                        <span>@(isTurkish ? "Biti≈ü saati ba≈ülangƒ±√ßtan k√º√ß√ºkse ertesi g√ºne ge√ßer (gece n√∂beti)" : "If end time is before start, it spans to next day (night shift)")</span>
                    </div>
                </div>

                <!-- Step 4: Holiday Duty -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">4</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Resmi Tatil N√∂beti" : "Holiday Duty")</h6>
                            <p>@(isTurkish ? "Resmi tatillerde n√∂bet ayarlarƒ±" : "Duty settings for holidays")</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgHolidayDutyMin" value="1" min="0" max="50">
                                <label>@(isTurkish ? "Min. N√∂bet√ßi" : "Min On-Duty")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgHolidayDutyStart" value="08:00">
                                <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="time" class="form-input" id="sgHolidayDutyEnd" value="08:00">
                                <label>@(isTurkish ? "Biti≈ü" : "End")</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgHolidayDutyBreak" value="0" min="0" max="120" step="5">
                                <label>@(isTurkish ? "Mola (dk)" : "Break (min)")</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="checkbox-wrapper" style="margin-top: 10px;">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgApplyHolidayDuty" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "Tatil n√∂beti uygula" : "Apply holiday duty")</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Exempt Employees -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">5</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "N√∂bet Tutmayan Personeller" : "Exempt from Duty")</h6>
                            <p>@(isTurkish ? "Bu personeller hi√ßbir zaman n√∂bete yazƒ±lmaz" : "These employees are never assigned to duty")</p>
                        </div>
                    </div>
                    <div class="exempt-employees-list" id="sgExemptEmployeesList">
                        @foreach (var emp in Model.Employees.Where(e => e.IsActive).OrderBy(e => e.FullName))
                        {
                            <label class="exempt-employee-item">
                                <input type="checkbox" class="sg-exempt-employee" value="@emp.Id">
                                <span class="exempt-name">@emp.FullName</span>
                                @if (!string.IsNullOrEmpty(emp.Title))
                                {
                                    <span class="exempt-title">@emp.Title</span>
                                }
                            </label>
                        }
                    </div>
                </div>

                <!-- Step 6: Specific Date Restrictions -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">6</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Tarih Bazlƒ± Kƒ±sƒ±tlamalar" : "Date-Based Restrictions")</h6>
                            <p>@(isTurkish ? "Belirli tarihlerde n√∂bet tutamayacak personeller" : "Employees unavailable on specific dates")</p>
                        </div>
                    </div>
                    <div class="date-restrictions-container">
                        <div class="date-restriction-add">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <div class="form-floating-custom">
                                        <select class="form-input" id="sgRestrictionEmployee">
                                            <option value="">@(isTurkish ? "Personel se√ß..." : "Select employee...")</option>
                                            @foreach (var emp in Model.Employees.Where(e => e.IsActive).OrderBy(e => e.FullName))
                                            {
                                                <option value="@emp.Id">@emp.FullName</option>
                                            }
                                        </select>
                                        <label>@(isTurkish ? "Personel" : "Employee")</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating-custom">
                                        <input type="date" class="form-input" id="sgRestrictionStartDate">
                                        <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start Date")</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating-custom">
                                        <input type="date" class="form-input" id="sgRestrictionEndDate">
                                        <label>@(isTurkish ? "Biti≈ü" : "End Date")</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn-add-restriction" id="sgAddRestriction">
                                        <span>+</span> @(isTurkish ? "Ekle" : "Add")
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="date-restrictions-list" id="sgRestrictionsList">
                            <!-- Dynamically added restrictions will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Step 7: Specific Date Availability -->
                <div class="smart-section">
                    <div class="section-header">
                        <span class="section-number">7</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "N√∂bet Tercih Tarihleri" : "Duty Preference Dates")</h6>
                            <p>@(isTurkish ? "Belirli tarihlerde n√∂bet tutabilecek/isteyenler" : "Employees available/preferred on specific dates")</p>
                        </div>
                    </div>
                    <div class="date-restrictions-container">
                        <div class="date-restriction-add">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <div class="form-floating-custom">
                                        <select class="form-input" id="sgPreferenceEmployee">
                                            <option value="">@(isTurkish ? "Personel se√ß..." : "Select employee...")</option>
                                            @foreach (var emp in Model.Employees.Where(e => e.IsActive).OrderBy(e => e.FullName))
                                            {
                                                <option value="@emp.Id">@emp.FullName</option>
                                            }
                                        </select>
                                        <label>@(isTurkish ? "Personel" : "Employee")</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating-custom">
                                        <input type="date" class="form-input" id="sgPreferenceStartDate">
                                        <label>@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start Date")</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating-custom">
                                        <input type="date" class="form-input" id="sgPreferenceEndDate">
                                        <label>@(isTurkish ? "Biti≈ü" : "End Date")</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn-add-restriction preference" id="sgAddPreference">
                                        <span>+</span> @(isTurkish ? "Ekle" : "Add")
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="date-restrictions-list preferences" id="sgPreferencesList">
                            <!-- Dynamically added preferences will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="smart-section options">
                    <div class="section-header">
                        <span class="section-number">‚öôÔ∏è</span>
                        <div class="section-info">
                            <h6>@(isTurkish ? "Ek Ayarlar" : "Additional Options")</h6>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="checkbox-wrapper">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgOverwriteExisting">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "Mevcut vardiyalarƒ± √ºzerine yaz" : "Overwrite existing shifts")</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="checkbox-wrapper">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="sgBalanceDuties" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">@(isTurkish ? "N√∂betleri adil daƒüƒ±t" : "Balance duties fairly")</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating-custom">
                                <input type="number" class="form-input" id="sgMinDaysBetweenDuties" value="2" min="0" max="14">
                                <label>@(isTurkish ? "N√∂betler arasƒ± min. g√ºn" : "Min days between duties")</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress indicator -->
                <div class="sg-progress-section" id="sgProgress" style="display: none;">
                    <div class="sg-progress-card">
                        <div class="sg-progress-icon">
                            <div class="sg-spinner"></div>
                        </div>
                        <div class="sg-progress-info">
                            <h4 id="sgProgressText">@(isTurkish ? "√áizelge olu≈üturuluyor..." : "Generating schedule...")</h4>
                            <div class="sg-progress-bar-wrap">
                                <div class="sg-progress-bar" id="sgProgressBar"></div>
                            </div>
                            <p class="sg-progress-hint">@(isTurkish ? "Bu i≈ülem birka√ß saniye s√ºrebilir" : "This may take a few seconds")</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="sg-modal-footer">
                <div class="sg-footer-info">
                    <span class="sg-employee-count">üë• @Model.Employees.Count(e => e.IsActive) @(isTurkish ? "aktif personel" : "active employees")</span>
                    <span class="sg-day-count">üìÖ @Model.DaysInMonth @(isTurkish ? "g√ºn" : "days")</span>
                </div>
                <div class="sg-footer-actions">
                    <button type="button" class="sg-btn-cancel" data-bs-dismiss="modal">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                        @(isTurkish ? "ƒ∞ptal" : "Cancel")
                    </button>
                    <button type="button" class="sg-btn-generate" id="sgGenerateBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        @(isTurkish ? "√áizelge Olu≈ütur" : "Generate Schedule")
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="sgConfirmModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content sg-confirm-modal">
            <div class="sg-confirm-icon">üóëÔ∏è</div>
            <h3>@(isTurkish ? "Emin misiniz?" : "Are you sure?")</h3>
            <p>@(isTurkish ? "Bu i≈ülem geri alƒ±namaz! T√ºm mevcut vardiyalar silinecek ve yeni √ßizelge olu≈üturulacak." : "This cannot be undone! All existing shifts will be deleted and a new schedule will be created.")</p>
            <div class="sg-confirm-details">
                <div class="sg-confirm-item">
                    <span class="sg-confirm-label">@(isTurkish ? "Ay" : "Month"):</span>
                    <span class="sg-confirm-value">@Model.MonthName</span>
                </div>
                <div class="sg-confirm-item">
                    <span class="sg-confirm-label">@(isTurkish ? "Silinecek" : "To delete"):</span>
                    <span class="sg-confirm-value sg-delete-count">@Model.Shifts.Count @(isTurkish ? "vardiya" : "shifts")</span>
                </div>
            </div>
            <div class="sg-confirm-actions">
                <button type="button" class="sg-btn-cancel-confirm" data-bs-dismiss="modal">
                    @(isTurkish ? "Vazge√ß" : "Cancel")
                </button>
                <button type="button" class="sg-btn-confirm-delete" id="sgConfirmGenerate">
                    @(isTurkish ? "Evet, Olu≈ütur" : "Yes, Generate")
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== Smart Generate Fullscreen Modal ===== */
    .sg-modal-fullscreen .modal-fullscreen {
        padding: 0;
    }
    
    .sg-modal-content {
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d0d1f 100%);
        min-height: 100vh;
        position: relative;
        overflow: hidden;
    }
    
    /* Animated background pattern */
    .sg-bg-pattern {
        position: absolute;
        inset: 0;
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
        animation: sgBgPulse 10s ease-in-out infinite;
    }
    
    @@keyframes sgBgPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Header */
    .sg-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 32px;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        position: relative;
        z-index: 1;
    }
    
    .sg-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .sg-header-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.4);
        animation: sgIconFloat 3s ease-in-out infinite;
    }
    
    @@keyframes sgIconFloat {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }
    
    .sg-header-text h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: -0.02em;
    }
    
    .sg-header-text p {
        margin: 4px 0 0;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .sg-close-btn {
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .sg-close-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #ef4444;
    }
    
    /* Warning Banner */
    .sg-warning-banner {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 0 32px;
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(234, 88, 12, 0.1) 100%);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        position: relative;
        z-index: 1;
    }
    
    .sg-warning-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .sg-warning-text {
        color: #fbbf24;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .sg-warning-text strong {
        color: #f59e0b;
    }
    
    /* Main Body */
    .sg-modal-body {
        padding: 24px 32px;
        overflow-y: auto;
        max-height: calc(100vh - 240px);
        position: relative;
        z-index: 1;
    }
    
    /* Section Cards */
    .smart-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        transition: all 0.3s;
    }
    
    .smart-section:hover {
        border-color: rgba(139, 92, 246, 0.3);
        background: rgba(255, 255, 255, 0.05);
    }
    
    .smart-section.options {
        background: rgba(234, 179, 8, 0.05);
        border-color: rgba(234, 179, 8, 0.2);
    }
    
    .section-header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .section-number {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        flex-shrink: 0;
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
    }
    
    .section-info h6 {
        margin: 0;
        font-weight: 600;
        font-size: 1.05rem;
        color: #fff;
    }
    
    .section-info p {
        margin: 4px 0 0;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
    }
    
    /* Form inputs in modal */
    .sg-modal-body .form-floating-custom {
        position: relative;
    }
    
    .sg-modal-body .form-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #fff;
        border-radius: 10px;
    }
    
    .sg-modal-body .form-input:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }
    
    .sg-modal-body .form-floating-custom label {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Checkbox styling */
    .sg-modal-body .checkbox-label {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .sg-modal-body .checkmark {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .sg-modal-body .custom-checkbox input:checked ~ .checkmark {
        background: #8b5cf6;
        border-color: #8b5cf6;
    }
    
    /* Exempt employees list */
    .exempt-employees-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 180px;
        overflow-y: auto;
        padding: 4px;
    }
    
    .exempt-employee-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .exempt-employee-item:hover {
        border-color: #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
    }
    
    .exempt-employee-item input:checked + .exempt-name {
        color: #a78bfa;
        font-weight: 600;
    }
    
    .exempt-employee-item input {
        width: 18px;
        height: 18px;
        accent-color: #8b5cf6;
    }
    
    .exempt-name {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .exempt-title {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.1);
        padding: 3px 8px;
        border-radius: 6px;
    }
    
    /* Date restrictions */
    .date-restrictions-container {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
    }
    
    .btn-add-restriction {
        width: 100%;
        padding: 12px 18px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-add-restriction:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }
    
    .btn-add-restriction.preference {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    
    .btn-add-restriction.preference:hover {
        box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
    }
    
    .date-restrictions-list {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 180px;
        overflow-y: auto;
    }
    
    .date-restrictions-list:empty {
        display: none;
    }
    
    .restriction-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
    }
    
    .restriction-item.preference {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
    }
    
    .restriction-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }
    
    .restriction-employee {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .restriction-dates {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 10px;
        border-radius: 6px;
    }
    
    .restriction-remove {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #f87171;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .restriction-remove:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .info-box.mini {
        padding: 10px 14px;
        font-size: 0.85rem;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .info-box.mini .info-icon {
        font-size: 1.1rem;
    }
    
    /* Footer */
    .sg-modal-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 32px;
        border-top: 1px solid rgba(139, 92, 246, 0.2);
        background: rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 1;
    }
    
    .sg-footer-info {
        display: flex;
        gap: 24px;
    }
    
    .sg-footer-info span {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
    }
    
    .sg-footer-actions {
        display: flex;
        gap: 12px;
    }
    
    .sg-btn-cancel {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .sg-btn-cancel:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .sg-btn-generate {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 32px;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        border: none;
        color: white;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
    }
    
    .sg-btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(139, 92, 246, 0.5);
    }
    
    .sg-btn-generate:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Progress Section */
    .sg-progress-section {
        margin-top: 24px;
    }
    
    .sg-progress-card {
        display: flex;
        align-items: center;
        gap: 24px;
        padding: 24px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 16px;
    }
    
    .sg-progress-icon {
        flex-shrink: 0;
    }
    
    .sg-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(139, 92, 246, 0.2);
        border-top-color: #8b5cf6;
        border-radius: 50%;
        animation: sgSpin 1s linear infinite;
    }
    
    @@keyframes sgSpin {
        to { transform: rotate(360deg); }
    }
    
    .sg-progress-info {
        flex: 1;
    }
    
    .sg-progress-info h4 {
        margin: 0 0 12px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #a78bfa;
    }
    
    .sg-progress-bar-wrap {
        height: 8px;
        background: rgba(139, 92, 246, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .sg-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .sg-progress-hint {
        margin: 8px 0 0;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
    }
    
    /* Confirmation Modal */
    .sg-confirm-modal {
        background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 20px;
        padding: 32px;
        text-align: center;
    }
    
    .sg-confirm-icon {
        font-size: 3rem;
        margin-bottom: 16px;
    }
    
    .sg-confirm-modal h3 {
        margin: 0 0 12px;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
    }
    
    .sg-confirm-modal > p {
        margin: 0 0 24px;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.6;
    }
    
    .sg-confirm-details {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .sg-confirm-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
    }
    
    .sg-confirm-item:not(:last-child) {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sg-confirm-label {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .sg-confirm-value {
        color: #fff;
        font-weight: 600;
    }
    
    .sg-delete-count {
        color: #f87171;
    }
    
    .sg-confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }
    
    .sg-btn-cancel-confirm {
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .sg-btn-cancel-confirm:hover {
        background: rgba(255, 255, 255, 0.15);
    }
    
    .sg-btn-confirm-delete {
        padding: 12px 24px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        color: white;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
    }
    
    .sg-btn-confirm-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.5);
    }
    
    /* Two column layout for sections */
    .sg-two-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    @@media (max-width: 992px) {
        .sg-two-columns {
            grid-template-columns: 1fr;
        }
        
        .sg-modal-header {
            padding: 16px 20px;
        }
        
        .sg-modal-body {
            padding: 16px 20px;
        }
        
        .sg-modal-footer {
            flex-direction: column;
            gap: 16px;
            padding: 16px 20px;
        }
        
        .sg-footer-actions {
            width: 100%;
        }
        
        .sg-btn-cancel, .sg-btn-generate {
            flex: 1;
            justify-content: center;
        }
    }
    
    /* Scrollbar for dark theme */
    .sg-modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .sg-modal-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }
    
    .sg-modal-body::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.4);
        border-radius: 4px;
    }
    
    .sg-modal-body::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.6);
    }
    
</style>
}

<!-- Premium Feature Modal -->
<div class="premium-modal-overlay" id="premiumModal">
    <div class="premium-modal">
        <div class="premium-modal-header">
            <div class="icon">üîí</div>
            <h3>@(isTurkish ? "Premium √ñzellik" : "Premium Feature")</h3>
            <p>@(isTurkish ? "Bu √∂zellik kayƒ±tlƒ± kullanƒ±cƒ±lar i√ßin" : "This feature is for registered users")</p>
        </div>
        <div class="premium-modal-body">
            <ul class="premium-features">
                <li>@(isTurkish ? "10 personele kadar y√∂netim" : "Manage up to 10 employees")</li>
                <li>@(isTurkish ? "Akƒ±llƒ± n√∂bet planlamasƒ±" : "Smart shift scheduling")</li>
                <li>@(isTurkish ? "Puantaj ve mesai hesaplama" : "Timesheet and overtime calculation")</li>
                <li>@(isTurkish ? "Excel export" : "Excel export")</li>
                <li>@(isTurkish ? "N√∂bet listelerini kaydetme" : "Save shift schedules")</li>
                <li>@(isTurkish ? "Verileriniz g√ºvende kalƒ±r" : "Your data stays safe")</li>
            </ul>
        </div>
        <div class="premium-modal-footer">
            <button class="btn-premium-close" onclick="closePremiumModal()">
                @(isTurkish ? "Kapat" : "Close")
            </button>
            <a href="/Account/Register?returnUrl=/app" class="btn-premium-register">
                @(isTurkish ? "√úcretsiz Kayƒ±t Ol" : "Sign Up Free")
            </a>
        </div>
    </div>
</div>

@if (Model.IsRegistered)
{
<!-- Saved Schedules Modal -->
<div class="modal fade" id="savedSchedulesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üìã</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Kayƒ±tlƒ± N√∂bet Listeleri" : "Saved Schedules")</h5>
                    <p class="modal-subtitle">@Model.MonthName - @(isTurkish ? "i√ßin kayƒ±tlƒ± listeler" : "saved schedules")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <!-- Save Current Schedule Section -->
                <div class="saved-schedule-section">
                    <h6 class="section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
                        @(isTurkish ? "Mevcut Listeyi Kaydet" : "Save Current Schedule")
                    </h6>
                    <div class="save-schedule-form">
                        <input type="text" id="scheduleNameInput" class="form-input" placeholder="@(isTurkish ? "Liste adƒ± (√∂rn: Ocak Final)" : "Schedule name (e.g., January Final)")">
                        <input type="text" id="scheduleDescInput" class="form-input" placeholder="@(isTurkish ? "A√ßƒ±klama (isteƒüe baƒülƒ±)" : "Description (optional)")" style="margin-top: 8px;">
                        <button class="btn-save-schedule" id="saveScheduleBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
                            @(isTurkish ? "Kaydet" : "Save")
                        </button>
                    </div>
                </div>
                
                <hr class="section-divider">
                
                <!-- Saved Schedules List -->
                <div class="saved-schedule-section">
                    <h6 class="section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
                        @(isTurkish ? "Kayƒ±tlƒ± Listeler" : "Saved Schedules")
                    </h6>
                    <div class="saved-schedules-filter">
                        <label>
                            <input type="checkbox" id="filterCurrentMonthOnly" checked>
                            @(isTurkish ? "Sadece bu ay" : "This month only")
                        </label>
                    </div>
                    <div id="savedSchedulesList" class="saved-schedules-list">
                        <div class="loading-placeholder">@(isTurkish ? "Y√ºkleniyor..." : "Loading...")</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
}

<!-- Overnight Hours Mode Modal -->
<div class="modal fade" id="overnightHoursModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üåô</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "Ay Sonu N√∂beti" : "Month-End Shift")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Sarkan saatler hangi aya yazƒ±lsƒ±n?" : "Which month should overnight hours count?")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <p class="overnight-info">
                    @(isTurkish 
                        ? "Bu n√∂bet ayƒ±n son g√ºn√ºnde ba≈ülayƒ±p ertesi aya sarkƒ±yor. Puantaj hesaplamasƒ± i√ßin sarkan saatlerin hangi aya dahil edileceƒüini se√ßin." 
                        : "This shift starts on the last day of the month and continues into the next month. Choose which month the overnight hours should count for the timesheet.")
                </p>
                
                <div class="overnight-options">
                    <label class="overnight-option">
                        <input type="radio" name="overnightMode" value="1" />
                        <div class="overnight-card">
                            <div class="overnight-icon">üìÖ</div>
                            <div class="overnight-text">
                                <strong>@(isTurkish ? "Tamamƒ± Bu Ay" : "All This Month")</strong>
                                <span>@(isTurkish ? "Sarkan saatler dahil t√ºm√º bu aya yazƒ±lsƒ±n" : "Including overnight hours, all count in this month")</span>
                            </div>
                        </div>
                    </label>
                    
                    <label class="overnight-option">
                        <input type="radio" name="overnightMode" value="0" checked />
                        <div class="overnight-card">
                            <div class="overnight-icon">‚úÇÔ∏è</div>
                            <div class="overnight-text">
                                <strong>@(isTurkish ? "Gece Yarƒ±sƒ±ndan B√∂l" : "Split at Midnight")</strong>
                                <span>@(isTurkish ? "00:00'a kadar bu ay, 00:00 sonrasƒ± gelecek ay" : "Until 00:00 this month, after 00:00 next month")</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">@(isTurkish ? "ƒ∞ptal" : "Cancel")</button>
                <button type="button" class="btn-modal-save" id="confirmOvernightBtn">
                    <span class="btn-icon">‚úì</span> @(isTurkish ? "N√∂bet Ekle" : "Add Shift")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Time Modal -->
<div class="modal fade" id="customTimeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom time-header">
                <div class="modal-icon">‚è∞</div>
                <div class="modal-title-group">
                    <h5 class="modal-title">@(isTurkish ? "√ñzel Vardiya" : "Custom Shift")</h5>
                    <p class="modal-subtitle">@(isTurkish ? "Saat ve mola ayarlayƒ±n" : "Set time and break")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <div class="time-inputs">
                    <div class="time-input-group">
                        <label class="time-label">@(isTurkish ? "Ba≈ülangƒ±√ß" : "Start")</label>
                        <input type="time" class="time-input" id="customStartTime" value="08:00">
                    </div>
                    <div class="time-arrow">‚Üí</div>
                    <div class="time-input-group">
                        <label class="time-label">@(isTurkish ? "Biti≈ü" : "End")</label>
                        <input type="time" class="time-input" id="customEndTime" value="17:00">
                    </div>
                </div>
                
                <div class="break-input">
                    <label class="break-label">‚òï @(isTurkish ? "Mola S√ºresi" : "Break Time")</label>
                    <div class="break-buttons">
                        <button type="button" class="break-btn active" data-break="0">0</button>
                        <button type="button" class="break-btn" data-break="30">30</button>
                        <button type="button" class="break-btn" data-break="60">60</button>
                        <button type="button" class="break-btn" data-break="90">90</button>
                        <input type="number" class="break-custom" id="customBreak" value="0" min="0" max="480" placeholder="dk">
                        <span class="break-unit">@(isTurkish ? "dk" : "min")</span>
                    </div>
                </div>
                
                <label class="overnight-toggle">
                    <input type="checkbox" id="customSpansNextDay">
                    <span class="toggle-track">
                        <span class="toggle-thumb"></span>
                    </span>
                    <span class="toggle-label">
                        <span class="toggle-icon">üåô</span>
                        @(isTurkish ? "Ertesi g√ºne sarkar" : "Overnight shift")
                    </span>
                </label>
            </div>
            <div class="modal-footer-custom">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">
                    @(isTurkish ? "ƒ∞ptal" : "Cancel")
                </button>
                <button type="button" class="btn-modal-save time" id="applyCustomTimeBtn">
                    <span class="btn-icon">‚úì</span>
                    @(isTurkish ? "Uygula" : "Apply")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Assign Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-modal">
            <div class="modal-header-custom">
                <div class="modal-icon">üìÖ</div>
                <div class="modal-title-group">
                    <h5 class="modal-title" id="bulkAssignEmployeeName"></h5>
                    <p class="modal-subtitle">@(isTurkish ? "Toplu n√∂bet atama" : "Bulk shift assignment")</p>
                </div>
                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body-custom">
                <div class="info-box template-highlight-box" style="margin-bottom: 16px;" id="bulkAssignTemplateBox">
                    <span class="info-icon" id="bulkAssignTemplateIcon">‚ÑπÔ∏è</span>
                    <div class="info-content">
                        <strong>@(isTurkish ? "Se√ßili ≈ûablon" : "Selected Template")</strong>
                        <p id="bulkAssignTemplateInfo">@(isTurkish ? "L√ºtfen √∂nce bir vardiya ≈üablonu se√ßin" : "Please select a shift template first")</p>
                    </div>
                    <div class="template-preview-badge" id="bulkAssignTemplateBadge" style="display: none;">
                        <span class="template-preview-color" id="bulkAssignTemplateColor"></span>
                        <span class="template-preview-time" id="bulkAssignTemplateTime"></span>
                    </div>
                </div>
                
                <div class="bulk-options">
                    <button type="button" class="bulk-option-btn" data-mode="weekdays">
                        <span class="option-icon">üìÖ</span>
                        <div class="option-content">
                            <strong>@(isTurkish ? "Hafta ƒ∞√ßi G√ºnler" : "Weekdays Only")</strong>
                            <small>@(isTurkish ? "Pazartesi - Cuma" : "Monday - Friday")</small>
                        </div>
                    </button>
                    
                    <button type="button" class="bulk-option-btn" data-mode="all">
                        <span class="option-icon">üìÜ</span>
                        <div class="option-content">
                            <strong>@(isTurkish ? "T√ºm G√ºnler" : "All Days")</strong>
                            <small>@(isTurkish ? "Hafta i√ßi + Hafta sonu" : "Including weekends")</small>
                        </div>
                    </button>
                    
                    <button type="button" class="bulk-option-btn" data-mode="no-sunday">
                        <span class="option-icon">üóìÔ∏è</span>
                        <div class="option-content">
                            <strong>@(isTurkish ? "Pazar Hari√ß" : "Except Sunday")</strong>
                            <small>@(isTurkish ? "Pazar g√ºnleri bo≈ü" : "Sundays excluded")</small>
                        </div>
                    </button>
                </div>
                
                <div class="form-section" style="margin-top: 12px;">
                    <label class="overwrite-checkbox">
                        <input type="checkbox" id="bulkOverwrite">
                        <span class="checkbox-text">@(isTurkish ? "Mevcut n√∂betlerin √ºzerine yaz" : "Overwrite existing shifts")</span>
                    </label>
                </div>
                
                <!-- Loading Indicator -->
                <div class="bulk-loading" id="bulkLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">@(isTurkish ? "ƒ∞≈üleniyor..." : "Processing...")</span>
                    <span class="loading-progress" id="bulkProgress"></span>
                </div>
            </div>
            <div class="modal-footer-custom" style="justify-content: space-between;">
                <button type="button" class="btn-modal-delete" id="bulkDeleteAllBtn">
                    <span class="btn-icon">üóëÔ∏è</span>
                    @(isTurkish ? "T√ºm N√∂betleri Sil" : "Delete All Shifts")
                </button>
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">@(isTurkish ? "ƒ∞ptal" : "Cancel")</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    /* ===== Unit Management Styles (Premium Feature) ===== */
    .units-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .units-btn:hover { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
    .premium-badge { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important; color: #000 !important; font-weight: 600; }
    .premium-text { color: #f59e0b; display: flex; align-items: center; gap: 4px; }
    .premium-icon { font-size: 12px; }
    
    /* ========== UNIT MANAGEMENT - LIGHT THEME ========== */
    
    .premium-text {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: #d97706 !important;
    }
    .premium-icon { font-size: 0.9rem; }
    
    /* Tabs */
    .unit-tabs {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }
    .unit-tabs .nav-link {
        background: transparent;
        border: none;
        color: #6b7280;
        padding: 0.75rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
    }
    .unit-tabs .nav-link:hover { color: #374151; }
    .unit-tabs .nav-link.active {
        color: #111827;
        border-bottom-color: var(--primary);
    }
    .tab-icon { font-size: 1rem; }
    .tab-badge {
        background: #f3f4f6;
        color: #374151;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }
    .unit-tabs .nav-link.active .tab-badge {
        background: var(--primary);
        color: #fff;
    }
    
    /* Add Form */
    .add-unit-form {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .add-unit-form .form-row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .add-unit-form .form-input,
    .add-unit-form .form-select {
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: #111827;
        padding: 0.5rem 0.75rem;
        flex: 1;
        min-width: 140px;
        font-size: 0.85rem;
    }
    .add-unit-form .form-input:focus,
    .add-unit-form .form-select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    .add-unit-form .form-input::placeholder { color: #9ca3af; }
    .add-unit-form .coefficient-input { max-width: 80px; min-width: 70px; text-align: center; }
    .add-unit-form .limit-input { max-width: 100px; min-width: 80px; text-align: center; }
    .add-unit-form .color-input { 
        width: 40px; 
        min-width: 40px; 
        height: 36px;
        padding: 2px; 
        cursor: pointer; 
        border-radius: 6px;
    }
    .add-unit-form .btn-primary {
        background: #6366f1;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        color: #fff !important;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }
    .add-unit-form .btn-primary:hover { background: #4f46e5; }
    .add-unit-form .btn-icon { font-size: 1rem; }
    
    /* Units List */
    .units-list, .unit-types-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 350px;
        overflow-y: auto;
    }
    
    /* Unit Cards */
    .unit-card, .unit-type-card {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }
    .unit-card:hover, .unit-type-card:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }
    
    .unit-color-bar {
        width: 4px;
        height: 40px;
        border-radius: 2px;
        margin-right: 0.75rem;
    }
    .unit-type-color {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        margin-right: 0.75rem;
        flex-shrink: 0;
    }
    
    .unit-info, .unit-type-info { flex: 1; }
    .unit-header { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .unit-name { margin: 0; font-size: 0.9rem; font-weight: 600; color: #111827; }
    .unit-type-name { margin: 0; font-size: 0.9rem; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 8px; }
    
    .default-badge, .system-badge {
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
        text-transform: uppercase;
    }
    .default-badge { background: #22c55e; color: #fff; }
    .system-badge { background: #e5e7eb; color: #6b7280; }
    
    .unit-type-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        color: #fff;
        display: inline-block;
        margin-bottom: 2px;
    }
    
    .unit-meta, .unit-type-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
        color: #6b7280;
    }
    .meta-item { display: flex; align-items: center; gap: 4px; }
    .meta-item strong { color: #d97706; }
    .meta-icon { font-size: 0.8rem; }
    .separator { color: #d1d5db; }
    
    /* Action Buttons */
    .unit-actions, .unit-type-actions {
        display: flex;
        gap: 0.375rem;
    }
    .unit-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .unit-action-btn:hover { background: #f3f4f6; color: #374151; }
    .unit-action-btn.delete-btn:hover { background: #fef2f2; color: #ef4444; border-color: #fecaca; }
    .unit-action-btn.assign-btn:hover { background: #f0fdf4; color: #22c55e; border-color: #bbf7d0; }
    .unit-action-btn.edit-btn:hover { background: #eff6ff; color: #3b82f6; border-color: #bfdbfe; }
    
    /* Edit Modals */
    #editUnitModal .modal-dialog, #editUnitTypeModal .modal-dialog { max-width: 400px; }
    #assignEmployeesModal .modal-dialog { max-width: 500px; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { 
        display: block; 
        margin-bottom: 0.375rem; 
        color: #374151; 
        font-size: 0.8rem;
        font-weight: 500;
    }
    .form-group .form-input, .form-group .form-select {
        width: 100%;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: #111827;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    .form-group .form-input:focus, .form-group .form-select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    .form-group .color-input { width: 50px; height: 36px; padding: 2px; cursor: pointer; }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #374151;
        font-size: 0.85rem;
    }
    .checkbox-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
    }
    
    /* Assign Employees Modal */
    .assigned-section, .available-section { margin-bottom: 1rem; }
    .assigned-section h6, .available-section h6 {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .employee-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        min-height: 40px;
        padding: 0.5rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }
    .employee-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 16px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .employee-chip.assigned {
        background: #f0fdf4;
        border: 1px solid #86efac;
        color: #166534;
    }
    .employee-chip.available {
        background: #fff;
        border: 1px solid #e5e7eb;
        color: #374151;
    }
    .employee-chip.available:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .employee-chip:hover {
        transform: scale(1.05);
    }
    .employee-chip.assigned:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444; }
    .employee-chip.available:hover { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; color: #22c55e; }
    .chip-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .chip-remove, .chip-add {
        font-size: 1rem;
        line-height: 1;
    }
    
    /* Units Modal Empty State */
    .units-section .empty-state,
    .unit-types-section .empty-state {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }
    .units-section .empty-state .empty-icon,
    .unit-types-section .empty-state .empty-icon { 
        font-size: 2rem; 
        display: block; 
        margin-bottom: 0.5rem;
    }
    .units-section .empty-state p,
    .unit-types-section .empty-state p {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        color: #6b7280;
    }
    .units-section .empty-state small,
    .unit-types-section .empty-state small {
        font-size: 0.8rem;
        color: #9ca3af;
    }
    
    /* Generic empty state */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: rgba(255,255,255,0.5);
    }
    .empty-icon { font-size: 2rem; display: block; margin-bottom: 0.5rem; }
    
    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 6px;
        border: 2px solid #f1f5f9;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }
    
    ::-webkit-scrollbar-corner {
        background: #f1f5f9;
    }
    
    /* Firefox Scrollbar */
    * {
        scrollbar-width: auto;
        scrollbar-color: #6366f1 #f1f5f9;
    }
    
    /* App Layout */
    .app-wrapper {
        display: flex;
        min-height: calc(100vh - 60px);
        background: #f1f5f9;
    }
    
    /* Sidebar - Modern & Enhanced */
    .app-sidebar {
        width: 248px;
        min-width: 248px;
        max-height: calc(100vh - 60px);
        background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 16px;
        gap: 12px;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.02);
    }
    
    .app-sidebar::-webkit-scrollbar {
        width: 8px;
    }
    
    .app-sidebar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }
    
    .app-sidebar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        border-radius: 4px;
    }
    
    .app-sidebar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }
    
    /* Sidebar Actions - Enhanced */
    .sidebar-actions {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 4px;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
        width: 100%;
        text-align: left;
        position: relative;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s;
    }
    
    .action-btn:hover::before {
        left: 100%;
    }
    
    .action-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .action-btn:active {
        background: #e5e7eb;
    }
    
    .action-icon {
        font-size: 1.1rem;
    }
    
    .action-label {
        flex: 1;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        letter-spacing: -0.01em;
    }
    
    .action-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 10px;
    }
    
    .action-btn.holidays-btn .action-badge {
        background: #f59e0b;
    }
    
    .action-btn.payroll-btn {
        text-decoration: none;
    }
    
    .action-btn.payroll-btn .action-badge {
        background: #22c55e;
    }
    
    .action-btn.payroll-btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .action-btn.payroll-btn.disabled .action-badge {
        background: #9ca3af;
    }
    
    .action-btn.attendance-btn {
        text-decoration: none;
    }
    
    .action-btn.attendance-btn .action-badge {
        background: #8b5cf6;
    }
    
    .action-btn.attendance-btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .action-btn.attendance-btn.disabled .action-badge {
        background: #9ca3af;
    }
    
    .action-btn.templates-btn .action-badge {
        background: #f59e0b;
    }
    
    .action-btn.leaves-btn .action-badge {
        background: #8b5cf6;
    }
    
    /* Templates */
    .templates-compact {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        padding: 12px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
        transition: all 0.2s ease;
        margin-bottom: 0;
    }
    
    .templates-compact:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border-color: #cbd5e1;
    }
    
    .templates-header {
        font-size: 0.7rem;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .templates-header > span {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .tpl-manage-btn {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
        cursor: pointer;
        font-size: 0.85rem;
        padding: 4px 6px;
        border-radius: 4px;
        opacity: 0.6;
        transition: opacity 0.15s, background 0.15s;
    }
    
    .tpl-manage-btn:hover {
        opacity: 1;
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .tpl-manage-btn:active {
        transform: scale(0.98);
    }
    
    .tpl-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 8px 0;
    }
    
    /* Leave Section Styles */
    .leaves-section {
        margin-top: 0;
        border-top: none;
        padding-top: 0;
    }
    
    .leave-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .leave-header::before {
        display: none;
    }
    
    .leave-toggle-icon {
        font-size: 0.7rem;
        color: #9ca3af;
        transition: transform 0.2s;
    }
    
    .leave-toggle-icon.open {
        transform: rotate(180deg);
    }
    
    .leave-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .leave-category {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: flex-start;
    }
    
    .leave-category-name {
        width: 100%;
        font-size: 0.65rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }
    
    .leave-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.15s;
    }
    
    .leave-btn:hover {
        border-color: #d1d5db;
        background: #f9fafb;
    }
    
    .leave-btn.active {
        border-color: var(--leave-color, #9333ea);
        background: color-mix(in srgb, var(--leave-color, #9333ea) 10%, white);
        box-shadow: 0 0 0 1px var(--leave-color, #9333ea);
    }
    
    .leave-color {
        width: 10px;
        height: 10px;
        border-radius: 2px;
        flex-shrink: 0;
    }
    
    .leave-code {
        font-weight: 600;
        color: #374151;
    }
    
    /* Modal Styles for Templates and Leaves */
    .template-list-modal {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 500px;
        overflow-y: auto;
        padding: 4px;
    }
    
    .leave-list-modal {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .leave-category-modal {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .leave-category-name-modal {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    
    .leave-buttons-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .leave-btn-modal {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
        min-width: 200px;
        text-align: left;
    }
    
    .leave-btn-modal:hover {
        border-color: #d1d5db;
        background: #f9fafb;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    .leave-btn-modal.active {
        border-color: var(--leave-color, #9333ea);
        background: color-mix(in srgb, var(--leave-color, #9333ea) 10%, white);
        box-shadow: 0 0 0 2px var(--leave-color, #9333ea);
    }
    
    .leave-color-modal {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .leave-content-modal {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
    }
    
    .leave-code-modal {
        font-weight: 700;
        color: #1f2937;
        font-size: 0.85rem;
        letter-spacing: 0.3px;
    }
    
    .leave-name-modal {
        font-weight: 400;
        color: #6b7280;
        font-size: 0.75rem;
        line-height: 1.3;
    }
    
    /* Leave Badge on Calendar */
    .leave-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        cursor: pointer;
        position: relative;
    }
    
    .leave-badge:hover::after {
        content: '√ó';
        position: absolute;
        right: -6px;
        top: -6px;
        width: 14px;
        height: 14px;
        background: #ef4444;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    /* Template Manager Modal */
    .templates-modal-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    
    .template-manager-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
    
    .template-manager-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        gap: 12px;
    }
    
    .template-manager-item:last-child {
        border-bottom: none;
    }
    
    .template-manager-item.global {
        background: #f9fafb;
    }
    
    .tpl-item-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        flex-shrink: 0;
    }
    
    .tpl-item-info {
        flex: 1;
    }
    
    .tpl-item-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #1f2937;
    }
    
    .tpl-item-time {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .tpl-item-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        background: #e0e7ff;
        color: #4338ca;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .tpl-item-actions {
        display: flex;
        gap: 8px;
    }
    
    .tpl-item-actions button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: background 0.2s;
    }
    
    .tpl-item-actions .btn-edit:hover {
        background: #dbeafe;
    }
    
    .tpl-item-actions .btn-delete:hover {
        background: #fee2e2;
    }
    
    .template-add-form {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
    }
    
    .form-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
    }
    
    .template-form-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 60px 1fr;
        gap: 12px;
        align-items: end;
        margin-bottom: 12px;
    }
    
    .form-check-group {
        display: flex;
        align-items: center;
    }
    
    .form-check-group .form-check {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 0;
        font-size: 0.8rem;
        cursor: pointer;
    }
    
    .form-control-color {
        width: 100%;
        height: 38px;
        padding: 2px;
        cursor: pointer;
    }
    
    .btn-add-template {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-add-template:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .template-loading {
        padding: 20px;
        text-align: center;
        color: #6b7280;
    }
    
    .user-template-item {
        border-left: 3px solid #8b5cf6;
    }
    
    @@media (max-width: 768px) {
        .template-form-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    .templates-header > span::before {
        content: '‚è∞';
        font-size: 0.85rem;
        margin-right: 6px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }
    
    .template-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .tpl-btn-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
        width: 100%;
        text-align: left;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .tpl-btn-row::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
        opacity: 0;
        transition: opacity 0.25s;
    }
    
    .tpl-btn-row:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-color: #cbd5e1;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .tpl-btn-row:hover::after {
        opacity: 1;
    }
    
    .tpl-btn-row.active {
        background: #eff6ff;
        border-color: #3b82f6;
    }
    
    .tpl-btn-row.overnight {
        border-left: 3px solid #f59e0b;
    }
    
    .tpl-btn-row.day-off {
        border-style: dashed;
        background: #fafafa;
    }
    
    .tpl-btn-row.custom {
        border-left: 3px solid #8b5cf6;
    }
    
    .tpl-color {
        width: 4px;
        height: 26px;
        border-radius: 2px;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        transition: all 0.25s;
    }
    
    .tpl-btn-row:hover .tpl-color {
        width: 6px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }
    
    .tpl-btn-row.active .tpl-color {
        width: 6px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }
    
    .tpl-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .tpl-time {
        font-size: 0.8rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .tpl-meta {
        font-size: 0.65rem;
        color: #6b7280;
        font-weight: 400;
    }
    
    .tpl-badge-new {
        font-size: 0.6rem;
        padding: 2px 6px;
        background: #f59e0b;
        color: white;
        border-radius: 4px;
        font-weight: 600;
    }
    
    /* Multi Toggle */
    .multi-toggle {
        padding: 10px 12px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
        transition: all 0.2s ease;
        margin-top: 4px;
    }
    
    .multi-toggle:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border-color: #cbd5e1;
    }
    
    .multi-toggle label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }
    
    .multi-toggle .toggle-track {
        width: 44px;
        height: 24px;
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        border-radius: 12px;
        position: relative;
        transition: background 0.2s;
    }
    
    .multi-toggle .toggle-thumb {
        position: absolute;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: left 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .multi-toggle input:checked + .toggle-track {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    
    .multi-toggle input:checked + .toggle-track .toggle-thumb {
        left: 22px;
        box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
    }
    
    .multi-toggle input {
        display: none;
    }
    
    .multi-toggle .toggle-text {
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
    }
    
    /* Selected Indicator */
    .selected-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1.5px solid #3b82f6;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        animation: slideIn 0.3s ease-out;
        position: relative;
        overflow: hidden;
        margin-top: 4px;
    }
    
    .selected-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }
    
    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @@keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .indicator-color {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        flex-shrink: 0;
        box-shadow: 0 3px 8px rgba(59, 130, 246, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .indicator-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .indicator-label {
        font-size: 0.65rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-weight: 700;
    }
    
    .indicator-time {
        font-size: 0.9rem;
        font-weight: 700;
        color: #1e40af;
        letter-spacing: -0.01em;
    }
    
    .sidebar-section {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .section-header h6 {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin: 0;
    }
    
    .badge-count {
        font-size: 0.7rem;
        padding: 2px 8px;
        background: #f1f5f9;
        border-radius: 10px;
        color: #64748b;
    }
    
    .btn-add-employee {
        width: 100%;
        padding: 10px;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        background: transparent;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 12px;
    }
    
    .btn-add-employee:hover:not(:disabled) {
        border-color: #6366f1;
        color: #6366f1;
        background: #f5f3ff;
    }
    
    .btn-add-employee:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-add-employee .icon {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .alert-limit {
        font-size: 0.75rem;
        color: #ef4444;
        text-align: center;
        margin-bottom: 12px;
    }
    
    /* Employee List */
    .employee-list {
        /* No max-height - sidebar handles scroll */
    }
    
    .employee-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        margin-bottom: 4px;
    }
    
    .employee-item:hover {
        background: #f1f5f9;
    }
    
    .employee-item.selected {
        background: #eff6ff;
        border: 1px solid #3b82f6;
    }
    
    .employee-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .employee-info {
        flex: 1;
        min-width: 0;
    }
    
    .employee-name {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .employee-title {
        display: block;
        font-size: 0.7rem;
        color: #94a3b8;
    }
    
    .btn-delete {
        width: 20px;
        height: 20px;
        border: none;
        background: transparent;
        color: #94a3b8;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s;
    }
    
    .employee-item:hover .btn-delete {
        opacity: 1;
    }
    
    .btn-delete:hover {
        background: #fee2e2;
        color: #ef4444;
    }
    
    /* Template List */
    .template-info {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-bottom: 10px;
    }
    
    .templates-section {
        flex: 0 0 auto;
    }
    
    .template-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 8px;
    }
    
    /* Employee Hours Display */
    .employee-hours {
        display: block;
        font-size: 0.65rem;
        color: #6366f1;
        font-weight: 500;
    }
    
    .template-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }
    
    .template-btn:hover {
        border-color: #6366f1;
        background: #faf5ff;
    }
    
    .template-btn.active {
        border-color: #6366f1;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .template-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    .template-name {
        flex: 1;
        font-size: 0.85rem;
        font-weight: 500;
        color: #1e293b;
    }
    
    .template-meta {
        font-size: 0.7rem;
        color: #94a3b8;
    }
    
    .template-badge {
        font-size: 0.65rem;
        padding: 1px 4px;
        background: #ef4444;
        color: white;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .template-divider {
        display: flex;
        align-items: center;
        margin: 8px 0;
        font-size: 0.7rem;
        color: #94a3b8;
    }
    
    .template-divider::before,
    .template-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e2e8f0;
    }
    
    .template-divider span {
        padding: 0 8px;
    }
    
    /* Multi-select Toggle */
    .multi-select-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e2e8f0;
        font-size: 0.8rem;
        color: #64748b;
    }
    
    .toggle-switch {
        position: relative;
        width: 36px;
        height: 20px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #cbd5e1;
        border-radius: 20px;
        transition: 0.3s;
    }
    
    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        left: 2px;
        bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background: #6366f1;
    }
    
    .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(16px);
    }
    
    /* Holiday List */
    .btn-add-small {
        width: 24px;
        height: 24px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 1rem;
        color: #64748b;
    }
    
    .btn-add-small:hover {
        border-color: #6366f1;
        color: #6366f1;
    }
    
    .holiday-list {
        max-height: 120px;
        overflow-y: auto;
        padding-right: 4px;
    }
    
    /* Enhanced Scrollbar for Holiday List */
    .holiday-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .holiday-list::-webkit-scrollbar-track {
        background: #fef3c7;
        border-radius: 4px;
    }
    
    .holiday-list::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #f59e0b 0%, #f97316 100%);
        border-radius: 4px;
        border: 2px solid #fef3c7;
    }
    
    .holiday-list::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #d97706 0%, #ea580c 100%);
    }
    
    .holiday-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.8rem;
    }
    
    .holiday-date {
        font-weight: 500;
        color: #f59e0b;
        min-width: 50px;
    }
    
    .holiday-name {
        flex: 1;
        color: #64748b;
    }
    
    .btn-delete-small {
        width: 18px;
        height: 18px;
        border: none;
        background: transparent;
        color: #cbd5e1;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .btn-delete-small:hover {
        color: #ef4444;
    }
    
    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 20px;
        color: #94a3b8;
    }
    
    .empty-state .icon {
        font-size: 2rem;
        display: block;
        margin-bottom: 8px;
    }
    
    .empty-state.small {
        padding: 10px;
    }
    
    .empty-state.small .icon {
        font-size: 1.5rem;
    }
    
    /* Main Content */
    .app-main {
        flex: 1;
        padding: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Toolbar */
    .app-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding: 8px 12px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .toolbar-nav {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .unit-selector {
        margin-left: 16px;
        padding-left: 16px;
        border-left: 1px solid var(--border-color);
    }
    
    .unit-select {
        padding: 6px 32px 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        min-width: 180px;
    }
    
    .unit-select:hover {
        border-color: var(--primary);
    }
    
    .unit-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .nav-arrow {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 8px;
        background: #f3f4f6;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.15s;
    }
    
    .nav-arrow:hover {
        background: #e5e7eb;
        color: #374151;
    }
    
    .month-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        min-width: 140px;
        text-align: center;
    }
    
    .toolbar-actions {
        display: flex;
        gap: 6px;
    }
    
    .toolbar-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        background: #f3f4f6;
        color: #374151;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .toolbar-btn:hover {
        background: #e5e7eb;
    }
    
    .toolbar-btn svg {
        flex-shrink: 0;
    }
    
    .toolbar-btn.primary {
        background: #2563eb;
        color: white;
    }
    
    .toolbar-btn.primary:hover {
        background: #1d4ed8;
    }
    
    .toolbar-btn.accent {
        background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
        color: white;
    }
    
    .toolbar-btn.accent:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 100%);
    }
    
    .toolbar-btn.ghost {
        background: transparent;
        color: #6b7280;
    }
    
    .toolbar-btn.ghost:hover {
        background: #f3f4f6;
    }
    
    .toolbar-btn.locked {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .toolbar-btn.locked:hover {
        background: #f3f4f6;
    }
    
    /* Old btn-toolbar styles for backwards compatibility */
    .btn-toolbar {
        padding: 8px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        color: #64748b;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-toolbar:hover {
        border-color: #6366f1;
        color: #6366f1;
    }
    
    .btn-toolbar.primary {
        background: #6366f1;
        border-color: #6366f1;
        color: white;
    }
    
    .btn-toolbar.primary:hover {
        background: #4f46e5;
    }
    
    .btn-toolbar.success {
        background: #22c55e;
        border-color: #22c55e;
        color: white;
    }
    
    .btn-toolbar.success:hover {
        background: #16a34a;
    }
    
    .btn-toolbar.warning {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }
    
    .btn-toolbar.warning:hover {
        background: #d97706;
    }
    
    /* Schedule Table */
    .schedule-container {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow-x: auto;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
    }
    
    /* Enhanced Scrollbar for Schedule Container */
    .schedule-container::-webkit-scrollbar {
        width: 14px;
        height: 14px;
    }
    
    .schedule-container::-webkit-scrollbar-track {
        background: linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 100%);
        border-radius: 8px;
        margin: 4px;
    }
    
    .schedule-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        border-radius: 8px;
        border: 3px solid #f1f5f9;
        min-height: 50px;
        min-width: 50px;
    }
    
    .schedule-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
    }
    
    .schedule-container::-webkit-scrollbar-thumb:active {
        background: linear-gradient(135deg, #4338ca 0%, #7e22ce 100%);
    }
    
    .schedule-container::-webkit-scrollbar-corner {
        background: #e2e8f0;
        border-radius: 8px;
    }
    
    .schedule-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }
    
    .schedule-table th,
    .schedule-table td {
        border: 1px solid #e2e8f0;
        padding: 0;
    }
    
    .schedule-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
    }
    
    .col-employee {
        width: 160px;
        min-width: 160px;
        padding: 10px !important;
        background: #f8fafc;
        text-align: left;
        font-weight: 600;
        color: #64748b;
    }
    
    /* Sticky first column */
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 5;
        background: #f8fafc !important;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
    }
    
    thead .sticky-col {
        z-index: 15;
    }
    
    /* Sticky last column (Total) */
    .sticky-col-right {
        position: sticky;
        right: 0;
        z-index: 5;
        background: #f8fafc !important;
        box-shadow: -2px 0 4px rgba(0,0,0,0.05);
    }
    
    thead .sticky-col-right {
        z-index: 15;
    }
    
    .col-day {
        width: 50px;
        min-width: 50px;
        padding: 6px 4px !important;
        text-align: center;
        background: #f8fafc;
    }
    
    .col-day.weekend {
        background: #fef2f2;
    }
    
    .col-day.holiday {
        background: #fef3c7;
    }
    
    .day-name {
        display: block;
        font-size: 0.65rem;
        color: #94a3b8;
        font-weight: 500;
    }
    
    .day-num {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: #1e293b;
    }
    
    .col-total {
        width: 100px;
        min-width: 100px;
        padding: 6px !important;
        background: #f8fafc;
        text-align: center;
        font-weight: 600;
    }
    
    /* Total Cell - Worked/Required Hours */
    .total-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        padding: 4px;
    }
    
    .total-main {
        display: flex;
        align-items: baseline;
        gap: 2px;
        font-size: 0.75rem;
    }
    
    .total-cell .worked-hours {
        font-weight: 700;
        font-size: 0.9rem;
        color: #1e293b;
    }
    
    .total-cell .separator {
        color: #94a3b8;
        font-size: 0.7rem;
        margin: 0 1px;
    }
    
    .total-cell .required-hours {
        color: #64748b;
        font-size: 0.75rem;
    }
    
    .diff-hours {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 10px;
        background: #f1f5f9;
        color: #64748b;
    }
    
    .diff-hours.positive {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #15803d;
    }
    
    .diff-hours.negative {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #dc2626;
    }
    
    .total-cell.overtime .worked-hours {
        color: #16a34a;
    }
    
    .total-cell.undertime .worked-hours {
        color: #dc2626;
    }
    
    /* Employee Cell */
    .employee-cell {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .emp-color {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .emp-info {
        min-width: 0;
    }
    
    .emp-name {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .emp-title {
        display: block;
        font-size: 0.65rem;
        color: #94a3b8;
    }
    
    /* Shift Cell */
    .shift-cell {
        height: 50px;
        vertical-align: top;
        padding: 2px !important;
        cursor: pointer;
        position: relative;
        transition: background 0.2s;
    }
    
    .shift-cell:hover {
        background: #f1f5f9;
    }
    
    .shift-cell.weekend {
        background: #fef2f2;
    }
    
    .shift-cell.weekend:hover {
        background: #fee2e2;
    }
    
    .shift-cell.holiday {
        background: #fef3c7;
    }
    
    .shift-cell.selected {
        background: #ddd6fe !important;
        box-shadow: inset 0 0 0 2px #8b5cf6;
    }
    
    /* Shift Badge */
    .shift-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        border-radius: 4px;
        border: 1px solid;
        font-size: 0.7rem;
        font-weight: 500;
        position: relative;
    }
    
    .shift-badge.overnight {
        border-style: dashed;
    }
    
    .shift-badge.day-off {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        border: 1px dashed #94a3b8 !important;
        color: #64748b !important;
        flex-direction: row;
        gap: 4px;
    }
    
    .day-off-icon {
        font-size: 0.9rem;
    }
    
    .day-off-text {
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .template-btn.day-off {
        border-style: dashed;
        background: #f8fafc;
    }
    
    .shift-start {
        font-weight: 600;
    }
    
    .shift-end {
        opacity: 0.8;
    }
    
    .overnight-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        font-size: 0.55rem;
        padding: 1px 3px;
        background: #ef4444;
        color: white;
        border-radius: 3px;
        font-weight: 700;
    }
    
    /* Shift Continuation */
    .shift-continuation {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2px;
        font-size: 0.6rem;
        border-bottom: 1px dashed;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .cont-icon {
        font-weight: bold;
    }
    
    .cont-time {
        font-weight: 500;
    }
    
    /* Total Hours */
    .total-hours {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e293b;
    }
    
    /* Empty Table */
    .empty-table {
        height: 200px;
    }
    
    /* Legend */
    .schedule-legend {
        display: flex;
        gap: 20px;
        margin-top: 12px;
        padding: 10px 16px;
        background: white;
        border-radius: 8px;
        font-size: 0.75rem;
        color: #64748b;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    
    .legend-color.weekend {
        background: #fef2f2;
        border: 1px solid #fecaca;
    }
    
    .legend-color.holiday {
        background: #fef3c7;
        border: 1px solid #fde68a;
    }
    
    .legend-badge {
        font-size: 0.6rem;
        padding: 1px 4px;
        border-radius: 3px;
    }
    
    .legend-badge.overnight {
        background: #ef4444;
        color: white;
    }
    
    .legend-icon {
        font-weight: bold;
        color: #ef4444;
    }
    
    /* ===== MODAL STYLES ===== */
    .custom-modal {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    }
    
    .modal-header-custom {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #fff;
    }
    
    .modal-header-custom.employee-header,
    .modal-header-custom.holiday-header,
    .modal-header-custom.time-header {
        background: #fff;
    }
    
    .modal-icon {
        width: 36px;
        height: 36px;
        background: #f3f4f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }
    
    .modal-title-group {
        flex: 1;
    }
    
    .modal-title-group .modal-title {
        color: #111827;
        font-weight: 600;
        font-size: 1rem;
        margin: 0;
    }
    
    .modal-title-group .modal-subtitle {
        color: #6b7280;
        font-size: 0.8rem;
        margin: 2px 0 0 0;
    }
    
    .btn-close-custom {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: #9ca3af;
        border-radius: 6px;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .btn-close-custom:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .modal-body-custom {
        padding: 20px;
        background: #fff;
    }
    
    .form-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
    }
    
    .section-title {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .section-icon {
        font-size: 0.9rem;
    }
    
    .form-floating-custom {
        position: relative;
        margin-bottom: 0;
    }
    
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #fff;
        transition: all 0.15s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-floating-custom label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
    }
    
    .form-floating-custom {
        display: flex;
        flex-direction: column;
    }
    
    .form-floating-custom label {
        position: static;
        transform: none;
        order: -1;
    }
    
    /* Weekend Options */
    .weekend-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .weekend-option input {
        display: none;
    }
    
    .option-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 10px 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        background: #fff;
    }
    
    .weekend-option input:checked + .option-card {
        border-color: #2563eb;
        background: #eff6ff;
    }
    
    .option-card:hover {
        border-color: #9ca3af;
    }
    
    .option-icon {
        font-size: 1.1rem;
    }
    
    /* Custom Checkbox */
    .checkbox-wrapper {
        display: flex;
        align-items: center;
        min-height: 42px;
    }
    
    .custom-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
    }
    
    .custom-checkbox input {
        display: none;
    }
    
    .custom-checkbox .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #fff;
        flex-shrink: 0;
    }
    
    .custom-checkbox input:checked + .checkmark {
        background: #2563eb;
        border-color: #2563eb;
    }
    
    .custom-checkbox input:checked + .checkmark::after {
        content: '‚úì';
        color: #fff;
        font-size: 12px;
        font-weight: bold;
    }
    
    .custom-checkbox:hover .checkmark {
        border-color: #9ca3af;
    }
    
    .checkbox-label {
        font-size: 0.85rem;
        color: #374151;
    }
    
    .option-text {
        font-size: 0.7rem;
        color: #6b7280;
        text-align: center;
        font-weight: 500;
    }
    
    .saturday-hours-input {
        margin-top: 10px;
    }
    
    /* Holiday Type Options */
    .holiday-type-options {
        display: flex;
        gap: 8px;
    }
    
    .type-option {
        flex: 1;
    }
    
    .type-option input {
        display: none;
    }
    
    .type-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 14px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        background: #fff;
    }
    
    .type-card.official {
        background: #fff;
    }
    
    .type-card.administrative {
        background: #fff;
    }
    
    .type-option input:checked + .type-card.official {
        border-color: #d97706;
        background: #fffbeb;
    }
    
    .type-option input:checked + .type-card.administrative {
        border-color: #16a34a;
        background: #f0fdf4;
    }
    
    .type-icon {
        font-size: 1.4rem;
    }
    
    .type-label {
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
    }
    
    /* Holiday List Styles */
    .holidays-list-section {
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .holidays-list {
        max-height: 200px;
        overflow-y: auto;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .holiday-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.15s;
    }
    
    .holiday-item:last-child {
        border-bottom: none;
    }
    
    .holiday-item:hover {
        background: #f3f4f6;
    }
    
    .holiday-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .holiday-date {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6366f1;
        background: #eef2ff;
        padding: 4px 8px;
        border-radius: 4px;
        min-width: 70px;
        text-align: center;
    }
    
    .holiday-name {
        font-size: 0.85rem;
        font-weight: 500;
        color: #1f2937;
    }
    
    .holiday-badges {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    
    .holiday-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .holiday-badge.official {
        background: #fef3c7;
        color: #92400e;
    }
    
    .holiday-badge.admin {
        background: #dcfce7;
        color: #166534;
    }
    
    .holiday-badge.half-day {
        background: #e0e7ff;
        color: #3730a3;
    }
    
    .holiday-delete-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: #fee2e2;
        color: #dc2626;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .holiday-delete-btn:hover {
        background: #fecaca;
        transform: scale(1.05);
    }
    
    .holiday-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 20px 0;
    }
    
    .holiday-loading, .holiday-empty {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 0.85rem;
    }
    
    /* Half Day Toggle */
    .half-day-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
    }
    
    .half-day-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
    }
    
    .half-day-toggle .toggle-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #374151;
    }
    
    .half-day-options {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }
    
    .half-day-options .form-floating-custom {
        max-width: 150px;
    }
    
    .half-day-hint {
        font-size: 0.75rem;
        color: #6b7280;
        margin: 8px 0 0 0;
    }
    
    /* Time Inputs */
    .time-inputs {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
    }
    
    .time-input-group {
        flex: 1;
        text-align: center;
    }
    
    .time-label {
        display: block;
        font-size: 0.7rem;
        color: #6b7280;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .time-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        background: #fff;
        transition: all 0.15s;
    }
    
    .time-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .time-arrow {
        font-size: 1.2rem;
        color: #9ca3af;
    }
    
    /* Break Input */
    .break-input {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
    }
    
    .break-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .break-buttons {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .break-btn {
        width: 40px;
        height: 32px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: #fff;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .break-btn:hover {
        border-color: #2563eb;
        color: #2563eb;
    }
    
    .break-btn.active {
        border-color: #2563eb;
        background: #2563eb;
        color: white;
    }
    
    .break-custom {
        width: 60px;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
        font-size: 0.85rem;
        margin-left: auto;
    }
    
    .break-custom:focus {
        outline: none;
        border-color: #2563eb;
    }
    
    .break-unit {
        color: #9ca3af;
        font-size: 0.8rem;
    }
    
    /* Overnight Toggle */
    .overnight-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f9fafb;
        border-radius: 6px;
        padding: 12px 14px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
    }
    
    .overnight-toggle input {
        display: none;
    }
    
    .toggle-track {
        width: 40px;
        height: 22px;
        background: #d1d5db;
        border-radius: 11px;
        position: relative;
        transition: all 0.2s;
    }
    
    .toggle-thumb {
        position: absolute;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .overnight-toggle input:checked + .toggle-track {
        background: #2563eb;
    }
    
    .overnight-toggle input:checked + .toggle-track .toggle-thumb {
        left: 20px;
    }
    
    .toggle-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #374151;
    }
    
    .toggle-icon {
        font-size: 1rem;
    }
    
    /* Info Box */
    .info-box {
        display: flex;
        gap: 10px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 6px;
        padding: 12px;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .template-highlight-box {
        align-items: center;
    }
    
    .template-preview-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
        padding: 6px 12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .template-preview-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        flex-shrink: 0;
    }
    
    .template-preview-time {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1f2937;
    }
    
    .info-icon {
        font-size: 1rem;
    }
    
    .info-content {
        flex: 1;
    }
    
    .info-content strong {
        display: block;
        font-size: 0.8rem;
        color: #0369a1;
        margin-bottom: 2px;
    }
    
    .info-content p {
        font-size: 0.75rem;
        color: #0284c7;
        margin: 0;
    }
    
    /* Modal Footer */
    .modal-footer-custom {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 16px 20px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn-modal-cancel {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #fff;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-modal-cancel:hover {
        border-color: #9ca3af;
        background: #f3f4f6;
    }
    
    .btn-modal-delete {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border: 1px solid #dc2626;
        border-radius: 6px;
        background: #fff;
        color: #dc2626;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-modal-delete:hover {
        background: #dc2626;
        color: white;
    }
    
    .btn-modal-delete:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-modal-delete:disabled:hover {
        background: #fff;
        color: #dc2626;
    }
    
    .btn-modal-save {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-modal-save:hover {
        background: #1d4ed8;
    }
    
    .btn-modal-save.holiday {
        background: #d97706;
    }
    
    .btn-modal-save.holiday:hover {
        background: #b45309;
    }
    
    .btn-modal-save.time {
        background: #2563eb;
    }
    
    .btn-modal-save.time:hover {
        background: #1d4ed8;
    }
    
    .btn-icon {
        font-size: 0.9rem;
    }
    
    /* Toast Notification */
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        font-size: 0.85rem;
        z-index: 9999;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .toast-notification.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast-success {
        background: #16a34a;
    }
    
    .toast-error {
        background: #dc2626;
    }
    
    .toast-info {
        background: #2563eb;
    }
    
    /* Premium Locked */
    .premium-locked {
        position: relative;
        opacity: 0.85;
    }
    
    .premium-locked::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 5px,
            rgba(255,255,255,0.1) 5px,
            rgba(255,255,255,0.1) 10px
        );
        pointer-events: none;
    }
    
    /* Employees Modal List */
    .employees-list-modal {
        max-height: 400px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .emp-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: #f9fafb;
        border-radius: 8px;
        transition: all 0.15s;
    }
    
    .emp-row:hover {
        background: #f3f4f6;
    }
    
    .emp-color {
        width: 8px;
        height: 32px;
        border-radius: 4px;
        flex-shrink: 0;
    }
    
    .emp-info {
        flex: 1;
        min-width: 0;
    }
    
    .emp-name {
        display: block;
        font-weight: 500;
        color: #111827;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .emp-title {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .emp-hours {
        font-size: 0.75rem;
        color: #6b7280;
        background: #e5e7eb;
        padding: 2px 8px;
        border-radius: 4px;
    }
    
    .emp-delete {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: #9ca3af;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    
    .emp-delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .empty-employees {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
    }
    
    .empty-employees span {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 10px;
    }
    
    .limit-alert {
        margin-top: 12px;
        padding: 10px 12px;
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #92400e;
    }
    
    /* Premium Modal */
    .premium-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    
    .premium-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .premium-modal {
        background: white;
        border-radius: 12px;
        max-width: 380px;
        width: 90%;
        overflow: hidden;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        transform: translateY(20px) scale(0.95);
        transition: all 0.2s;
    }
    
    .premium-modal-overlay.show .premium-modal {
        transform: translateY(0) scale(1);
    }
    
    .premium-modal-header {
        background: #fff;
        color: #111827;
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .premium-modal-header .icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }
    
    .premium-modal-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 4px 0;
    }
    
    .premium-modal-header p {
        color: #6b7280;
        margin: 0;
        font-size: 0.85rem;
    }
    
    .premium-modal-body {
        padding: 20px;
    }
    
    .premium-features {
        list-style: none;
        padding: 0;
        margin: 0 0 16px 0;
    }
    
    .premium-features li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.85rem;
        color: #374151;
    }
    
    .premium-features li:last-child {
        border-bottom: none;
    }
    
    .premium-features li::before {
        content: '‚úì';
        font-weight: 600;
        color: #16a34a;
        font-size: 1rem;
    }
    
    .premium-modal-footer {
        padding: 0 20px 20px;
        display: flex;
        gap: 10px;
    }
    
    .btn-premium-register {
        flex: 1;
        padding: 10px 16px;
        background: #16a34a;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-premium-register:hover {
        background: #15803d;
    }
    
    .btn-premium-close {
        padding: 10px 16px;
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-premium-close:hover {
        background: #e5e7eb;
    }
    
    /* Saved Schedules Modal */
    .saved-schedule-section {
        margin-bottom: 16px;
    }
    
    .saved-schedule-section .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #374151;
        margin-bottom: 12px;
    }
    
    .save-schedule-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .save-schedule-form .form-input {
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: border-color 0.15s, box-shadow 0.15s;
    }
    
    .save-schedule-form .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn-save-schedule {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.15s;
        margin-top: 8px;
    }
    
    .btn-save-schedule:hover {
        background: #2563eb;
    }
    
    .section-divider {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 20px 0;
    }
    
    .saved-schedules-filter {
        margin-bottom: 12px;
    }
    
    .saved-schedules-filter label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #6b7280;
        cursor: pointer;
    }
    
    .saved-schedules-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .saved-schedule-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #e5e7eb;
        transition: all 0.15s;
    }
    
    .saved-schedule-item:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .saved-schedule-info {
        flex: 1;
    }
    
    .saved-schedule-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #374151;
        margin-bottom: 4px;
    }
    
    .saved-schedule-meta {
        font-size: 0.75rem;
        color: #9ca3af;
    }
    
    .saved-schedule-actions {
        display: flex;
        gap: 6px;
    }
    
    .btn-schedule-action {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .btn-schedule-load {
        background: #dcfce7;
        color: #16a34a;
    }
    
    .btn-schedule-load:hover {
        background: #bbf7d0;
    }
    
    .btn-schedule-delete {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .btn-schedule-delete:hover {
        background: #fecaca;
    }
    
    .loading-placeholder, .empty-placeholder {
        text-align: center;
        padding: 20px;
        color: #9ca3af;
        font-size: 0.9rem;
    }
    
    /* Overnight Hours Modal */
    .overnight-info {
        font-size: 0.85rem;
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 16px;
        padding: 12px;
        background: #f0f9ff;
        border-radius: 6px;
        border-left: 3px solid #0ea5e9;
    }
    
    .overnight-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .overnight-option input {
        display: none;
    }
    
    .overnight-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
        background: #fff;
    }
    
    .overnight-option input:checked + .overnight-card {
        border-color: #2563eb;
        background: #eff6ff;
    }
    
    .overnight-card:hover {
        border-color: #9ca3af;
    }
    
    .overnight-icon {
        font-size: 1.4rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        border-radius: 8px;
    }
    
    .overnight-option input:checked + .overnight-card .overnight-icon {
        background: #dbeafe;
    }
    
    .overnight-text {
        flex: 1;
    }
    
    .overnight-text strong {
        display: block;
        font-size: 0.9rem;
        color: #111827;
        margin-bottom: 2px;
    }
    
    .overnight-text span {
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    /* Bulk Assign Modal */
    .employee-clickable {
        cursor: pointer;
        transition: background 0.15s;
    }
    
    .employee-clickable:hover {
        background: #f0f9ff;
    }
    
    .bulk-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .bulk-option-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
        width: 100%;
        text-align: left;
    }
    
    .bulk-option-btn:hover {
        border-color: #2563eb;
        background: #f0f9ff;
    }
    
    .bulk-option-btn .option-icon {
        font-size: 1.5rem;
    }
    
    .bulk-option-btn .option-content {
        flex: 1;
    }
    
    .bulk-option-btn .option-content strong {
        display: block;
        font-size: 0.9rem;
        color: #111827;
        margin-bottom: 2px;
    }
    
    .bulk-option-btn .option-content small {
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .bulk-option-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .bulk-option-btn:disabled:hover {
        border-color: #d1d5db;
        background: #fff;
    }
    
    .overwrite-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .overwrite-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .overwrite-checkbox .checkbox-text {
        font-size: 0.85rem;
        color: #374151;
    }
    
    /* Bulk Loading */
    .bulk-loading {
        text-align: center;
        padding: 20px;
        background: #f0f9ff;
        border-radius: 8px;
        margin-top: 16px;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 12px;
    }
    
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-text {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: #2563eb;
        margin-bottom: 6px;
    }
    
    .loading-progress {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    /* Responsive */
    @@media (max-width: 768px) {
        .app-wrapper {
            flex-direction: column;
        }
        
        .app-sidebar {
            width: 100%;
            min-width: 100%;
            max-height: none;
            flex-direction: row;
            flex-wrap: wrap;
            padding: 10px;
            gap: 8px;
        }
        
        .sidebar-actions {
            flex-direction: row;
            width: 100%;
        }
        
        .action-btn {
            flex: 1;
        }
        
        .templates-compact {
            width: 100%;
        }
        
        .multi-toggle, .selected-indicator {
            display: none;
        }
        
        .toolbar-nav,
        .toolbar-actions {
            width: 100%;
            justify-content: center;
        }
        
        .app-toolbar {
            flex-wrap: wrap;
        }
        
        .toast-notification {
            left: 20px;
            right: 20px;
            text-align: center;
        }
    }
</style>
}

@section Scripts {
<script>
    const isTurkish = @(isTurkish ? "true" : "false");
    const isRegistered = @(Model.IsRegistered ? "true" : "false");
    const texts = {
        confirmDelete: isTurkish ? 'Silmek istediƒüinize emin misiniz?' : 'Are you sure you want to delete?',
        confirmDeleteShift: isTurkish ? 'Bu n√∂beti silmek istiyor musunuz?' : 'Do you want to delete this shift?',
        selectTemplate: isTurkish ? 'L√ºtfen √∂nce bir vardiya ≈üablonu se√ßin' : 'Please select a shift template first',
        errorOccurred: isTurkish ? 'Hata olu≈ütu' : 'An error occurred',
        nameRequired: isTurkish ? 'Ad soyad gerekli' : 'Full name is required',
        dateNameRequired: isTurkish ? 'Tarih ve ad gerekli' : 'Date and name are required',
        shiftAdded: isTurkish ? 'N√∂bet eklendi' : 'Shift added',
        shiftDeleted: isTurkish ? 'N√∂bet silindi' : 'Shift deleted',
        employeeDeleted: isTurkish ? 'Personel silindi' : 'Employee deleted',
        unitNameRequired: isTurkish ? 'Birim adƒ± gerekli' : 'Unit name is required',
        unitTypeNameRequired: isTurkish ? 'Tip adƒ± gerekli' : 'Type name is required',
        unitAdded: isTurkish ? 'Birim eklendi' : 'Unit added',
        unitUpdated: isTurkish ? 'Birim g√ºncellendi' : 'Unit updated',
        unitDeleted: isTurkish ? 'Birim silindi' : 'Unit deleted',
        unitTypeAdded: isTurkish ? 'Birim tipi eklendi' : 'Unit type added',
        unitTypeUpdated: isTurkish ? 'Birim tipi g√ºncellendi' : 'Unit type updated',
        unitTypeDeleted: isTurkish ? 'Birim tipi silindi' : 'Unit type deleted',
        employeeAssigned: isTurkish ? 'Personel atandƒ±' : 'Employee assigned',
        employeeRemoved: isTurkish ? 'Personel birimden √ßƒ±karƒ±ldƒ±' : 'Employee removed from unit'
    };
    
    const canManageUnits = @(Model.CanManageUnits ? "true" : "false");
    
    // Premium Modal Functions
    function showPremiumModal() {
        const modal = document.getElementById('premiumModal');
        if (modal) modal.classList.add('show');
    }
    
    function closePremiumModal() {
        const modal = document.getElementById('premiumModal');
        if (modal) modal.classList.remove('show');
    }
    
    // Close on overlay click
    document.getElementById('premiumModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closePremiumModal();
        }
    });
    
    // ESC key closes modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePremiumModal();
        }
    });
    
    // Toggle academic title dropdown based on position type
    function toggleAcademicTitle() {
        const positionType = document.getElementById('employeePositionType')?.value;
        const academicTitleGroup = document.getElementById('academicTitleGroup');
        if (academicTitleGroup) {
            academicTitleGroup.style.display = positionType === 'Academic' ? 'block' : 'none';
            // Clear academic title if not academic
            if (positionType !== 'Academic') {
                const academicTitleSelect = document.getElementById('employeeAcademicTitle');
                if (academicTitleSelect) academicTitleSelect.value = '';
            }
        }
    }
    
    // LocalStorage key for template
    const TEMPLATE_STORAGE_KEY = 'geldimmi_selected_template';
    
    // App State
    const state = {
        selectedTemplate: null,
        selectedLeave: null, // { id, code, color }
        selectedCells: new Set(),
        multiSelectMode: false,
        bulkAssignEmployeeId: null,
        year: @Model.SelectedYear,
        month: @Model.SelectedMonth
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        initTemplates();
        initLeaves();
        initCells();
        initMultiSelect();
        initModals();
        initDeleteHandlers();
        initWeekendModeToggle();
        restoreSelectedTemplate();
        initTemplateManager();
        initSavedSchedules();
        if (canManageUnits) initUnitManagement();
        loadUserTemplates();
    });
    
    // Restore template from localStorage
    function restoreSelectedTemplate() {
        const saved = localStorage.getItem(TEMPLATE_STORAGE_KEY);
        if (saved) {
            try {
                const template = JSON.parse(saved);
                state.selectedTemplate = template;
                
                // Find and highlight the matching template button
                const buttons = document.querySelectorAll('.tpl-btn-row:not(.custom)');
                buttons.forEach(btn => {
                    if (btn.dataset.start === template.start && 
                        btn.dataset.end === template.end && 
                        (btn.dataset.spans === 'true') === template.spans) {
                        btn.classList.add('active');
                    }
                });
                
                // If custom template
                if (template.isCustom) {
                    const customBtn = document.getElementById('customTimeBtn');
                    if (customBtn) customBtn.classList.add('active');
                }
                
                // Update selected indicator
                updateSelectedIndicator(template);
            } catch (e) {
                localStorage.removeItem(TEMPLATE_STORAGE_KEY);
            }
        }
    }
    
    // Update selected template indicator
    function updateSelectedIndicator(template) {
        const indicator = document.getElementById('selectedIndicator');
        const selectedTimeEl = document.getElementById('selectedTime');
        if (!indicator) return;
        
        if (template && template.isLeave) {
            // Leave selected
            indicator.style.display = 'flex';
            const colorEl = indicator.querySelector('.indicator-color');
            if (colorEl) colorEl.style.background = template.color || '#9333ea';
            if (selectedTimeEl) selectedTimeEl.textContent = `üìã ${template.leaveCode}`;
        } else if (template && !template.isDayOff) {
            indicator.style.display = 'flex';
            const colorEl = indicator.querySelector('.indicator-color');
            if (colorEl) colorEl.style.background = template.color || '#3b82f6';
            if (selectedTimeEl) {
                selectedTimeEl.textContent = template.isCustom 
                    ? `${template.start}-${template.end}` 
                    : `${template.start}-${template.end}`;
            }
        } else if (template && template.isDayOff) {
            indicator.style.display = 'flex';
            const colorEl = indicator.querySelector('.indicator-color');
            if (colorEl) colorEl.style.background = '#94a3b8';
            if (selectedTimeEl) selectedTimeEl.textContent = isTurkish ? 'Bo≈ü G√ºn' : 'Day Off';
        } else {
            indicator.style.display = 'none';
        }
    }
    
    // Save template to localStorage
    function saveSelectedTemplate() {
        if (state.selectedTemplate) {
            localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify(state.selectedTemplate));
        }
    }
    
    // ========== Template Manager Functions ==========
    
    // Load all templates from API and render in modal
    async function loadUserTemplates() {
        try {
            const response = await fetch('/api/shift-templates');
            if (response.ok) {
                const templates = await response.json();
                renderTemplatesInModal(templates);
            }
        } catch (error) {
            console.error('Error loading templates:', error);
        }
    }
    
    // Render all templates in modal
    function renderTemplatesInModal(templates) {
        const container = document.getElementById('templatesContainerModal');
        if (!container) return;
        
        if (templates.length === 0) {
            container.innerHTML = '<div class="template-loading">' + (isTurkish ? '≈ûablon yok. ‚öôÔ∏è ile ekleyin.' : 'No templates. Add with ‚öôÔ∏è') + '</div>';
            return;
        }
        
        container.innerHTML = '';
        
        templates.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tpl-btn-row' + (t.spansNextDay ? ' overnight' : '');
            btn.dataset.id = t.id;
            btn.dataset.start = t.startTime;
            btn.dataset.end = t.endTime;
            btn.dataset.spans = t.spansNextDay;
            btn.dataset.break = t.breakMinutes || 0;
            btn.dataset.color = t.color;
            
            const breakText = t.breakMinutes ? (isTurkish ? `${t.breakMinutes}dk mola` : `${t.breakMinutes}min break`) : (t.spansNextDay ? (isTurkish ? 'Gece n√∂beti' : 'Night shift') : '');
            
            btn.innerHTML = `
                <span class="tpl-color" style="background:${t.color}"></span>
                <span class="tpl-info">
                    <span class="tpl-time">${t.startTime} - ${t.endTime}</span>
                    <span class="tpl-meta">${t.name}${breakText ? ' ‚Ä¢ ' + breakText : ''}</span>
                </span>
                ${t.spansNextDay ? '<span class="tpl-badge-new">+1</span>' : ''}
            `;
            
            // Add click handler for selection
            btn.addEventListener('click', function() {
                document.querySelectorAll('#templateListModal .tpl-btn-row').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                state.selectedTemplate = {
                    id: parseInt(this.dataset.id),
                    start: this.dataset.start,
                    end: this.dataset.end,
                    spans: this.dataset.spans === 'true',
                    breakMinutes: parseInt(this.dataset.break) || 0,
                    color: this.dataset.color || '#3B82F6',
                    isCustom: false,
                    isDayOff: false
                };
                
                updateSelectedIndicator(state.selectedTemplate);
                saveSelectedTemplate();
                
                // Close modal after selection
                const modal = bootstrap.Modal.getInstance(document.getElementById('templatesModal'));
                if (modal) modal.hide();
            });
            
            container.appendChild(btn);
        });
    }
    
    // Load templates for modal
    async function loadTemplatesForModal() {
        const container = document.getElementById('templatesContainerModal');
        if (!container) return;
        
        container.innerHTML = '<div class="template-loading">' + (isTurkish ? 'Y√ºkleniyor...' : 'Loading...') + '</div>';
        
        try {
            const response = await fetch('/api/shift-templates');
            if (response.ok) {
                const templates = await response.json();
                renderTemplatesInModal(templates);
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            container.innerHTML = '<div class="template-loading">' + (isTurkish ? 'Hata olu≈ütu' : 'Error occurred') + '</div>';
        }
    }
    
    // Initialize template manager modal
    function initTemplateManager() {
        const isRegistered = @(Model.IsRegistered ? "true" : "false");
        if (!isRegistered) return;
        
        const modal = document.getElementById('manageTemplatesModal');
        if (!modal) return;
        
        // Load templates when modal opens
        modal.addEventListener('show.bs.modal', loadTemplatesForManager);
        
        // Add new template button
        const addBtn = document.getElementById('addNewTemplateBtn');
        if (addBtn) {
            addBtn.addEventListener('click', addNewTemplate);
        }
    }
    
    // Load templates for manager modal
    async function loadTemplatesForManager() {
        const listEl = document.getElementById('templateManagerList');
        if (!listEl) return;
        
        listEl.innerHTML = '<div class="template-loading">' + (isTurkish ? 'Y√ºkleniyor...' : 'Loading...') + '</div>';
        
        try {
            const response = await fetch('/api/shift-templates');
            if (response.ok) {
                const templates = await response.json();
                renderTemplatesInManager(templates);
            }
        } catch (error) {
            listEl.innerHTML = '<div class="template-loading">' + (isTurkish ? 'Hata olu≈ütu' : 'Error occurred') + '</div>';
        }
    }
    
    // Render templates in manager modal
    function renderTemplatesInManager(templates) {
        const listEl = document.getElementById('templateManagerList');
        if (!listEl) return;
        
        if (templates.length === 0) {
            listEl.innerHTML = '<div class="template-loading">' + (isTurkish ? 'Hen√ºz ≈üablon yok. A≈üaƒüƒ±dan ekleyin.' : 'No templates yet. Add below.') + '</div>';
            return;
        }
        
        listEl.innerHTML = templates.map(t => `
            <div class="template-manager-item" data-id="${t.id}">
                <span class="tpl-item-color" style="background:${t.color}"></span>
                <div class="tpl-item-info">
                    <div class="tpl-item-name">${t.name || (t.startTime + ' - ' + t.endTime)}</div>
                    <div class="tpl-item-time">${t.startTime} - ${t.endTime} ${t.spansNextDay ? '(+1)' : ''} ‚Ä¢ ${t.breakMinutes || 0}${isTurkish ? 'dk mola' : 'min break'}</div>
                </div>
                <div class="tpl-item-actions">
                    <button class="btn-edit" onclick="editTemplate(${t.id})" title="${isTurkish ? 'D√ºzenle' : 'Edit'}">‚úèÔ∏è</button>
                    <button class="btn-delete" onclick="deleteTemplate(${t.id})" title="${isTurkish ? 'Sil' : 'Delete'}">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }
    
    // Add new template
    async function addNewTemplate() {
        const name = document.getElementById('newTemplateName').value.trim();
        const startTime = document.getElementById('newTemplateStart').value;
        const endTime = document.getElementById('newTemplateEnd').value;
        const breakMinutes = parseInt(document.getElementById('newTemplateBreak').value) || 0;
        const color = document.getElementById('newTemplateColor').value;
        const spansNextDay = document.getElementById('newTemplateSpans').checked;
        
        if (!name) {
            showToast(isTurkish ? '≈ûablon adƒ± gerekli' : 'Template name is required', 'error');
            return;
        }
        
        if (!startTime || !endTime) {
            showToast(isTurkish ? 'Ba≈ülangƒ±√ß ve biti≈ü saati gerekli' : 'Start and end time are required', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/shift-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    startTime,
                    endTime,
                    breakMinutes,
                    color,
                    spansNextDay,
                    displayOrder: 100
                })
            });
            
            if (response.ok) {
                showToast(isTurkish ? '≈ûablon eklendi' : 'Template added', 'success');
                // Clear form
                document.getElementById('newTemplateName').value = '';
                document.getElementById('newTemplateStart').value = '08:00';
                document.getElementById('newTemplateEnd').value = '17:00';
                document.getElementById('newTemplateBreak').value = '60';
                document.getElementById('newTemplateColor').value = '#3B82F6';
                document.getElementById('newTemplateSpans').checked = false;
                // Reload lists
                loadTemplatesForManager();
                loadUserTemplates();
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    // Delete template
    async function deleteTemplate(id) {
        if (!confirm(isTurkish ? 'Bu ≈üablonu silmek istediƒüinize emin misiniz?' : 'Are you sure you want to delete this template?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/shift-templates/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showToast(isTurkish ? '≈ûablon silindi' : 'Template deleted', 'success');
                loadTemplatesForManager();
                loadUserTemplates();
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    // Edit template (simple prompt-based for now)
    async function editTemplate(id) {
        const item = document.querySelector(`.template-manager-item[data-id="${id}"]`);
        if (!item) return;
        
        const nameEl = item.querySelector('.tpl-item-name');
        const currentName = nameEl ? nameEl.textContent : '';
        
        const newName = prompt(isTurkish ? 'Yeni ≈üablon adƒ±:' : 'New template name:', currentName);
        if (!newName || newName === currentName) return;
        
        // Get current template data from the item
        const timeText = item.querySelector('.tpl-item-time').textContent;
        const match = timeText.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
        if (!match) return;
        
        const colorEl = item.querySelector('.tpl-item-color');
        const color = colorEl ? rgbToHex(getComputedStyle(colorEl).backgroundColor) : '#3B82F6';
        const spansNextDay = timeText.includes('(+1)');
        const breakMatch = timeText.match(/(\d+)(dk|min)/);
        const breakMinutes = breakMatch ? parseInt(breakMatch[1]) : 0;
        
        try {
            const response = await fetch(`/api/shift-templates/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: newName,
                    startTime: match[1],
                    endTime: match[2],
                    breakMinutes,
                    color,
                    spansNextDay,
                    displayOrder: 100
                })
            });
            
            if (response.ok) {
                showToast(isTurkish ? '≈ûablon g√ºncellendi' : 'Template updated', 'success');
                loadTemplatesForManager();
                loadUserTemplates();
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    // Helper: RGB to Hex
    function rgbToHex(rgb) {
        if (rgb.startsWith('#')) return rgb;
        const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (!match) return '#3B82F6';
        return '#' + [match[1], match[2], match[3]].map(x => {
            const hex = parseInt(x).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        }).join('');
    }
    
    // Make functions globally available for onclick handlers
    window.deleteTemplate = deleteTemplate;
    window.editTemplate = editTemplate;
    
    // ========== End Template Manager Functions ==========
    
    // ========== Saved Schedules Functions ==========
    
    function initSavedSchedules() {
        const isRegistered = @(Model.IsRegistered ? "true" : "false");
        if (!isRegistered) return;
        
        const modal = document.getElementById('savedSchedulesModal');
        if (!modal) return;
        
        // Load schedules when modal opens
        modal.addEventListener('show.bs.modal', loadSavedSchedules);
        
        // Save schedule button
        const saveBtn = document.getElementById('saveScheduleBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveCurrentSchedule);
        }
        
        // Filter checkbox
        const filterCheckbox = document.getElementById('filterCurrentMonthOnly');
        if (filterCheckbox) {
            filterCheckbox.addEventListener('change', loadSavedSchedules);
        }
    }
    
    async function loadSavedSchedules() {
        const listEl = document.getElementById('savedSchedulesList');
        if (!listEl) return;
        
        listEl.innerHTML = '<div class="loading-placeholder">' + (isTurkish ? 'Y√ºkleniyor...' : 'Loading...') + '</div>';
        
        try {
            const filterCurrentMonth = document.getElementById('filterCurrentMonthOnly')?.checked;
            let url = '/api/saved-schedules';
            
            if (filterCurrentMonth) {
                url += `?year=${state.year}&month=${state.month}`;
            }
            
            const response = await fetch(url);
            if (response.ok) {
                const schedules = await response.json();
                renderSavedSchedules(schedules);
            } else {
                listEl.innerHTML = '<div class="empty-placeholder">' + (isTurkish ? 'Hata olu≈ütu' : 'Error occurred') + '</div>';
            }
        } catch (error) {
            listEl.innerHTML = '<div class="empty-placeholder">' + (isTurkish ? 'Hata olu≈ütu' : 'Error occurred') + '</div>';
        }
    }
    
    function renderSavedSchedules(schedules) {
        const listEl = document.getElementById('savedSchedulesList');
        if (!listEl) return;
        
        if (schedules.length === 0) {
            listEl.innerHTML = '<div class="empty-placeholder">' + 
                (isTurkish ? 'Hen√ºz kayƒ±tlƒ± liste yok' : 'No saved schedules yet') + 
                '</div>';
            return;
        }
        
        const months = isTurkish 
            ? ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k']
            : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        listEl.innerHTML = schedules.map(s => `
            <div class="saved-schedule-item" data-id="${s.id}">
                <div class="saved-schedule-info">
                    <div class="saved-schedule-name">${s.name}</div>
                    <div class="saved-schedule-meta">
                        ${months[s.month - 1]} ${s.year} ‚Ä¢ ${isTurkish ? 'Kaydedildi:' : 'Saved:'} ${s.createdAt}
                        ${s.description ? '<br><em>' + s.description + '</em>' : ''}
                    </div>
                </div>
                <div class="saved-schedule-actions">
                    <button class="btn-schedule-action btn-schedule-load" onclick="loadSchedule(${s.id}, ${s.year}, ${s.month})">
                        ${isTurkish ? 'Y√ºkle' : 'Load'}
                    </button>
                    <button class="btn-schedule-action btn-schedule-delete" onclick="deleteSchedule(${s.id})">
                        ${isTurkish ? 'Sil' : 'Delete'}
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    async function saveCurrentSchedule() {
        const nameInput = document.getElementById('scheduleNameInput');
        const descInput = document.getElementById('scheduleDescInput');
        
        const name = nameInput?.value.trim();
        if (!name) {
            showToast(isTurkish ? 'Liste adƒ± gerekli' : 'Schedule name is required', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/saved-schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    year: state.year,
                    month: state.month,
                    description: descInput?.value.trim() || null
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast(result.message || (isTurkish ? 'Kaydedildi' : 'Saved'), 'success');
                nameInput.value = '';
                if (descInput) descInput.value = '';
                loadSavedSchedules();
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    async function loadSchedule(id, year, month) {
        if (!confirm(isTurkish 
            ? 'Bu liste y√ºklenirse mevcut n√∂betler silinecek. Devam etmek istiyor musunuz?' 
            : 'Loading this schedule will replace current shifts. Continue?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/saved-schedules/${id}/load`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast(result.message, 'success');
                
                // Close modal and reload the page to show loaded shifts
                const modal = bootstrap.Modal.getInstance(document.getElementById('savedSchedulesModal'));
                if (modal) modal.hide();
                
                // If the saved schedule is for a different month, navigate there
                if (year !== state.year || month !== state.month) {
                    window.location.href = `/app?year=${year}&month=${month}`;
                } else {
                    window.location.reload();
                }
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    async function deleteSchedule(id) {
        if (!confirm(isTurkish ? 'Bu kaydƒ± silmek istediƒüinize emin misiniz?' : 'Are you sure you want to delete this saved schedule?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/saved-schedules/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showToast(isTurkish ? 'Silindi' : 'Deleted', 'success');
                loadSavedSchedules();
            } else {
                const error = await response.json();
                showToast(error.error || (isTurkish ? 'Hata olu≈ütu' : 'Error occurred'), 'error');
            }
        } catch (error) {
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    // Make functions globally available for onclick handlers
    window.loadSchedule = loadSchedule;
    window.deleteSchedule = deleteSchedule;
    
    // ========== End Saved Schedules Functions ==========
    
    // Template Selection
    function initTemplates() {
        // Initialize templates modal
        const templatesModal = document.getElementById('templatesModal');
        if (templatesModal) {
            templatesModal.addEventListener('show.bs.modal', loadTemplatesForModal);
        }
        
        // Template selection in modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('#templateListModal .tpl-btn-row:not(.custom)')) {
                const btn = e.target.closest('.tpl-btn-row');
                document.querySelectorAll('#templateListModal .tpl-btn-row').forEach(b => b.classList.remove('active'));
                // Deselect any selected leave
                document.querySelectorAll('.leave-btn-modal').forEach(b => b.classList.remove('active'));
                state.selectedLeave = null;
                
                btn.classList.add('active');
                
                state.selectedTemplate = {
                    id: btn.dataset.id ? parseInt(btn.dataset.id) : null,
                    start: btn.dataset.start,
                    end: btn.dataset.end,
                    spans: btn.dataset.spans === 'true',
                    breakMinutes: parseInt(btn.dataset.break) || 0,
                    color: btn.dataset.color || '#3B82F6',
                    isCustom: false,
                    isDayOff: btn.dataset.dayOff === 'true'
                };
                
                saveSelectedTemplate();
                updateSelectedIndicator(state.selectedTemplate);
                
                // Close modal after selection
                const modal = bootstrap.Modal.getInstance(templatesModal);
                if (modal) modal.hide();
            }
        });
        
        // Day off button in modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('#templateListModal .tpl-btn-row.day-off')) {
                const btn = e.target.closest('.tpl-btn-row');
                document.querySelectorAll('#templateListModal .tpl-btn-row').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.leave-btn-modal').forEach(b => b.classList.remove('active'));
                state.selectedLeave = null;
                
                btn.classList.add('active');
                
                state.selectedTemplate = {
                    start: btn.dataset.start,
                    end: btn.dataset.end,
                    spans: btn.dataset.spans === 'true',
                    breakMinutes: parseInt(btn.dataset.break) || 0,
                    color: btn.dataset.color || '#94a3b8',
                    isCustom: false,
                    isDayOff: true
                };
                
                saveSelectedTemplate();
                updateSelectedIndicator(state.selectedTemplate);
                
                const modal = bootstrap.Modal.getInstance(templatesModal);
                if (modal) modal.hide();
            }
        });
        
        // Custom time button in modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('#customTimeBtnModal')) {
                const customTimeModal = document.getElementById('customTimeModal');
                if (customTimeModal) {
                    // Reset modal when it opens
                    const resetModal = () => {
                        const startInput = document.getElementById('customStartTime');
                        const endInput = document.getElementById('customEndTime');
                        const breakInput = document.getElementById('customBreak');
                        const spansCheckbox = document.getElementById('customSpansNextDay');
                        
                        if (startInput) startInput.value = '08:00';
                        if (endInput) endInput.value = '17:00';
                        if (breakInput) breakInput.value = '0';
                        if (spansCheckbox) spansCheckbox.checked = false;
                        
                        // Reset break buttons - set 0 dk as active
                        document.querySelectorAll('.break-btn[data-break]').forEach(b => b.classList.remove('active'));
                        const zeroBreakBtn = document.querySelector('.break-btn[data-break="0"]');
                        if (zeroBreakBtn) zeroBreakBtn.classList.add('active');
                    };
                    
                    customTimeModal.addEventListener('show.bs.modal', resetModal, { once: true });
                    new bootstrap.Modal(customTimeModal).show();
                }
            }
        });
        
        const applyCustomTimeBtn = document.getElementById('applyCustomTimeBtn');
        if (applyCustomTimeBtn) {
            applyCustomTimeBtn.addEventListener('click', function() {
                state.selectedTemplate = {
                    start: document.getElementById('customStartTime').value,
                    end: document.getElementById('customEndTime').value,
                    spans: document.getElementById('customSpansNextDay').checked,
                    breakMinutes: parseInt(document.getElementById('customBreak').value) || 0,
                    color: '#64748B',
                    isCustom: true
                };
                
                document.querySelectorAll('#templateListModal .tpl-btn-row').forEach(b => b.classList.remove('active'));
                const customBtn = document.getElementById('customTimeBtnModal');
                if (customBtn) customBtn.classList.add('active');
                
                saveSelectedTemplate();
                updateSelectedIndicator(state.selectedTemplate);
                const customModal = bootstrap.Modal.getInstance(document.getElementById('customTimeModal'));
                if (customModal) customModal.hide();
                
                // Close templates modal after custom time selection
                const templatesModal = bootstrap.Modal.getInstance(document.getElementById('templatesModal'));
                if (templatesModal) templatesModal.hide();
            });
        }
        
        // Break button click handlers
        document.querySelectorAll('.break-btn[data-break]').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = this.dataset.break;
                document.getElementById('customBreak').value = value;
                
                // Update active state
                document.querySelectorAll('.break-btn[data-break]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Custom break input - update button active states
        const customBreakInput = document.getElementById('customBreak');
        if (customBreakInput) {
            customBreakInput.addEventListener('input', function() {
                const value = this.value;
                const predefinedValues = ['0', '30', '60', '90'];
                
                document.querySelectorAll('.break-btn[data-break]').forEach(btn => {
                    if (btn.dataset.break === value) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
        }
        
        // Overnight Hours Modal - confirm button
        const confirmOvernightBtn = document.getElementById('confirmOvernightBtn');
        if (confirmOvernightBtn) {
            confirmOvernightBtn.addEventListener('click', function() {
                if (pendingOvernightShift) {
                    const selectedMode = document.querySelector('input[name="overnightMode"]:checked').value;
                    const { employeeId, date, cell, skipToast } = pendingOvernightShift;
                    
                    bootstrap.Modal.getInstance(document.getElementById('overnightHoursModal')).hide();
                    
                    // Call createShift with selected overnight mode
                    createShift(employeeId, date, cell, skipToast, parseInt(selectedMode));
                }
            });
        }
        
        // Cancel overnight modal - clear pending
        const overnightHoursModal = document.getElementById('overnightHoursModal');
        if (overnightHoursModal) {
            overnightHoursModal.addEventListener('hidden.bs.modal', function() {
                if (pendingOvernightShift) {
                    pendingOvernightShift = null;
                }
            });
        }
    }
    
    // Initialize Leaves
    function initLeaves() {
        // Leave button click in modal
        document.addEventListener('click', function(e) {
            if (e.target.closest('.leave-btn-modal')) {
                const btn = e.target.closest('.leave-btn-modal');
                
                // Deselect any selected template
                document.querySelectorAll('#templateListModal .tpl-btn-row').forEach(b => b.classList.remove('active'));
                state.selectedTemplate = null;
                
                // Toggle leave selection
                const isAlreadySelected = btn.classList.contains('active');
                document.querySelectorAll('.leave-btn-modal').forEach(b => b.classList.remove('active'));
                
                if (isAlreadySelected) {
                    state.selectedLeave = null;
                    updateSelectedIndicator(null);
                } else {
                    btn.classList.add('active');
                    btn.style.setProperty('--leave-color', btn.dataset.leaveColor);
                    state.selectedLeave = {
                        id: parseInt(btn.dataset.leaveId),
                        code: btn.dataset.leaveCode,
                        color: btn.dataset.leaveColor
                    };
                    updateSelectedIndicator({ isLeave: true, leaveCode: state.selectedLeave.code, color: state.selectedLeave.color });
                    
                    // Close modal after selection
                    const modal = bootstrap.Modal.getInstance(document.getElementById('leavesModal'));
                    if (modal) modal.hide();
                }
            }
        });
    }
    
    // Cell Click
    function initCells() {
        document.querySelectorAll('.shift-cell').forEach(cell => {
            cell.addEventListener('click', async function(e) {
                const shiftBadge = e.target.closest('.shift-badge');
                const leaveBadge = e.target.closest('.leave-badge');
                
                // Delete leave if clicking on leave badge
                if (leaveBadge) {
                    if (confirm(isTurkish ? 'ƒ∞zni silmek istediƒüinize emin misiniz?' : 'Are you sure you want to delete this leave?')) {
                        const leaveId = leaveBadge.dataset.leaveId;
                        await deleteLeave(leaveId, this);
                    }
                    return;
                }
                
                // Delete shift if clicking on shift badge
                if (shiftBadge) {
                    if (confirm(texts.confirmDeleteShift)) {
                        const employeeId = this.dataset.employeeId;
                        const date = this.dataset.date;
                        await deleteShift(employeeId, date, this);
                    }
                    return;
                }
                
                // Multi-select mode
                if (state.multiSelectMode) {
                    this.classList.toggle('selected');
                    // Use pipe separator to avoid conflicts with date format (YYYY-MM-DD)
                    const key = `${this.dataset.employeeId}|${this.dataset.date}`;
                    if (this.classList.contains('selected')) {
                        state.selectedCells.add(key);
                    } else {
                        state.selectedCells.delete(key);
                    }
                    updateToolbarButtons();
                    return;
                }
                
                // Single click - create leave or shift
                if (state.selectedLeave) {
                    // Create leave
                    await createLeave(this.dataset.employeeId, this.dataset.date, this);
                } else if (state.selectedTemplate) {
                    // Create shift
                    await createShift(this.dataset.employeeId, this.dataset.date, this);
                } else {
                    alert(isTurkish ? 'L√ºtfen bir vardiya ≈üablonu veya izin t√ºr√º se√ßin' : 'Please select a shift template or leave type');
                }
            });
        });
        
        // Employee name click - bulk assign
        document.querySelectorAll('.employee-clickable').forEach(empCell => {
            empCell.addEventListener('click', function(e) {
                // Don't open if clicking on a shift cell
                if (e.target.closest('.shift-cell')) return;
                
                const employeeId = this.dataset.employeeId;
                const employeeName = this.dataset.employeeName;
                
                // Check if template is selected
                if (!state.selectedTemplate) {
                    alert(texts.selectTemplate);
                    return;
                }
                
                // Set modal title
                document.getElementById('bulkAssignEmployeeName').textContent = employeeName;
                
                // Set template info with visual highlighting
                const templateInfo = state.selectedTemplate.isDayOff 
                    ? (isTurkish ? 'üö´ Bo≈ü G√ºn' : 'üö´ Day Off')
                    : `${state.selectedTemplate.start} - ${state.selectedTemplate.end}`;
                document.getElementById('bulkAssignTemplateInfo').textContent = templateInfo;
                
                // Visual highlight for selected template
                const templateBox = document.getElementById('bulkAssignTemplateBox');
                const templateBadge = document.getElementById('bulkAssignTemplateBadge');
                const templateColor = document.getElementById('bulkAssignTemplateColor');
                const templateTime = document.getElementById('bulkAssignTemplateTime');
                const templateIcon = document.getElementById('bulkAssignTemplateIcon');
                
                if (templateBox && templateBadge && templateColor && templateTime) {
                    // Highlight the box
                    templateBox.style.border = `2px solid ${state.selectedTemplate.color || '#3b82f6'}`;
                    templateBox.style.backgroundColor = `${state.selectedTemplate.color || '#3b82f6'}15`;
                    
                    // Show badge with template preview
                    templateBadge.style.display = 'flex';
                    templateColor.style.background = state.selectedTemplate.color || '#3b82f6';
                    templateTime.textContent = templateInfo;
                    
                    // Update icon
                    if (templateIcon) {
                        templateIcon.textContent = state.selectedTemplate.isDayOff ? 'üö´' : '‚è∞';
                    }
                }
                
                // Also highlight the selected template in the sidebar
                document.querySelectorAll('.tpl-btn-row').forEach(btn => {
                    btn.classList.remove('active');
                    const btnId = btn.dataset.id;
                    const btnStart = btn.dataset.start;
                    const btnEnd = btn.dataset.end;
                    const btnDayOff = btn.dataset.dayOff === 'true';
                    
                    // Match by ID if available (for loaded templates)
                    if (state.selectedTemplate.id && btnId && parseInt(btnId) === state.selectedTemplate.id) {
                        btn.classList.add('active');
                    } 
                    // Match by time and day off status (for default templates)
                    else if (state.selectedTemplate.isDayOff && btnDayOff) {
                        btn.classList.add('active');
                    } else if (!state.selectedTemplate.isDayOff && !btnDayOff && 
                               btnStart === state.selectedTemplate.start && 
                               btnEnd === state.selectedTemplate.end) {
                        btn.classList.add('active');
                    }
                    // Match custom template
                    else if (state.selectedTemplate.isCustom && btn.classList.contains('custom')) {
                        btn.classList.add('active');
                    }
                });
                
                // Store current employee in state
                state.bulkAssignEmployeeId = employeeId;
                
                // Show modal
                new bootstrap.Modal(document.getElementById('bulkAssignModal')).show();
            });
        });
    }
    
    // Multi-select Mode
    function initMultiSelect() {
        const toggle = document.getElementById('multiSelectMode');
        const clearBtn = document.getElementById('clearSelectionBtn');
        const applyBtn = document.getElementById('applyToSelectedBtn');
        
        if (toggle) {
            toggle.addEventListener('change', function() {
                state.multiSelectMode = this.checked;
                if (!this.checked) {
                    clearSelection();
                }
                updateToolbarButtons();
            });
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearSelection);
        }
        
        if (applyBtn) {
            applyBtn.addEventListener('click', async function() {
            if (!state.selectedTemplate) {
                alert(texts.selectTemplate);
                return;
            }
            
            const promises = [];
            for (const key of state.selectedCells) {
                // Use pipe separator to split employeeId and date (date format is YYYY-MM-DD)
                const [employeeId, date] = key.split('|');
                const cell = document.querySelector(`.shift-cell[data-employee-id="${employeeId}"][data-date="${date}"]`);
                if (!cell) {
                    console.error(`Cell not found for employeeId: ${employeeId}, date: ${date}`);
                    continue;
                }
                promises.push(createShift(employeeId, date, cell, true));
            }
            
                await Promise.all(promises);
                clearSelection();
                showToast(isTurkish ? 'N√∂betler eklendi!' : 'Shifts added!', 'success');
            });
        }
    }
    
    function clearSelection() {
        document.querySelectorAll('.shift-cell.selected').forEach(cell => {
            cell.classList.remove('selected');
        });
        state.selectedCells.clear();
        updateToolbarButtons();
    }
    
    function updateToolbarButtons() {
        const hasSelection = state.selectedCells.size > 0;
        const isMultiSelectMode = state.multiSelectMode;
        const clearBtn = document.getElementById('clearSelectionBtn');
        const applyBtn = document.getElementById('applyToSelectedBtn');
        
        // Only show buttons if multi-select mode is active AND there are selected cells
        const shouldShow = isMultiSelectMode && hasSelection;
        
        if (clearBtn) clearBtn.style.display = shouldShow ? 'block' : 'none';
        if (applyBtn) applyBtn.style.display = shouldShow ? 'block' : 'none';
    }
    
    // Check if date is last day of month
    function isLastDayOfMonth(dateStr) {
        const date = new Date(dateStr);
        const nextDay = new Date(date);
        nextDay.setDate(nextDay.getDate() + 1);
        return nextDay.getMonth() !== date.getMonth();
    }
    
    // Pending overnight shift data
    let pendingOvernightShift = null;
    
    // API Calls - NO PAGE RELOAD!
    async function createShift(employeeId, date, cell, skipToast = false, overnightHoursMode = null) {
        // Check if it's last day of month AND shift spans to next day - show modal to select mode
        if (state.selectedTemplate.spans && isLastDayOfMonth(date) && overnightHoursMode === null && !pendingOvernightShift) {
            // Store pending data and show modal
            pendingOvernightShift = { employeeId, date, cell, skipToast };
            new bootstrap.Modal(document.getElementById('overnightHoursModal')).show();
            return;
        }
        
        // Default to 0 (split at midnight) if not specified
        if (overnightHoursMode === null) overnightHoursMode = 0;
        
        const data = {
            employeeId: parseInt(employeeId),
            date: date,
            startTime: state.selectedTemplate.start,
            endTime: state.selectedTemplate.end,
            spansNextDay: state.selectedTemplate.spans,
            breakMinutes: state.selectedTemplate.breakMinutes || 0,
            isDayOff: state.selectedTemplate.isDayOff || false,
            overnightHoursMode: overnightHoursMode
        };
        
        try {
            const response = await fetch('/api/shifts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                // Update UI without page reload - use server calculated hours
                const templateWithServerHours = {
                    ...state.selectedTemplate,
                    serverTotalHours: result.totalHours,
                    isDayOff: result.isDayOff
                };
                updateCellWithShift(cell, templateWithServerHours);
                if (!skipToast) {
                    showToast(texts.shiftAdded, 'success');
                }
                return { success: true };
            } else if (response.status === 400) {
                const errorResult = await response.json();
                if (errorResult.error === 'overlap') {
                    if (!skipToast) {
                        showToast(isTurkish ? '‚ö†Ô∏è N√∂bet √ßakƒ±≈ümasƒ±: ' + errorResult.message : '‚ö†Ô∏è Shift overlap: ' + errorResult.message, 'error');
                    }
                    return { success: false, overlap: true, message: errorResult.message };
                }
            }
            return { success: false };
        } catch (error) {
            console.error('Error creating shift:', error);
            showToast(texts.errorOccurred, 'error');
            return { success: false };
        }
        
        // Clear pending data
        pendingOvernightShift = null;
    }
    
    async function deleteShift(employeeId, date, cell) {
        try {
            const response = await fetch(`/api/shifts/employee/${employeeId}/date/${date}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                // Update UI without page reload - use server's totalHours
                clearCellShift(cell, employeeId, date, result.totalHours, result.isDayOff, result.spansNextDay);
                showToast(texts.shiftDeleted, 'info');
            }
        } catch (error) {
            console.error('Error deleting shift:', error);
            showToast(texts.errorOccurred, 'error');
        }
    }
    
    // Create Leave
    async function createLeave(employeeId, date, cell) {
        if (!state.selectedLeave) return;
        
        // Check existing content before creating leave
        const existingLeave = cell.querySelector('.leave-badge');
        const existingShift = cell.querySelector('.shift-badge:not(.day-off)');
        const existingDayOff = cell.querySelector('.shift-badge.day-off');
        const hadLeave = existingLeave !== null;
        const hadShift = existingShift !== null;
        const hadDayOff = existingDayOff !== null;
        
        // Get shift hours if there was a shift (to subtract from worked)
        let shiftHours = 0;
        if (hadShift) {
            const hoursEl = existingShift.querySelector('.hours');
            if (hoursEl) {
                const hoursText = hoursEl.textContent.replace('s', '').replace('h', '').trim();
                shiftHours = parseFloat(hoursText) || 0;
            }
        }
        
        try {
            const response = await fetch('/api/leaves', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employeeId: parseInt(employeeId),
                    leaveTypeId: state.selectedLeave.id,
                    date: date
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                // Update UI - use correct code based on language
                const displayCode = isTurkish ? result.leaveCode : result.leaveCodeEn;
                updateCellWithLeave(cell, result.id, displayCode, result.leaveColor);
                
                // Update hours based on what was replaced
                if (hadShift && shiftHours > 0) {
                    // Had a normal shift - remove worked hours and reduce required
                    updateEmployeeTotalHours(employeeId, shiftHours, false, false); // Remove worked hours
                    updateEmployeeTotalHours(employeeId, { isDayOff: true }, true); // Reduce required
                } else if (!hadLeave && !hadDayOff) {
                    // Empty cell or no day off - just reduce required hours
                    updateEmployeeTotalHours(employeeId, { isDayOff: true }, true);
                }
                // If hadLeave or hadDayOff, required hours were already reduced
                
                showToast(isTurkish ? 'ƒ∞zin atandƒ±' : 'Leave assigned', 'success');
            } else {
                const error = await response.json();
                showToast(error.error || texts.errorOccurred, 'error');
            }
        } catch (error) {
            console.error('Error creating leave:', error);
            showToast(texts.errorOccurred, 'error');
        }
    }
    
    // Delete Leave
    async function deleteLeave(leaveId, cell) {
        // Get employeeId before deleting
        const employeeId = cell.dataset.employeeId;
        
        try {
            const response = await fetch(`/api/leaves/${leaveId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Clear cell content
                clearCellLeave(cell);
                
                // Add back required hours (like removing a day off)
                updateEmployeeTotalHours(employeeId, null, false, true); // wasDayOff = true
                
                showToast(isTurkish ? 'ƒ∞zin silindi' : 'Leave deleted', 'info');
            }
        } catch (error) {
            console.error('Error deleting leave:', error);
            showToast(texts.errorOccurred, 'error');
        }
    }
    
    // Update cell UI with leave badge
    function updateCellWithLeave(cell, leaveId, leaveCode, leaveColor) {
        // Clear existing badges (except continuation)
        const existingContinuation = cell.querySelector('.shift-continuation');
        cell.innerHTML = '';
        if (existingContinuation) {
            cell.appendChild(existingContinuation);
        }
        
        const badge = document.createElement('div');
        badge.className = 'leave-badge';
        badge.style.background = leaveColor;
        badge.textContent = leaveCode;
        badge.dataset.leaveId = leaveId; // Important: Set leave ID for deletion
        
        cell.appendChild(badge);
    }
    
    // Clear leave from cell
    function clearCellLeave(cell) {
        const leaveBadge = cell.querySelector('.leave-badge');
        if (leaveBadge) {
            leaveBadge.remove();
        }
    }
    
    // Calculate shift hours
    function calculateShiftHours(startTime, endTime, spansNextDay, breakMinutes = 0) {
        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);
        
        let startMinutes = startH * 60 + startM;
        let endMinutes = endH * 60 + endM;
        
        if (spansNextDay || endMinutes <= startMinutes) {
            endMinutes += 24 * 60; // Add 24 hours
        }
        
        const totalMinutes = endMinutes - startMinutes - breakMinutes;
        return Math.max(0, totalMinutes / 60);
    }
    
    // Update cell UI after shift creation - matching server-rendered style
    function updateCellWithShift(cell, template) {
        const color = template.color || '#3B82F6';
        const employeeId = cell.dataset.employeeId;
        const date = cell.dataset.date;
        
        // Clear existing content (but keep continuation if any)
        const existingContinuation = cell.querySelector('.shift-continuation');
        cell.innerHTML = '';
        if (existingContinuation) {
            cell.appendChild(existingContinuation);
        }
        
        // Create badge
        const badge = document.createElement('div');
        
        if (template.isDayOff) {
            // Day Off special styling
            badge.className = 'shift-badge day-off';
            badge.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
            badge.style.borderColor = '#94a3b8';
            badge.style.color = '#64748b';
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'day-off-icon';
            iconSpan.textContent = 'üö´';
            badge.appendChild(iconSpan);
            
            const textSpan = document.createElement('span');
            textSpan.className = 'day-off-text';
            textSpan.textContent = isTurkish ? 'Bo≈ü' : 'Off';
            badge.appendChild(textSpan);
        } else {
            // Normal shift styling
            badge.className = 'shift-badge' + (template.spans ? ' overnight' : '');
            badge.style.background = `${color}20`;
            badge.style.borderColor = color;
            badge.style.color = color;
            
            const startSpan = document.createElement('span');
            startSpan.className = 'shift-start';
            startSpan.textContent = template.start;
            badge.appendChild(startSpan);
            
            const endSpan = document.createElement('span');
            endSpan.className = 'shift-end';
            endSpan.textContent = template.end;
            badge.appendChild(endSpan);
            
            if (template.spans) {
                const overnightBadge = document.createElement('span');
                overnightBadge.className = 'overnight-badge';
                overnightBadge.textContent = '+1';
                badge.appendChild(overnightBadge);
                
                // Add continuation to next day cell
                addNextDayContinuation(employeeId, date, template);
            }
        }
        
        cell.appendChild(badge);
        
        // Update total hours for this employee
        updateEmployeeTotalHours(employeeId, template, true);
    }
    
    // Add continuation indicator to next day
    function addNextDayContinuation(employeeId, date, template) {
        const currentDate = new Date(date);
        currentDate.setDate(currentDate.getDate() + 1);
        const nextDateStr = currentDate.toISOString().split('T')[0];
        
        // Find next day cell for same employee using employeeId directly
        const nextCell = document.querySelector(`.shift-cell[data-employee-id="${employeeId}"][data-date="${nextDateStr}"]`);
        
        if (nextCell) {
            // Remove existing continuation if any
            const existingCont = nextCell.querySelector('.shift-continuation');
            if (existingCont) existingCont.remove();
            
            const color = template.color || '#EF4444';
            const continuation = document.createElement('div');
            continuation.className = 'shift-continuation';
            continuation.style.background = `${color}20`;
            continuation.style.borderColor = color;
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'cont-icon';
            iconSpan.textContent = '‚Üì';
            continuation.appendChild(iconSpan);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'cont-time';
            timeSpan.textContent = template.end;
            continuation.appendChild(timeSpan);
            
            nextCell.insertBefore(continuation, nextCell.firstChild);
        }
    }
    
    // Clear cell shift
    // clearCellShift now receives data from backend
    function clearCellShift(cell, employeeId, date, serverTotalHours, wasDayOff, wasOvernight) {
        // Remove next day continuation if it was an overnight shift
        if (wasOvernight) {
            const currentDate = new Date(date);
            currentDate.setDate(currentDate.getDate() + 1);
            const nextDateStr = currentDate.toISOString().split('T')[0];
            const nextCell = document.querySelector(`.shift-cell[data-employee-id="${employeeId}"][data-date="${nextDateStr}"]`);
            if (nextCell) {
                const cont = nextCell.querySelector('.shift-continuation');
                if (cont) cont.remove();
            }
        }
        
        // Clear only shift badge, keep continuation if from previous day
        const shiftBadge = cell.querySelector('.shift-badge');
        if (shiftBadge) shiftBadge.remove();
        
        // Update total hours using server's calculated value (includes break deduction)
        updateEmployeeTotalHours(employeeId, serverTotalHours, false, wasDayOff);
    }
    
    // Update employee total hours display
    // For adding: templateOrHours is a template object
    // For removing: templateOrHours is the hours to subtract (number)
    function updateEmployeeTotalHours(employeeId, templateOrHours, isAdding, wasDayOff = false) {
        const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
        if (!row) return;
        
        const totalCell = row.querySelector('.col-total .total-cell');
        if (!totalCell) return;
        
        const workedSpan = totalCell.querySelector('.worked-hours');
        const requiredSpan = totalCell.querySelector('.required-hours');
        const diffSpan = totalCell.querySelector('.diff-hours');
        
        if (!workedSpan || !requiredSpan) return;
        
        let worked = parseFloat(workedSpan.textContent) || 0;
        let required = parseFloat(requiredSpan.textContent) || 0;
        
        // Get employee daily hours from data attribute
        const employeeItem = document.querySelector(`.employee-item[data-employee-id="${employeeId}"]`);
        const dailyHours = employeeItem ? parseFloat(employeeItem.dataset.dailyHours) || 8 : 8;
        
        if (isAdding) {
            if (templateOrHours && typeof templateOrHours === 'object') {
                // Adding a shift
                if (templateOrHours.isDayOff) {
                    // Day off - reduce required hours by daily work hours
                    required -= dailyHours;
                } else {
                    // Normal shift - use server calculated hours if available, otherwise calculate
                    const hours = templateOrHours.serverTotalHours !== undefined 
                        ? templateOrHours.serverTotalHours 
                        : calculateShiftHours(templateOrHours.start, templateOrHours.end, templateOrHours.spans, templateOrHours.breakMinutes);
                    worked += hours;
                }
            }
        } else {
            // Removing a shift
            if (wasDayOff) {
                // Removing day off - add back required hours
                required += dailyHours;
            } else if (typeof templateOrHours === 'number' && templateOrHours > 0) {
                // Removing normal shift - subtract worked hours
                worked -= templateOrHours;
                worked = Math.max(0, worked); // Don't go negative
            }
        }
        
        // Update worked hours
        workedSpan.textContent = worked.toFixed(1).replace('.0', '');
        
        // Update required hours
        requiredSpan.textContent = required.toFixed(1).replace('.0', '');
        
        // Update diff
        const diff = worked - required;
        if (diffSpan) {
            if (diff > 0) {
                diffSpan.textContent = `+${diff.toFixed(1).replace('.0', '')}`;
                diffSpan.className = 'diff-hours positive';
            } else if (diff < 0) {
                diffSpan.textContent = diff.toFixed(1).replace('.0', '');
                diffSpan.className = 'diff-hours negative';
            } else {
                diffSpan.textContent = '0';
                diffSpan.className = 'diff-hours';
            }
        }
        
        // Update total cell class
        totalCell.classList.remove('overtime', 'undertime');
        if (diff > 0) {
            totalCell.classList.add('overtime');
        } else if (diff < 0) {
            totalCell.classList.add('undertime');
        }
    }
    
    // Toast notification
    function showToast(message, type = 'info') {
        // Remove existing toast
        const existing = document.querySelector('.toast-notification');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
    
    // ========== Holiday Management Functions ==========
    
    // Toggle half-day options
    function toggleHalfDayOptions() {
        const isHalfDay = document.getElementById('isHalfDay')?.checked;
        const options = document.getElementById('halfDayOptions');
        if (options) {
            options.style.display = isHalfDay ? 'block' : 'none';
        }
    }
    
    // Load holidays for modal
    async function loadHolidaysForModal() {
        const listEl = document.getElementById('holidaysList');
        if (!listEl) return;
        
        listEl.innerHTML = '<div class="holiday-loading">' + (isTurkish ? 'Y√ºkleniyor...' : 'Loading...') + '</div>';
        
        try {
            const response = await fetch(`/api/holidays?year=${state.year}&month=${state.month}`);
            if (response.ok) {
                const holidays = await response.json();
                renderHolidaysInModal(holidays);
            }
        } catch (error) {
            console.error('Error loading holidays:', error);
            listEl.innerHTML = '<div class="holiday-empty">' + (isTurkish ? 'Hata olu≈ütu' : 'Error occurred') + '</div>';
        }
        
        // Re-enable save button
        const saveBtn = document.getElementById('saveHolidayBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<span class="btn-icon">‚úì</span> ' + (isTurkish ? 'Tatil Ekle' : 'Add Holiday');
        }
    }
    
    // Render holidays in modal
    function renderHolidaysInModal(holidays) {
        const listEl = document.getElementById('holidaysList');
        if (!listEl) return;
        
        if (holidays.length === 0) {
            listEl.innerHTML = '<div class="holiday-empty">' + (isTurkish ? 'Bu ay tatil yok' : 'No holidays this month') + '</div>';
            return;
        }
        
        const dayNames = isTurkish 
            ? ['Paz', 'Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt']
            : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        listEl.innerHTML = holidays.map(h => {
            const date = new Date(h.date);
            const dayName = dayNames[date.getDay()];
            const dateStr = date.getDate().toString().padStart(2, '0') + '/' + (date.getMonth() + 1).toString().padStart(2, '0');
            const typeLabel = h.type === 0 ? (isTurkish ? 'Resmi' : 'Official') : (isTurkish ? 'ƒ∞dari' : 'Admin');
            const typeBadgeClass = h.type === 0 ? 'official' : 'admin';
            
            return `
                <div class="holiday-item" data-id="${h.id}">
                    <div class="holiday-info">
                        <span class="holiday-date">${dateStr} ${dayName}</span>
                        <span class="holiday-name">${h.name}</span>
                        <div class="holiday-badges">
                            <span class="holiday-badge ${typeBadgeClass}">${typeLabel}</span>
                            ${h.isHalfDay ? `<span class="holiday-badge half-day">${isTurkish ? 'Yarƒ±m G√ºn' : 'Half Day'} (${h.halfDayWorkHours || 4}s)</span>` : ''}
                        </div>
                    </div>
                    <button class="holiday-delete-btn" onclick="deleteHoliday(${h.id})" title="${isTurkish ? 'Sil' : 'Delete'}">üóëÔ∏è</button>
                </div>
            `;
        }).join('');
    }
    
    // Delete holiday
    async function deleteHoliday(id) {
        if (!confirm(isTurkish ? 'Bu tatili silmek istediƒüinizden emin misiniz?' : 'Are you sure you want to delete this holiday?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/holidays/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadHolidaysForModal();
                showToast(isTurkish ? 'Tatil silindi' : 'Holiday deleted', 'success');
            } else {
                showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
            }
        } catch (error) {
            console.error('Error deleting holiday:', error);
            showToast(isTurkish ? 'Hata olu≈ütu' : 'Error occurred', 'error');
        }
    }
    
    // Weekend mode toggle
    function initWeekendModeToggle() {
        const weekendMode = document.getElementById('employeeWeekendMode');
        const saturdayHoursGroup = document.getElementById('saturdayHoursGroup');
        
        if (weekendMode && saturdayHoursGroup) {
            weekendMode.addEventListener('change', function() {
                saturdayHoursGroup.style.display = this.value === '3' ? 'block' : 'none';
            });
        }
    }
    
    // Modals
    function initModals() {
        // Save Employee
        const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');
        if (saveEmployeeBtn) {
            saveEmployeeBtn.addEventListener('click', async function() {
                // Prevent double-click
                if (this.disabled) return;
                
                const fullName = document.getElementById('employeeFullName')?.value?.trim();
                if (!fullName) {
                    alert(texts.nameRequired);
                    return;
                }
                
                // Disable button and show loading
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = '<span class="btn-icon">‚è≥</span> ' + (isTurkish ? 'Ekleniyor...' : 'Adding...');
                
                try {
                    const positionType = document.getElementById('employeePositionType')?.value || '';
                    const data = {
                        fullName: fullName,
                        title: document.getElementById('employeeTitle')?.value?.trim() || '',
                        identityNo: document.getElementById('employeeIdentityNo')?.value?.trim() || '',
                        dailyWorkHours: parseFloat(document.getElementById('employeeDailyHours')?.value) || 8,
                        weekendWorkMode: parseInt(document.getElementById('employeeWeekendMode')?.value) || 0,
                        saturdayWorkHours: parseFloat(document.getElementById('employeeSaturdayHours')?.value) || null,
                        positionType: positionType || null,
                        academicTitle: positionType === 'Academic' ? (document.getElementById('employeeAcademicTitle')?.value || null) : null,
                        shiftScore: parseInt(document.getElementById('employeeShiftScore')?.value) || 100,
                        isNonHealthServices: document.getElementById('employeeIsNonHealthServices')?.checked || false
                    };
                    
                    const response = await fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        location.reload(); // Reload for new employee to appear in list
                    } else {
                        const error = await response.json();
                        alert(error.error || texts.errorOccurred);
                        // Re-enable button on error
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }
                } catch (err) {
                    alert(texts.errorOccurred);
                    // Re-enable button on error
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            });
        }
        
        // Holiday Modal - Load holidays when opened
        const holidayModal = document.getElementById('addHolidayModal');
        if (holidayModal) {
            holidayModal.addEventListener('show.bs.modal', loadHolidaysForModal);
        }
        
        // Save Holiday
        const saveHolidayBtn = document.getElementById('saveHolidayBtn');
        if (saveHolidayBtn) {
            saveHolidayBtn.addEventListener('click', async function() {
                // Prevent double-click
                if (this.disabled) return;
                
                const date = document.getElementById('holidayDate')?.value;
                const name = document.getElementById('holidayName')?.value?.trim();
                const isHalfDay = document.getElementById('isHalfDay')?.checked || false;
                const halfDayWorkHours = isHalfDay ? parseFloat(document.getElementById('halfDayWorkHours')?.value) || 4 : null;
                
                if (!date || !name) {
                    alert(texts.dateNameRequired);
                    return;
                }
                
                // Disable button
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = '<span class="btn-icon">‚è≥</span> ' + (isTurkish ? 'Ekleniyor...' : 'Adding...');
                
                try {
                    const data = {
                        date: date,
                        name: name,
                        type: parseInt(document.getElementById('holidayType')?.value) || 0,
                        isHalfDay: isHalfDay,
                        halfDayWorkHours: halfDayWorkHours
                    };
                    
                    const response = await fetch('/api/holidays', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        // Reload holidays list and clear form
                        loadHolidaysForModal();
                        document.getElementById('holidayDate').value = '';
                        document.getElementById('holidayName').value = '';
                        document.getElementById('isHalfDay').checked = false;
                        toggleHalfDayOptions();
                        showToast(isTurkish ? 'Tatil eklendi' : 'Holiday added', 'success');
                    } else {
                        // Re-enable button on error
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }
                } catch (err) {
                    // Re-enable button on error
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            });
        }
        
        // Export Excel
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', function() {
                if (this.dataset.premium === 'true') {
                    showPremiumModal();
                    return;
                }
                window.location.href = `/api/export/excel?year=${state.year}&month=${state.month}`;
            });
        }
        
        // Generate Schedule - Open Modal
        const generateScheduleBtn = document.getElementById('generateScheduleBtn');
        if (generateScheduleBtn) {
            generateScheduleBtn.addEventListener('click', function() {
                if (this.dataset.premium === 'true') {
                    showPremiumModal();
                    return;
                }
                // Open Smart Generate Modal
                const sgModal = document.getElementById('smartGenerateModal');
                if (sgModal) {
                    const modal = new bootstrap.Modal(sgModal);
                    modal.show();
                } else {
                    alert(isTurkish ? 'Akƒ±llƒ± planlama √∂zelliƒüi yakƒ±nda!' : 'Smart scheduling coming soon!');
                }
            });
        }
        
        // Bulk Assign Options
        document.querySelectorAll('.bulk-option-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                // Prevent double-click
                if (this.disabled) return;
                
                const mode = this.dataset.mode;
                const employeeId = state.bulkAssignEmployeeId;
                const overwrite = document.getElementById('bulkOverwrite')?.checked || false;
                
                if (!employeeId || !state.selectedTemplate) return;
                
                // Show loading, hide buttons
                const bulkLoading = document.getElementById('bulkLoading');
                const bulkProgress = document.getElementById('bulkProgress');
                const bulkOptions = document.querySelector('.bulk-options');
                const overwriteSection = document.querySelector('#bulkAssignModal .form-section');
                const modalFooter = document.querySelector('#bulkAssignModal .modal-footer-custom');
                
                if (bulkOptions) bulkOptions.style.display = 'none';
                if (overwriteSection) overwriteSection.style.display = 'none';
                if (modalFooter) modalFooter.style.display = 'none';
                if (bulkLoading) bulkLoading.style.display = 'block';
                if (bulkProgress) bulkProgress.textContent = '';
                
                // Get all dates for current month
                const year = state.year;
                const month = state.month;
                const daysInMonth = new Date(year, month, 0).getDate();
                const datesToAssign = [];
                
                // First pass: collect all existing shifts for this employee (including next day check for overnight)
                const existingShiftDates = new Set();
                const overnightShiftDates = new Set(); // Dates that have overnight shifts
                document.querySelectorAll(`.shift-cell[data-employee-id="${employeeId}"] .shift-badge`).forEach(badge => {
                    const cellDate = badge.closest('.shift-cell').dataset.date;
                    existingShiftDates.add(cellDate);
                    // Check if it's an overnight shift (has +1 badge)
                    if (badge.querySelector('.overnight-badge')) {
                        overnightShiftDates.add(cellDate);
                    }
                });
                
                const isOvernightTemplate = state.selectedTemplate.spans;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    // Create date string in local format (YYYY-MM-DD)
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month - 1, day);
                    const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
                    
                    // Check if holiday
                    const cell = document.querySelector(`.shift-cell[data-employee-id="${employeeId}"][data-date="${dateStr}"]`);
                    if (!cell) continue;
                    
                    const isHoliday = cell.classList.contains('holiday');
                    if (isHoliday) continue; // Skip holidays
                    
                    // Apply mode filter first
                    if (mode === 'weekdays' && (dayOfWeek === 0 || dayOfWeek === 6)) {
                        continue; // Skip weekends (Sunday=0, Saturday=6)
                    } else if (mode === 'no-sunday' && dayOfWeek === 0) {
                        continue; // Skip Sunday
                    }
                    // mode === 'all' includes everything
                    
                    // Check if already has shift
                    const hasShift = cell.querySelector('.shift-badge');
                    if (hasShift && !overwrite) continue; // Skip if has shift and overwrite is off
                    
                    // For overnight shifts: check if next day has a shift (overlap prevention)
                    if (isOvernightTemplate && !overwrite) {
                        const nextDate = new Date(year, month - 1, day + 1);
                        const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
                        if (existingShiftDates.has(nextDateStr)) {
                            continue; // Skip - would cause overlap with next day's shift
                        }
                    }
                    
                    // Check if previous day has overnight shift (would overlap with this day)
                    if (!overwrite && day > 1) {
                        const prevDateStr = `${year}-${String(month).padStart(2, '0')}-${String(day - 1).padStart(2, '0')}`;
                        if (overnightShiftDates.has(prevDateStr)) {
                            continue; // Skip - previous day's overnight shift overlaps
                        }
                    }
                    
                    datesToAssign.push({ date: dateStr, cell, hasExisting: !!hasShift });
                }
                
                try {
                    // Update progress
                    if (bulkProgress) bulkProgress.textContent = `0 / ${datesToAssign.length}`;
                    
                    // Step 1: Delete existing shifts if overwrite is enabled (silent, no UI updates)
                    if (overwrite) {
                        const deletePromises = [];
                        for (const item of datesToAssign) {
                            if (item.hasExisting) {
                                deletePromises.push(fetch(`/api/shifts/employee/${employeeId}/date/${item.date}`, { method: 'DELETE' }));
                            }
                        }
                        if (deletePromises.length > 0) {
                            await Promise.all(deletePromises);
                        }
                    }
                    
                    // Step 2: Create new shifts in parallel with progress tracking
                    let completedCount = 0;
                    const totalCount = datesToAssign.length;
                    
                    // Create all promises with progress tracking
                    const shiftPromises = datesToAssign.map((item, index) => {
                        return createShift(employeeId, item.date, item.cell, true).then(() => {
                            completedCount++;
                            if (bulkProgress) {
                                bulkProgress.textContent = `${completedCount} / ${totalCount}`;
                            }
                        });
                    });
                    
                    // Execute all in parallel
                    await Promise.all(shiftPromises);
                    
                    // Close modal
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal')).hide();
                        showToast(isTurkish ? `${datesToAssign.length} n√∂bet eklendi!` : `${datesToAssign.length} shifts added!`, 'success');
                    }, 300);
                    
                } catch (error) {
                    console.error('Bulk assign error:', error);
                    showToast(texts.errorOccurred, 'error');
                    
                    // Hide loading, show buttons back
                    if (bulkLoading) bulkLoading.style.display = 'none';
                    if (bulkOptions) bulkOptions.style.display = 'flex';
                    if (overwriteSection) overwriteSection.style.display = 'block';
                    if (modalFooter) modalFooter.style.display = 'flex';
                }
            });
        });
        
        // Bulk Delete All Shifts
        const bulkDeleteAllBtn = document.getElementById('bulkDeleteAllBtn');
        if (bulkDeleteAllBtn) {
            bulkDeleteAllBtn.addEventListener('click', async function() {
                // Prevent double-click
                if (this.disabled) return;
                
                const employeeId = state.bulkAssignEmployeeId;
                if (!employeeId) return;
                
                const confirmMsg = isTurkish 
                    ? 'Bu personelin bu aydaki T√úM n√∂betlerini silmek istediƒüinize emin misiniz?' 
                    : 'Are you sure you want to delete ALL shifts for this employee this month?';
                
                if (!confirm(confirmMsg)) return;
                
                // Disable button
                this.disabled = true;
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal')).hide();
                
                // Get all cells with shifts for this employee
                const allCells = document.querySelectorAll(`.shift-cell[data-employee-id="${employeeId}"]`);
                const shiftsToDelete = [];
                
                allCells.forEach(cell => {
                    const hasShift = cell.querySelector('.shift-badge');
                    if (hasShift && !cell.querySelector('.shift-continuation')) {
                        // Has a shift badge and it's not just a continuation
                        shiftsToDelete.push({ date: cell.dataset.date, cell });
                    }
                });
                
                if (shiftsToDelete.length === 0) {
                    showToast(isTurkish ? 'Silinecek n√∂bet bulunamadƒ±' : 'No shifts to delete', 'info');
                    return;
                }
                
                // Delete all shifts
                const deletePromises = [];
                for (const item of shiftsToDelete) {
                    deletePromises.push(deleteShift(employeeId, item.date, item.cell));
                }
                
                await Promise.all(deletePromises);
                showToast(isTurkish ? `${shiftsToDelete.length} n√∂bet silindi!` : `${shiftsToDelete.length} shifts deleted!`, 'info');
                
                // Re-enable button
                this.disabled = false;
            });
        }
        
        // Reset bulk modal when it opens
        const bulkAssignModal = document.getElementById('bulkAssignModal');
        if (bulkAssignModal) {
            bulkAssignModal.addEventListener('show.bs.modal', function() {
                // Show all elements, hide loading
                const bulkLoading = document.getElementById('bulkLoading');
                const bulkOptions = document.querySelector('.bulk-options');
                const overwriteSection = document.querySelector('#bulkAssignModal .form-section');
                const modalFooter = document.querySelector('#bulkAssignModal .modal-footer-custom');
                
                if (bulkLoading) bulkLoading.style.display = 'none';
                if (bulkOptions) bulkOptions.style.display = 'flex';
                if (overwriteSection) overwriteSection.style.display = 'block';
                if (modalFooter) modalFooter.style.display = 'flex';
                
                // Re-enable buttons
                document.querySelectorAll('.bulk-option-btn').forEach(b => b.disabled = false);
                const deleteBtn = document.getElementById('bulkDeleteAllBtn');
                if (deleteBtn) deleteBtn.disabled = false;
                
                // Reset template highlight if no template selected
                if (!state.selectedTemplate) {
                    const templateBox = document.getElementById('bulkAssignTemplateBox');
                    const templateBadge = document.getElementById('bulkAssignTemplateBadge');
                    if (templateBox) {
                        templateBox.style.border = '';
                        templateBox.style.backgroundColor = '';
                    }
                    if (templateBadge) {
                        templateBadge.style.display = 'none';
                    }
                }
            });
        }
    }
    
    // Delete Handlers
    function initDeleteHandlers() {
        // Delete employee from sidebar (legacy)
        document.querySelectorAll('.btn-delete[data-id]').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                if (!confirm(texts.confirmDelete)) return;
                
                const response = await fetch(`/api/employees/${this.dataset.id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                }
            });
        });
        
        // Delete employee from modal
        document.querySelectorAll('.emp-delete[data-id]').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                if (!confirm(texts.confirmDelete)) return;
                
                const id = this.dataset.id;
                const response = await fetch(`/api/employees/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove the row from modal
                    const row = this.closest('.emp-row');
                    if (row) row.remove();
                    
                    // Update badge count
                    const badge = document.querySelector('.employees-btn .action-badge');
                    if (badge) {
                        const count = parseInt(badge.textContent) - 1;
                        badge.textContent = count;
                    }
                    
                    showToast(texts.employeeDeleted || 'Silindi', 'success');
                    
                    // Reload to update table
                    setTimeout(() => location.reload(), 500);
                }
            });
        });
        
        // Delete holiday
        document.querySelectorAll('.btn-delete-small[data-id]').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm(texts.confirmDelete)) return;
                
                const response = await fetch(`/api/holidays/${this.dataset.id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                }
            });
        });
    }
    
    // ===== Unit Management Functions (Premium Feature) =====
    
    // Change unit filter - navigates to show employees from selected unit
    function changeUnit(unitId) {
        const year = @Model.SelectedYear;
        const month = @Model.SelectedMonth;
        window.location.href = `/app?year=${year}&month=${month}&unitId=${unitId}`;
    }
    
    function initUnitManagement() {
        // Add Unit button
        document.getElementById('addUnitBtn')?.addEventListener('click', addUnit);
        
        // Add Unit Type button
        document.getElementById('addUnitTypeBtn')?.addEventListener('click', addUnitType);
        
        // Save Unit button (edit modal)
        document.getElementById('saveUnitBtn')?.addEventListener('click', saveUnit);
        
        // Save Unit Type button (edit modal)
        document.getElementById('saveUnitTypeBtn')?.addEventListener('click', saveUnitType);
        
        // When unit type is selected, update coefficient
        document.getElementById('newUnitType')?.addEventListener('change', function() {
            const option = this.selectedOptions[0];
            if (option && option.dataset.coefficient) {
                document.getElementById('newUnitCoefficient').value = option.dataset.coefficient;
            }
        });
        
        document.getElementById('editUnitTypeId')?.addEventListener('change', function() {
            const option = this.selectedOptions[0];
            if (option && option.dataset.coefficient) {
                document.getElementById('editUnitCoefficient').value = option.dataset.coefficient;
            }
        });
    }
    
    async function addUnit() {
        const name = document.getElementById('newUnitName').value.trim();
        const typeId = document.getElementById('newUnitType').value || null;
        const coefficient = parseFloat(document.getElementById('newUnitCoefficient').value) || 1.0;
        const employeeLimit = parseInt(document.getElementById('newUnitEmployeeLimit').value) || 0;
        
        if (!name) {
            alert(texts.unitNameRequired);
            return;
        }
        
        try {
            const response = await fetch('/api/units', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    unitTypeId: typeId ? parseInt(typeId) : null,
                    coefficient,
                    employeeLimit,
                    isDefault: false
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            // Clear form and reload
            document.getElementById('newUnitName').value = '';
            document.getElementById('newUnitType').value = '';
            document.getElementById('newUnitCoefficient').value = '1.0';
            document.getElementById('newUnitEmployeeLimit').value = '0';
            
            showToast(texts.unitAdded, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    async function addUnitType() {
        const name = document.getElementById('newUnitTypeName').value.trim();
        const coefficient = parseFloat(document.getElementById('newUnitTypeCoefficient').value) || 1.0;
        const color = document.getElementById('newUnitTypeColor').value;
        
        if (!name) {
            alert(texts.unitTypeNameRequired);
            return;
        }
        
        try {
            const response = await fetch('/api/unit-types', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, defaultCoefficient: coefficient, color })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            // Clear form and reload
            document.getElementById('newUnitTypeName').value = '';
            document.getElementById('newUnitTypeCoefficient').value = '1.0';
            document.getElementById('newUnitTypeColor').value = '#3B82F6';
            
            showToast(texts.unitTypeAdded, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    function editUnit(id, name, typeId, coefficient, color, isDefault, employeeLimit) {
        document.getElementById('editUnitId').value = id;
        document.getElementById('editUnitName').value = name;
        document.getElementById('editUnitTypeId').value = typeId || '';
        document.getElementById('editUnitCoefficient').value = coefficient;
        document.getElementById('editUnitEmployeeLimit').value = employeeLimit || 0;
        document.getElementById('editUnitColor').value = color;
        document.getElementById('editUnitIsDefault').checked = isDefault;
        
        const modal = new bootstrap.Modal(document.getElementById('editUnitModal'));
        modal.show();
    }
    
    async function saveUnit() {
        const id = document.getElementById('editUnitId').value;
        const name = document.getElementById('editUnitName').value.trim();
        const typeId = document.getElementById('editUnitTypeId').value || null;
        const coefficient = parseFloat(document.getElementById('editUnitCoefficient').value) || 1.0;
        const employeeLimit = parseInt(document.getElementById('editUnitEmployeeLimit').value) || 0;
        const color = document.getElementById('editUnitColor').value;
        const isDefault = document.getElementById('editUnitIsDefault').checked;
        
        if (!name) {
            alert(texts.unitNameRequired);
            return;
        }
        
        try {
            const response = await fetch(`/api/units/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    unitTypeId: typeId ? parseInt(typeId) : null,
                    coefficient,
                    employeeLimit,
                    color,
                    isDefault
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editUnitModal'))?.hide();
            showToast(texts.unitUpdated, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    async function deleteUnit(id) {
        if (!confirm(texts.confirmDelete)) return;
        
        try {
            const response = await fetch(`/api/units/${id}`, { method: 'DELETE' });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            showToast(texts.unitDeleted, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    function editUnitType(id, name, coefficient, color) {
        document.getElementById('editUnitTypeId').value = id;
        document.getElementById('editUnitTypeName').value = name;
        document.getElementById('editUnitTypeCoefficient').value = coefficient;
        document.getElementById('editUnitTypeColor').value = color;
        
        const modal = new bootstrap.Modal(document.getElementById('editUnitTypeModal'));
        modal.show();
    }
    
    async function saveUnitType() {
        const id = document.getElementById('editUnitTypeId').value;
        const name = document.getElementById('editUnitTypeName').value.trim();
        const coefficient = parseFloat(document.getElementById('editUnitTypeCoefficient').value) || 1.0;
        const color = document.getElementById('editUnitTypeColor').value;
        
        if (!name) {
            alert(texts.unitTypeNameRequired);
            return;
        }
        
        try {
            const response = await fetch(`/api/unit-types/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, defaultCoefficient: coefficient, color })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editUnitTypeModal'))?.hide();
            showToast(texts.unitTypeUpdated, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    async function deleteUnitType(id) {
        if (!confirm(texts.confirmDelete)) return;
        
        try {
            const response = await fetch(`/api/unit-types/${id}`, { method: 'DELETE' });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || texts.errorOccurred);
            }
            
            showToast(texts.unitTypeDeleted, 'success');
            location.reload();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
    
    // Assign Employees to Unit
    async function openAssignEmployees(unitId, unitName) {
        document.getElementById('assignUnitId').value = unitId;
        document.getElementById('assignUnitName').textContent = unitName;
        
        // Load employees
        try {
            const response = await fetch('/api/employees');
            const employees = await response.json();
            
            const assignedList = document.getElementById('assignedEmployeesList');
            const availableList = document.getElementById('availableEmployeesList');
            
            assignedList.innerHTML = '';
            availableList.innerHTML = '';
            
            employees.forEach(emp => {
                const chip = document.createElement('div');
                chip.className = 'employee-chip ' + (emp.unitId === unitId ? 'assigned' : 'available');
                chip.innerHTML = `
                    <span class="chip-color" style="background-color: ${emp.color || '#6B7280'}"></span>
                    <span>${emp.fullName}</span>
                    <span class="${emp.unitId === unitId ? 'chip-remove' : 'chip-add'}">${emp.unitId === unitId ? '√ó' : '+'}</span>
                `;
                chip.onclick = () => toggleEmployeeUnit(emp.id, unitId, emp.unitId === unitId);
                
                if (emp.unitId === unitId) {
                    assignedList.appendChild(chip);
                } else if (!emp.unitId) {
                    availableList.appendChild(chip);
                }
            });
            
            if (assignedList.children.length === 0) {
                assignedList.innerHTML = `<span style="color: #6b7280; font-size: 0.85rem;">${isTurkish ? 'Hen√ºz personel atanmamƒ±≈ü' : 'No employees assigned yet'}</span>`;
            }
            if (availableList.children.length === 0) {
                availableList.innerHTML = `<span style="color: #6b7280; font-size: 0.85rem;">${isTurkish ? 'T√ºm personeller birimlere atanmƒ±≈ü' : 'All employees are assigned to units'}</span>`;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('assignEmployeesModal'));
            modal.show();
        } catch (error) {
            showToast(texts.errorOccurred, 'error');
        }
    }
    
    async function toggleEmployeeUnit(employeeId, unitId, isCurrentlyAssigned) {
        try {
            if (isCurrentlyAssigned) {
                // Remove from unit
                const response = await fetch(`/api/units/${unitId}/employees/${employeeId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error();
                showToast(texts.employeeRemoved, 'success');
            } else {
                // Assign to unit
                const response = await fetch(`/api/units/${unitId}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeIds: [employeeId] })
                });
                if (!response.ok) throw new Error();
                showToast(texts.employeeAssigned, 'success');
            }
            
            // Refresh the list
            const unitName = document.getElementById('assignUnitName').textContent;
            openAssignEmployees(unitId, unitName);
        } catch (error) {
            showToast(texts.errorOccurred, 'error');
        }
    }
</script>
}

@if (!Model.IsRegistered)
{
<!-- Registration Invitation Modal -->
<div class="modal fade" id="registerInviteModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content register-invite-modal">
            <button type="button" class="btn-close-invite" id="closeInviteModal" aria-label="Close">√ó</button>
            <div class="invite-content">
                <h2 class="invite-title">@(isTurkish ? "√úcretsiz Hesap Olu≈ütur" : "Create Free Account")</h2>
                <p class="invite-subtitle">@(isTurkish ? "Verilerinizi kaydedin ve t√ºm √∂zelliklere eri≈üin" : "Save your data and access all features")</p>
                
                <div class="invite-features">
                    <div class="invite-feature">
                        <span class="feature-check">‚úì</span>
                        <span class="feature-text">@(isTurkish ? "Verileriniz kalƒ±cƒ± olarak saklanƒ±r" : "Your data is permanently saved")</span>
                    </div>
                    <div class="invite-feature">
                        <span class="feature-check">‚úì</span>
                        <span class="feature-text">@(isTurkish ? "10 personele kadar ekleyin" : "Add up to 10 employees")</span>
                    </div>
                    <div class="invite-feature">
                        <span class="feature-check">‚úì</span>
                        <span class="feature-text">@(isTurkish ? "Detaylƒ± puantaj ve raporlar" : "Detailed timesheets & reports")</span>
                    </div>
                    <div class="invite-feature">
                        <span class="feature-check">‚úì</span>
                        <span class="feature-text">@(isTurkish ? "Excel'e aktar" : "Export to Excel")</span>
                    </div>
                </div>
                
                <div class="invite-actions">
                    <a href="/Account/Register" class="btn-invite-primary">
                        @(isTurkish ? "√úcretsiz Kayƒ±t Ol" : "Sign Up Free")
                    </a>
                    <a href="/Account/Login" class="btn-invite-secondary">
                        @(isTurkish ? "Zaten hesabƒ±m var" : "I already have an account")
                    </a>
                </div>
                
                <p class="invite-note">@(isTurkish ? "Kredi kartƒ± gerekmez" : "No credit card required")</p>
            </div>
        </div>
    </div>
</div>

<style>
    .register-invite-modal {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    .btn-close-invite {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: #f5f5f5;
        color: #666;
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.15s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .btn-close-invite:hover {
        background: #eee;
        color: #333;
    }
    
    .invite-content {
        padding: 32px 28px;
        text-align: center;
    }
    
    .invite-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0 0 6px 0;
        color: #1a1a2e;
    }
    
    .invite-subtitle {
        font-size: 0.9rem;
        color: #666;
        margin: 0 0 24px 0;
    }
    
    .invite-features {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        text-align: left;
    }
    
    .invite-feature {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
    }
    
    .invite-feature:last-child {
        padding-bottom: 0;
    }
    
    .invite-feature:first-child {
        padding-top: 0;
    }
    
    .feature-check {
        width: 20px;
        height: 20px;
        background: #22c55e;
        color: #fff;
        border-radius: 50%;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .feature-text {
        font-size: 0.85rem;
        color: #444;
    }
    
    .invite-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 16px;
    }
    
    .btn-invite-primary {
        display: block;
        padding: 12px 24px;
        background: #3b82f6;
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.15s;
    }
    
    .btn-invite-primary:hover {
        background: #2563eb;
        color: #fff;
    }
    
    .btn-invite-secondary {
        display: block;
        padding: 10px 24px;
        background: transparent;
        color: #666;
        font-weight: 500;
        font-size: 0.85rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.15s;
    }
    
    .btn-invite-secondary:hover {
        background: #f5f5f5;
        color: #333;
        border-color: #ccc;
    }
    
    .invite-note {
        font-size: 0.75rem;
        color: #999;
        margin: 0;
    }
    
    @@media (max-width: 480px) {
        .invite-content {
            padding: 24px 20px;
        }
        
        .invite-title {
            font-size: 1.15rem;
        }
    }
</style>

<script>
(function() {
    const STORAGE_KEY = 'registerInviteDismissed';
    const DISMISS_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
    
    function shouldShowModal() {
        const dismissed = localStorage.getItem(STORAGE_KEY);
        if (!dismissed) return true;
        
        const dismissedTime = parseInt(dismissed, 10);
        const now = Date.now();
        
        // If 24 hours have passed, show modal again
        if (now - dismissedTime > DISMISS_DURATION) {
            localStorage.removeItem(STORAGE_KEY);
            return true;
        }
        
        return false;
    }
    
    function dismissModal() {
        localStorage.setItem(STORAGE_KEY, Date.now().toString());
        const modal = bootstrap.Modal.getInstance(document.getElementById('registerInviteModal'));
        if (modal) modal.hide();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        if (shouldShowModal()) {
            // Show modal after a short delay for better UX
            setTimeout(function() {
                const modal = new bootstrap.Modal(document.getElementById('registerInviteModal'));
                modal.show();
            }, 1500);
        }
        
        // Handle close button
        document.getElementById('closeInviteModal').addEventListener('click', dismissModal);
        
        // Also dismiss when clicking backdrop (if enabled)
        document.getElementById('registerInviteModal').addEventListener('hidden.bs.modal', function() {
            // Only save dismiss time if not navigating to register/login
            const dismissed = localStorage.getItem(STORAGE_KEY);
            if (!dismissed) {
                localStorage.setItem(STORAGE_KEY, Date.now().toString());
            }
        });
    });
})();
</script>
}

@if (Model.CanUseSmartScheduling)
{
<script>
// Smart Generate Algorithm
(function() {
    'use strict';
    
    const isTurkish = document.documentElement.lang === 'tr' || navigator.language.startsWith('tr');
    
    // State for restrictions and preferences
    const sgState = {
        restrictions: [], // [{employeeId, employeeName, startDate, endDate}]
        preferences: []   // [{employeeId, employeeName, startDate, endDate}]
    };
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initSmartGenerate();
    });
    
    function initSmartGenerate() {
        const addRestrictionBtn = document.getElementById('sgAddRestriction');
        const addPreferenceBtn = document.getElementById('sgAddPreference');
        const generateBtn = document.getElementById('sgGenerateBtn');
        const confirmGenerateBtn = document.getElementById('sgConfirmGenerate');
        
        if (addRestrictionBtn) {
            addRestrictionBtn.addEventListener('click', addRestriction);
        }
        
        if (addPreferenceBtn) {
            addPreferenceBtn.addEventListener('click', addPreference);
        }
        
        // Generate button shows confirmation first
        if (generateBtn) {
            generateBtn.addEventListener('click', showConfirmation);
        }
        
        // Confirm button starts the actual generation
        if (confirmGenerateBtn) {
            confirmGenerateBtn.addEventListener('click', generateSchedule);
        }
        
        // Set default dates for date inputs
        const year = @Model.SelectedYear;
        const month = @Model.SelectedMonth;
        const firstDay = `${year}-${String(month).padStart(2, '0')}-01`;
        const lastDay = `${year}-${String(month).padStart(2, '0')}-${new Date(year, month, 0).getDate()}`;
        
        const dateInputs = ['sgRestrictionStartDate', 'sgRestrictionEndDate', 'sgPreferenceStartDate', 'sgPreferenceEndDate'];
        dateInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.min = firstDay;
                input.max = lastDay;
            }
        });
    }
    
    function addRestriction() {
        const employeeSelect = document.getElementById('sgRestrictionEmployee');
        const startDate = document.getElementById('sgRestrictionStartDate').value;
        const endDate = document.getElementById('sgRestrictionEndDate').value;
        
        if (!employeeSelect.value || !startDate) {
            alert(isTurkish ? 'Personel ve ba≈ülangƒ±√ß tarihi se√ßin' : 'Select employee and start date');
            return;
        }
        
        const restriction = {
            id: Date.now(),
            employeeId: parseInt(employeeSelect.value),
            employeeName: employeeSelect.options[employeeSelect.selectedIndex].text,
            startDate: startDate,
            endDate: endDate || startDate
        };
        
        sgState.restrictions.push(restriction);
        renderRestrictions();
        
        // Reset form
        employeeSelect.value = '';
        document.getElementById('sgRestrictionStartDate').value = '';
        document.getElementById('sgRestrictionEndDate').value = '';
    }
    
    function addPreference() {
        const employeeSelect = document.getElementById('sgPreferenceEmployee');
        const startDate = document.getElementById('sgPreferenceStartDate').value;
        const endDate = document.getElementById('sgPreferenceEndDate').value;
        
        if (!employeeSelect.value || !startDate) {
            alert(isTurkish ? 'Personel ve ba≈ülangƒ±√ß tarihi se√ßin' : 'Select employee and start date');
            return;
        }
        
        const preference = {
            id: Date.now(),
            employeeId: parseInt(employeeSelect.value),
            employeeName: employeeSelect.options[employeeSelect.selectedIndex].text,
            startDate: startDate,
            endDate: endDate || startDate
        };
        
        sgState.preferences.push(preference);
        renderPreferences();
        
        // Reset form
        employeeSelect.value = '';
        document.getElementById('sgPreferenceStartDate').value = '';
        document.getElementById('sgPreferenceEndDate').value = '';
    }
    
    function renderRestrictions() {
        const list = document.getElementById('sgRestrictionsList');
        list.innerHTML = sgState.restrictions.map(r => `
            <div class="restriction-item" data-id="${r.id}">
                <div class="restriction-info">
                    <span class="restriction-employee">${r.employeeName}</span>
                    <span class="restriction-dates">üö´ ${formatDate(r.startDate)}${r.endDate !== r.startDate ? ' - ' + formatDate(r.endDate) : ''}</span>
                </div>
                <button type="button" class="restriction-remove" onclick="removeRestriction(${r.id})">√ó</button>
            </div>
        `).join('');
    }
    
    function renderPreferences() {
        const list = document.getElementById('sgPreferencesList');
        list.innerHTML = sgState.preferences.map(p => `
            <div class="restriction-item preference" data-id="${p.id}">
                <div class="restriction-info">
                    <span class="restriction-employee">${p.employeeName}</span>
                    <span class="restriction-dates">‚úì ${formatDate(p.startDate)}${p.endDate !== p.startDate ? ' - ' + formatDate(p.endDate) : ''}</span>
                </div>
                <button type="button" class="restriction-remove" onclick="removePreference(${p.id})">√ó</button>
            </div>
        `).join('');
    }
    
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString(isTurkish ? 'tr-TR' : 'en-US', { day: 'numeric', month: 'short' });
    }
    
    // Make remove functions global
    window.removeRestriction = function(id) {
        sgState.restrictions = sgState.restrictions.filter(r => r.id !== id);
        renderRestrictions();
    };
    
    window.removePreference = function(id) {
        sgState.preferences = sgState.preferences.filter(p => p.id !== id);
        renderPreferences();
    };
    
    // Show confirmation modal before generating
    function showConfirmation() {
        // Hide smart generate modal temporarily
        const sgModal = bootstrap.Modal.getInstance(document.getElementById('smartGenerateModal'));
        
        // Show confirmation modal
        const confirmModal = new bootstrap.Modal(document.getElementById('sgConfirmModal'));
        confirmModal.show();
    }
    
    async function generateSchedule() {
        // Close confirmation modal
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('sgConfirmModal'));
        if (confirmModal) confirmModal.hide();
        
        const progress = document.getElementById('sgProgress');
        const progressBar = document.getElementById('sgProgressBar');
        const progressText = document.getElementById('sgProgressText');
        const generateBtn = document.getElementById('sgGenerateBtn');
        
        // Show progress
        progress.style.display = 'block';
        generateBtn.disabled = true;
        progressBar.style.width = '0%';
        
        try {
            // Step 1: Delete all existing shifts for this month
            progressText.textContent = isTurkish ? 'Mevcut vardiyalar siliniyor...' : 'Deleting existing shifts...';
            progressBar.style.width = '5%';
            
            await deleteAllShiftsForMonth();
            progressBar.style.width = '15%';
            
            // Gather all settings
            const settings = gatherSettings();
            progressBar.style.width = '20%';
            progressText.textContent = isTurkish ? 'Kurallar analiz ediliyor...' : 'Analyzing rules...';
            
            // Get employees and dates
            const employees = getEligibleEmployees(settings);
            const dates = getMonthDates();
            progressBar.style.width = '25%';
            progressText.textContent = isTurkish ? 'Personeller deƒüerlendiriliyor...' : 'Evaluating employees...';
            
            // Generate schedule
            const schedule = await generateOptimalSchedule(settings, employees, dates, (pct, msg) => {
                progressBar.style.width = `${25 + pct * 0.65}%`;
                progressText.textContent = msg;
            });
            progressBar.style.width = '90%';
            progressText.textContent = isTurkish ? 'Yeni vardiyalar kaydediliyor...' : 'Saving new shifts...';
            
            // Apply schedule (always overwrite since we deleted everything)
            await applySchedule(schedule, true);
            progressBar.style.width = '100%';
            progressText.textContent = isTurkish ? '‚úì √áizelge ba≈üarƒ±yla olu≈üturuldu!' : '‚úì Schedule generated successfully!';
            
            // Close modal after delay
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('smartGenerateModal'));
                if (modal) modal.hide();
                progress.style.display = 'none';
                generateBtn.disabled = false;
                
                // Reload page to see changes
                window.location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('Smart Generate Error:', error);
            progressText.textContent = isTurkish ? '‚ùå Hata: ' + error.message : '‚ùå Error: ' + error.message;
            progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
            setTimeout(() => {
                progress.style.display = 'none';
                generateBtn.disabled = false;
                progressBar.style.background = '';
            }, 4000);
        }
    }
    
    async function deleteAllShiftsForMonth() {
        const year = @Model.SelectedYear;
        const month = @Model.SelectedMonth;
        
        try {
            // Get all shift cells that have shifts
            const shiftBadges = document.querySelectorAll('.shift-cell .shift-badge');
            const shiftIds = [];
            
            shiftBadges.forEach(badge => {
                const shiftId = badge.dataset.shiftId;
                if (shiftId) {
                    shiftIds.push(parseInt(shiftId));
                }
            });
            
            // Delete shifts via API
            for (const shiftId of shiftIds) {
                try {
                    await fetch(`/api/shifts/${shiftId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (e) {
                    console.error('Failed to delete shift:', shiftId, e);
                }
            }
            
            console.log(`Deleted ${shiftIds.length} shifts`);
        } catch (error) {
            console.error('Error deleting shifts:', error);
            throw new Error(isTurkish ? 'Vardiyalar silinemedi' : 'Failed to delete shifts');
        }
    }
    
    function gatherSettings() {
        return {
            // Weekday work
            weekday: {
                apply: document.getElementById('sgApplyWeekday')?.checked ?? true,
                start: document.getElementById('sgWeekdayStart')?.value || '08:00',
                end: document.getElementById('sgWeekdayEnd')?.value || '17:00',
                breakMinutes: parseInt(document.getElementById('sgWeekdayBreak')?.value || '60')
            },
            // Weekend
            weekend: {
                apply: document.getElementById('sgApplyWeekend')?.checked ?? true,
                minStaff: parseInt(document.getElementById('sgWeekendMinStaff')?.value || '1'),
                start: document.getElementById('sgWeekendStart')?.value || '08:00',
                end: document.getElementById('sgWeekendEnd')?.value || '17:00',
                breakMinutes: parseInt(document.getElementById('sgWeekendBreak')?.value || '60')
            },
            // Weekday duty
            weekdayDuty: {
                apply: document.getElementById('sgApplyWeekdayDuty')?.checked ?? true,
                minStaff: parseInt(document.getElementById('sgWeekdayDutyMin')?.value || '1'),
                start: document.getElementById('sgWeekdayDutyStart')?.value || '17:00',
                end: document.getElementById('sgWeekdayDutyEnd')?.value || '08:00',
                breakMinutes: parseInt(document.getElementById('sgWeekdayDutyBreak')?.value || '0')
            },
            // Holiday duty
            holidayDuty: {
                apply: document.getElementById('sgApplyHolidayDuty')?.checked ?? true,
                minStaff: parseInt(document.getElementById('sgHolidayDutyMin')?.value || '1'),
                start: document.getElementById('sgHolidayDutyStart')?.value || '08:00',
                end: document.getElementById('sgHolidayDutyEnd')?.value || '08:00',
                breakMinutes: parseInt(document.getElementById('sgHolidayDutyBreak')?.value || '0')
            },
            // Exempt employees (never on duty)
            exemptEmployees: Array.from(document.querySelectorAll('.sg-exempt-employee:checked')).map(cb => parseInt(cb.value)),
            // Date restrictions
            restrictions: sgState.restrictions,
            // Date preferences
            preferences: sgState.preferences,
            // Additional options
            overwrite: document.getElementById('sgOverwriteExisting')?.checked ?? false,
            balanceDuties: document.getElementById('sgBalanceDuties')?.checked ?? true,
            minDaysBetweenDuties: parseInt(document.getElementById('sgMinDaysBetweenDuties')?.value || '2')
        };
    }
    
    function getEligibleEmployees(settings) {
        // Get all employees from the DOM - using emp-row class or tr with data-employee-id
        const employeeRows = document.querySelectorAll('.emp-row[data-employee-id], tr[data-employee-id]');
        const employees = [];
        const seenIds = new Set();
        
        employeeRows.forEach(row => {
            const employeeId = parseInt(row.dataset.employeeId);
            
            // Skip duplicates (emp-row and tr might both have same employee)
            if (seenIds.has(employeeId)) return;
            seenIds.add(employeeId);
            
            // Get employee name from different possible locations
            let employeeName = 'Unknown';
            const nameEl = row.querySelector('.emp-name') || row.querySelector('.employee-name');
            if (nameEl) {
                employeeName = nameEl.textContent?.trim() || 'Unknown';
            } else {
                // Try to get from emp-info
                const infoEl = row.querySelector('.emp-info');
                if (infoEl) {
                    const firstDiv = infoEl.querySelector('div');
                    if (firstDiv) {
                        employeeName = firstDiv.textContent?.trim() || 'Unknown';
                    }
                }
            }
            
            // Skip exempt employees
            if (settings.exemptEmployees.includes(employeeId)) {
                return;
            }
            
            employees.push({
                id: employeeId,
                name: employeeName,
                dutyCount: 0,
                lastDutyDate: null,
                totalHours: 0
            });
        });
        
        console.log('Found employees:', employees.length, employees);
        return employees;
    }
    
    function getMonthDates() {
        const year = @Model.SelectedYear;
        const month = @Model.SelectedMonth;
        const daysInMonth = new Date(year, month, 0).getDate();
        const dates = [];
        
        // Get holidays from the page
        const holidayDates = new Set();
        document.querySelectorAll('.shift-cell.holiday').forEach(cell => {
            holidayDates.add(cell.dataset.date);
        });
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayOfWeek = date.getDay(); // 0=Sunday, 6=Saturday
            
            dates.push({
                date: dateStr,
                day: day,
                dayOfWeek: dayOfWeek,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isHoliday: holidayDates.has(dateStr),
                dayName: date.toLocaleDateString(isTurkish ? 'tr-TR' : 'en-US', { weekday: 'short' })
            });
        }
        
        return dates;
    }
    
    function isEmployeeAvailable(employeeId, dateStr, settings) {
        // Check restrictions
        for (const r of settings.restrictions) {
            if (r.employeeId === employeeId) {
                if (dateStr >= r.startDate && dateStr <= r.endDate) {
                    return false;
                }
            }
        }
        return true;
    }
    
    function hasEmployeePreference(employeeId, dateStr, settings) {
        for (const p of settings.preferences) {
            if (p.employeeId === employeeId) {
                if (dateStr >= p.startDate && dateStr <= p.endDate) {
                    return true;
                }
            }
        }
        return false;
    }
    
    function canAssignDuty(employee, dateStr, settings) {
        // Check if employee can be assigned duty on this date
        
        // Check minimum days between duties
        if (employee.lastDutyDate && settings.minDaysBetweenDuties > 0) {
            const lastDuty = new Date(employee.lastDutyDate);
            const currentDate = new Date(dateStr);
            const daysDiff = Math.floor((currentDate - lastDuty) / (1000 * 60 * 60 * 24));
            if (daysDiff < settings.minDaysBetweenDuties) {
                return false;
            }
        }
        
        // Check restrictions
        if (!isEmployeeAvailable(employee.id, dateStr, settings)) {
            return false;
        }
        
        return true;
    }
    
    async function generateOptimalSchedule(settings, employees, dates, onProgress) {
        const schedule = [];
        let processedDays = 0;
        const totalDays = dates.length;
        
        // Sort employees by duty count for fair distribution
        const sortEmployees = () => {
            if (settings.balanceDuties) {
                employees.sort((a, b) => a.dutyCount - b.dutyCount);
            }
        };
        
        for (const dateInfo of dates) {
            processedDays++;
            onProgress(processedDays / totalDays, isTurkish 
                ? `${dateInfo.day}. g√ºn i≈üleniyor...` 
                : `Processing day ${dateInfo.day}...`);
            
            // Simulate async for UI responsiveness
            await new Promise(r => setTimeout(r, 10));
            
            // 1. Weekday regular work (non-holiday, non-weekend)
            if (settings.weekday.apply && !dateInfo.isWeekend && !dateInfo.isHoliday) {
                for (const emp of employees) {
                    if (isEmployeeAvailable(emp.id, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'work',
                            start: settings.weekday.start,
                            end: settings.weekday.end,
                            breakMinutes: settings.weekday.breakMinutes
                        });
                    }
                }
            }
            
            // 2. Weekend work
            if (settings.weekend.apply && dateInfo.isWeekend && !dateInfo.isHoliday) {
                sortEmployees();
                let assignedCount = 0;
                
                // First, check for employees with preferences
                for (const emp of employees) {
                    if (assignedCount >= settings.weekend.minStaff) break;
                    if (hasEmployeePreference(emp.id, dateInfo.date, settings) && 
                        canAssignDuty(emp, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'weekend',
                            start: settings.weekend.start,
                            end: settings.weekend.end,
                            breakMinutes: settings.weekend.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
                
                // Then fill remaining spots
                sortEmployees();
                for (const emp of employees) {
                    if (assignedCount >= settings.weekend.minStaff) break;
                    if (canAssignDuty(emp, dateInfo.date, settings) && 
                        !hasEmployeePreference(emp.id, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'weekend',
                            start: settings.weekend.start,
                            end: settings.weekend.end,
                            breakMinutes: settings.weekend.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
            }
            
            // 3. Weekday duty (n√∂bet)
            if (settings.weekdayDuty.apply && !dateInfo.isWeekend && !dateInfo.isHoliday) {
                sortEmployees();
                let assignedCount = 0;
                
                // First preferences
                for (const emp of employees) {
                    if (assignedCount >= settings.weekdayDuty.minStaff) break;
                    if (hasEmployeePreference(emp.id, dateInfo.date, settings) && 
                        canAssignDuty(emp, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'duty',
                            start: settings.weekdayDuty.start,
                            end: settings.weekdayDuty.end,
                            breakMinutes: settings.weekdayDuty.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
                
                // Then others
                sortEmployees();
                for (const emp of employees) {
                    if (assignedCount >= settings.weekdayDuty.minStaff) break;
                    if (canAssignDuty(emp, dateInfo.date, settings) && 
                        !hasEmployeePreference(emp.id, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'duty',
                            start: settings.weekdayDuty.start,
                            end: settings.weekdayDuty.end,
                            breakMinutes: settings.weekdayDuty.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
            }
            
            // 4. Holiday duty
            if (settings.holidayDuty.apply && dateInfo.isHoliday) {
                sortEmployees();
                let assignedCount = 0;
                
                // First preferences
                for (const emp of employees) {
                    if (assignedCount >= settings.holidayDuty.minStaff) break;
                    if (hasEmployeePreference(emp.id, dateInfo.date, settings) && 
                        canAssignDuty(emp, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'holiday-duty',
                            start: settings.holidayDuty.start,
                            end: settings.holidayDuty.end,
                            breakMinutes: settings.holidayDuty.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
                
                // Then others
                sortEmployees();
                for (const emp of employees) {
                    if (assignedCount >= settings.holidayDuty.minStaff) break;
                    if (canAssignDuty(emp, dateInfo.date, settings) && 
                        !hasEmployeePreference(emp.id, dateInfo.date, settings)) {
                        schedule.push({
                            employeeId: emp.id,
                            date: dateInfo.date,
                            type: 'holiday-duty',
                            start: settings.holidayDuty.start,
                            end: settings.holidayDuty.end,
                            breakMinutes: settings.holidayDuty.breakMinutes
                        });
                        emp.dutyCount++;
                        emp.lastDutyDate = dateInfo.date;
                        assignedCount++;
                    }
                }
            }
        }
        
        return schedule;
    }
    
    async function applySchedule(schedule, overwrite) {
        // Group by employee for batch processing
        const byEmployee = {};
        for (const shift of schedule) {
            if (!byEmployee[shift.employeeId]) {
                byEmployee[shift.employeeId] = [];
            }
            byEmployee[shift.employeeId].push(shift);
        }
        
        // Apply shifts via API
        for (const employeeId of Object.keys(byEmployee)) {
            const shifts = byEmployee[employeeId];
            
            for (const shift of shifts) {
                // Check if shift already exists
                const cell = document.querySelector(`.shift-cell[data-employee-id="${employeeId}"][data-date="${shift.date}"]`);
                if (!cell) continue;
                
                const hasExisting = cell.querySelector('.shift-badge');
                if (hasExisting && !overwrite) continue;
                
                // Parse times
                const [startH, startM] = shift.start.split(':').map(Number);
                const [endH, endM] = shift.end.split(':').map(Number);
                
                // Determine if spans next day
                const startMinutes = startH * 60 + startM;
                const endMinutes = endH * 60 + endM;
                const spansNextDay = endMinutes <= startMinutes;
                
                // Calculate hours
                let totalMinutes;
                if (spansNextDay) {
                    totalMinutes = (24 * 60 - startMinutes) + endMinutes;
                } else {
                    totalMinutes = endMinutes - startMinutes;
                }
                const totalHours = (totalMinutes - shift.breakMinutes) / 60;
                
                // Prepare shift data
                const shiftData = {
                    employeeId: parseInt(employeeId),
                    date: shift.date,
                    startTime: shift.start,
                    endTime: shift.end,
                    breakMinutes: shift.breakMinutes,
                    totalHours: totalHours,
                    spansNextDay: spansNextDay,
                    overnightHoursMode: 0,
                    isDayOff: false,
                    notes: ''
                };
                
                // Send to API
                try {
                    const response = await fetch('/api/shifts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(shiftData)
                    });
                    
                    if (!response.ok) {
                        console.error(`Failed to create shift for employee ${employeeId} on ${shift.date}`);
                    }
                } catch (error) {
                    console.error('Shift creation error:', error);
                }
            }
        }
    }
})();
</script>
}
