@using Nobetci.Web.Models
@using Nobetci.Web.Data.Entities
@model List<UserListItem>
@{
    ViewData["Title"] = "KullanÄ±cÄ± YÃ¶netimi";
    var guestLimit = (int)ViewBag.GuestLimit;
    var registeredLimit = (int)ViewBag.RegisteredLimit;
    var premiumLimit = (int)ViewBag.PremiumLimit;
}

<div class="admin-header">
    <h2>
        <span>ğŸ‘¥</span>
        KullanÄ±cÄ± YÃ¶netimi
    </h2>
    <div class="header-actions">
        <span class="badge badge-info" style="font-size: 0.8rem; padding: 8px 14px;">
            Toplam: @ViewBag.TotalItems kullanÄ±cÄ±
        </span>
    </div>
</div>

<!-- Limit Bilgisi -->
<div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
    <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-color: #f87171;">
        <span class="stat-icon">ğŸš«</span>
        <div class="stat-label" style="color: #991b1b;">KayÄ±tsÄ±z KullanÄ±cÄ± Limiti</div>
        <div class="stat-value" style="color: #7f1d1d;">@guestLimit</div>
        <div style="font-size: 0.75rem; color: #b91c1c; margin-top: 8px;">Mesai Takip: âŒ | Puantaj: âŒ</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-color: #60a5fa;">
        <span class="stat-icon">âœ“</span>
        <div class="stat-label" style="color: #1e40af;">KayÄ±tlÄ± KullanÄ±cÄ± Limiti</div>
        <div class="stat-value" style="color: #1e3a8a;">@registeredLimit</div>
        <div style="font-size: 0.75rem; color: #3b82f6; margin-top: 8px;">Mesai Takip: âœ… | Puantaj: âœ…</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24;">
        <span class="stat-icon">â­</span>
        <div class="stat-label" style="color: #92400e;">Premium Limiti</div>
        <div class="stat-value" style="color: #78350f;">@premiumLimit</div>
        <div style="font-size: 0.75rem; color: #d97706; margin-top: 8px;">TÃ¼m Ã–zellikler</div>
    </div>
</div>

<!-- Filtreler -->
<div class="card">
    <form method="get" class="filter-bar">
        <div class="filter-group" style="flex: 1; min-width: 250px;">
            <label>Ara (Email / Ä°sim)</label>
            <input type="text" name="search" value="@ViewBag.Search" placeholder="Email veya isim...">
        </div>
        <button type="submit" class="btn btn-primary">
            <span>ğŸ”</span>
            Filtrele
        </button>
        <a href="/admin/users" class="btn btn-secondary">Temizle</a>
    </form>
</div>

<div class="card" style="padding: 0; overflow: hidden;">
    <!-- Tablo -->
    <div style="overflow-x: auto;">
        <table class="table" style="margin: 0;">
            <thead>
                <tr>
                    <th style="padding-left: 20px;">KullanÄ±cÄ±</th>
                    <th style="text-align: center;">Plan</th>
                    <th style="text-align: center;">Limit</th>
                    <th style="text-align: center;">EriÅŸim</th>
                    <th style="text-align: center;">Personel</th>
                    <th>KayÄ±t Tarihi</th>
                    <th>Son GiriÅŸ</th>
                    <th style="text-align: center; padding-right: 20px;">Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="8">
                            <div class="empty-state" style="padding: 60px 20px;">
                                <div class="icon">ğŸ‘¥</div>
                                <div class="title">KullanÄ±cÄ± bulunamadÄ±</div>
                            </div>
                        </td>
                    </tr>
                }
                @foreach (var user in Model)
                {
                    var effectiveLimit = user.GetEffectiveLimit(registeredLimit, premiumLimit);
                    var isOverLimit = user.EmployeeCount > effectiveLimit;
                    <tr>
                        <td style="padding-left: 20px;">
                            <div style="font-weight: 700; color: var(--text-primary);">@(string.IsNullOrEmpty(user.FullName) ? "â€”" : user.FullName)</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 2px;">@user.Email</div>
                            @if (!string.IsNullOrEmpty(user.AdminNotes))
                            {
                                <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                    <span>ğŸ“</span>
                                    <span class="truncate" style="max-width: 200px;">@user.AdminNotes</span>
                                </div>
                            }
                        </td>
                        <td style="text-align: center;">
                            @if (user.Plan == UserPlan.Premium)
                            {
                                <span class="badge badge-warning">â­ Premium</span>
                            }
                            else
                            {
                                <span class="badge badge-info">Free</span>
                            }
                        </td>
                        <td style="text-align: center;">
                            @if (user.CustomEmployeeLimit.HasValue)
                            {
                                <span class="badge badge-purple" title="Ã–zel limit">@user.CustomEmployeeLimit</span>
                            }
                            else
                            {
                                <span style="color: var(--text-secondary); font-weight: 500;">@effectiveLimit</span>
                            }
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                                <span style="font-size: 0.75rem; display: flex; align-items: center; gap: 4px; color: @(user.CanAccessAttendance ? "#10b981" : "#ef4444")">
                                    @(user.CanAccessAttendance ? "âœ…" : "âŒ") Mesai
                                </span>
                                <span style="font-size: 0.75rem; display: flex; align-items: center; gap: 4px; color: @(user.CanAccessPayroll ? "#10b981" : "#ef4444")">
                                    @(user.CanAccessPayroll ? "âœ…" : "âŒ") Puantaj
                                </span>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span class="@(isOverLimit ? "badge badge-danger" : "")" style="@(!isOverLimit ? "font-weight: 600; font-size: 0.95rem;" : "")">
                                    @user.EmployeeCount / @effectiveLimit
                                </span>
                                @if (user.OrganizationCount > 0)
                                {
                                    <span style="font-size: 0.7rem; color: var(--text-muted);">@user.OrganizationCount org.</span>
                                }
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 500; font-size: 0.85rem;">@user.CreatedAt.ToString("dd.MM.yyyy")</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">@user.CreatedAt.ToString("HH:mm")</div>
                        </td>
                        <td>
                            @if (user.LastLoginAt.HasValue)
                            {
                                <div style="font-weight: 500; font-size: 0.85rem;">@user.LastLoginAt.Value.ToString("dd.MM.yyyy")</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">@user.LastLoginAt.Value.ToString("HH:mm")</div>
                            }
                            else
                            {
                                <span style="color: var(--text-muted); font-size: 0.85rem;">â€”</span>
                            }
                        </td>
                        <td style="text-align: center; padding-right: 20px;">
                            <a href="/admin/users/edit/@user.Id" class="btn btn-sm btn-primary">
                                <span>âœï¸</span>
                                DÃ¼zenle
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Sayfalama -->
    @if ((int)ViewBag.TotalPages > 1)
    {
        <div style="padding: 20px; border-top: 1px solid var(--border-color);">
            <div class="pagination">
                @for (int i = 1; i <= (int)ViewBag.TotalPages; i++)
                {
                    var searchParam = !string.IsNullOrEmpty((string)ViewBag.Search) ? $"&search={ViewBag.Search}" : "";
                    <a href="/admin/users?page=@i@searchParam" class="page-link @(i == (int)ViewBag.CurrentPage ? "active" : "")">@i</a>
                }
            </div>
        </div>
    }
</div>
